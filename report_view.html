<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Report View | Stark Premium ERP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=2">

    <style>
        /* Shared Premium Dark Theme */
        :root {
            --primary: #6366f1;
            --bg-body: #0f172a;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
        }

        body {
            background-image: radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%) !important;
            background-color: var(--bg-body) !important;
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        /* Topbar Override */
        .topbar {
            background: rgba(15, 23, 42, 0.8) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
        }

        .nav-link {
            color: #94a3b8 !important;
        }

        .nav-link.active {
            color: white !important;
        }

        .logo-text {
            color: white !important;
        }

        /* Controls */
        .input {
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white !important;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05) !important;
            color: white !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        /* Chart Container */
        .chart-box {
            height: 300px;
            width: 100%;
            position: relative;
            margin-bottom: 24px;
            padding: 16px;
        }

        /* Table */
        th {
            color: #94a3b8 !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            background: transparent !important;
        }

        td {
            color: #e2e8f0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05) !important;
        }
    </style>
</head>

<body>
    <!-- Top Navigation -->
    <header class="topbar">
        <div class="topbar-inner">
            <a href="dashboard.html" class="logo">
                <img src="images/stark-logo.png" alt="Stark Premium">
                <span class="logo-text">Stark ERP</span>
            </a>
            <nav class="nav">
                <a class="nav-link" href="reports.html">← Back to Reports</a>
            </nav>
            <div style="display:flex; align-items:center; gap:12px;">
                <button class="btn btn-secondary" onclick="exportData()"
                    style="height:36px; padding:0 16px; font-size:13px;">
                    Export CSV
                </button>
            </div>
        </div>
    </header>

    <main class="container" style="padding-top:40px;">

        <!-- Dynamic Header -->
        <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:32px;">
            <div>
                <h1 class="page-title" id="reportTitle"
                    style="color:white; font-size:32px; font-weight:800; margin-bottom:8px;">Report Loading...</h1>
                <p style="color:#94a3b8;" id="reportDesc">Please wait while we generate your data.</p>
            </div>
            <div style="display:flex; gap:12px;">
                <input type="date" class="input" style="width:auto;" id="dateStart">
                <input type="date" class="input" style="width:auto;" id="dateEnd">
                <button class="btn btn-primary" onclick="renderReport()"
                    style="background:linear-gradient(135deg, #6366f1, #4f46e5); border:none;">Refresh</button>
            </div>
        </div>

        <!-- KPI Row -->
        <div class="grid grid-4" style="margin-bottom:32px;" id="kpiRow">
            <!-- Injected via JS -->
        </div>

        <!-- Main Content -->
        <div class="glass-panel" style="padding:24px;">
            <!-- Chart -->
            <div class="chart-box" id="chartContainer">
                <canvas id="mainChart"></canvas>
            </div>

            <!-- Data Grid -->
            <h3 style="color:white; font-size:16px; margin-bottom:16px; display:flex; justify-content:space-between;">
                <span>Detailed Records</span>
                <input placeholder="Search records..." class="input" style="width:200px; height:32px; font-size:12px;"
                    oninput="filterTable(this.value)">
            </h3>
            <div class="table-container" style="max-height:500px; overflow-y:auto;">
                <table id="reportTable" style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr id="tableHead"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

    </main>

    <div id="toastWrap" style="position:fixed; bottom:20px; right:20px; z-index:9999; display:grid; gap:10px;"></div>

    <!-- Chart.js (Simulated or Lightweight) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Note: If CDN fails (offline), we should implement a fallback, but for now assuming access or using simulated blocks -->

    <script src="erp.js"></script>
    <script>
        // --- Report Engine Configuration ---
        const REPORTS = {
            'brand_sales': {
                title: "Brand Sales by SKU",
                desc: "Revenue breakdown by Brand and individual SKU performance.",
                cols: ["Brand", "SKU", "Item Name", "Units Sold", "Revenue", "Margin"],
                type: "bar",
                kpis: ["Total Revenue", "Units Sold", "Avg Margin"],
                color: "#6366f1"
            },
            'cust_sales_brand': {
                title: "Customer Sales by Brand",
                desc: "Analysis of brand penetration within customer accounts.",
                cols: ["Customer", "Brand", "Orders", "Units", "Total Sales", "Last Order"],
                type: "line",
                kpis: ["Active Customers", "Top Brand", "Total Sales"],
                color: "#10b981"
            },
            'inventory_date': {
                title: "Inventory Snapshot",
                desc: "Stock levels and valuation as of a specific date.",
                cols: ["SKU", "Location", "On Hand", "Allocated", "Available", "Unit Cost", "Total Value"],
                type: "bar",
                kpis: ["Total Items", "Total Value", "Low Stock items"],
                color: "#f59e0b"
            },
            'profitability': {
                title: "Profitability Report",
                desc: "Net profit analysis by item and category.",
                cols: ["Item", "Category", "Cost of Goods", "Revenue", "Net Profit", "Margin %"],
                type: "line",
                kpis: ["Gross Profit", "Avg Margin", "Best Seller"],
                color: "#ddd6fe" // Purple
            },
            'default': {
                title: "General Report",
                desc: "Standard metric analysis.",
                cols: ["Date", "Reference", "Description", "Qty", "Amount", "Status"],
                type: "bar",
                kpis: ["Total Count", "Total Amount", "Avg Value"],
                color: "#64748b"
            }
        };

        // --- Engine Logic ---
        const urlParams = new URLSearchParams(window.location.search);
        const reportId = urlParams.get('id') || 'default';
        const config = REPORTS[reportId] || REPORTS['default'];
        let chartInstance = null;

        function init() {
            // Set Titles
            document.getElementById("reportTitle").textContent = config.title;
            document.getElementById("reportDesc").textContent = config.desc;
            document.title = `${config.title} | Stark ERP`;

            // Chart Controls
            const chartBox = document.getElementById("chartContainer");
            const controls = document.createElement("div");
            controls.style.cssText = "position:absolute; top:16px; right:16px; display:flex; gap:8px;";
            controls.innerHTML = `
                <button class="btn btn-xs" style="font-size:10px; padding:4px 8px; background:rgba(255,255,255,0.1); border:none; color:white; border-radius:4px; cursor:pointer;" onclick="updateChartType('bar')">Bar</button>
                <button class="btn btn-xs" style="font-size:10px; padding:4px 8px; background:rgba(255,255,255,0.1); border:none; color:white; border-radius:4px; cursor:pointer;" onclick="updateChartType('line')">Line</button>
            `;
            chartBox.appendChild(controls);

            // Set Date Defaults
            const now = new Date();
            document.getElementById("dateEnd").valueAsDate = now;
            const prev = new Date(); prev.setMonth(prev.getMonth() - 1);
            document.getElementById("dateStart").valueAsDate = prev;

            renderReport();
        }

        function updateChartType(type) {
            config.type = type;
            renderReport();
        }

        function renderReport() {
            // 1. Generate KPIs with Trends
            const kpiHtml = config.kpis.map(k => {
                const val = simulateValue(k);
                // Simulate Trend
                const change = (Math.random() * 20 - 5).toFixed(1); // -5% to +15%
                const isPos = change > 0;
                const color = isPos ? "#10b981" : "#ef4444";
                const arrow = isPos ? "▲" : "▼";

                return `
            <div class="card" style="padding:16px; background:rgba(255,255,255,0.05) !important;">
                <div style="font-size:11px; color:#94a3b8; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:4px;">${k}</div>
                <div style="font-size:24px; font-weight:700; color:white; margin-bottom:4px;">${val}</div>
                <div style="font-size:12px; color:${color}; font-weight:500;">
                    ${arrow} ${Math.abs(change)}% <span style="color:#64748b; font-weight:400;">vs last period</span>
                </div>
            </div>`;
            }).join("");
            document.getElementById("kpiRow").innerHTML = kpiHtml;

            // 2. Build Table Headers
            const thead = document.getElementById("tableHead");
            thead.innerHTML = config.cols.map(c => `<th style="text-align:left; padding:12px;">${c}</th>`).join("");

            // 3. Generate Mock Data Rows
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";
            const rowCount = 25;
            const chartLabels = [];
            const chartData = [];
            window.currentData = []; // Store for export

            for (let i = 0; i < rowCount; i++) {
                const tr = document.createElement("tr");
                tr.className = "table-row-anim";
                tr.style.animationDelay = (i * 20) + "ms";

                let rowObj = {};
                let inner = "";
                config.cols.forEach((col, idx) => {
                    const text = generateCellData(col, i);
                    inner += `<td style="padding:12px;">${text}</td>`;
                    rowObj[col] = text;

                    // Collect Chart Data (Label = Col 0, Value = Col 4 or last numeric)
                    if (idx === 0) chartLabels.push(text);
                    if (idx === 4) chartData.push(parseFloat(text.replace(/[^0-9.-]+/g, "")) || 0); // heuristic
                });
                window.currentData.push(rowObj);

                tr.innerHTML = inner;
                tbody.appendChild(tr);
            }

            // 4. Render Chart
            renderChart(chartLabels.slice(0, 10), chartData.slice(0, 10)); // Top 10
        }

        function generateCellData(colName, seed) {
            const c = colName.toLowerCase();
            if (c.includes("date")) return new Date(2026, 0, seed + 1).toLocaleDateString();
            if (c.includes("revenue") || c.includes("amount") || c.includes("sales") || c.includes("cost") || c.includes("value") || c.includes("profit")) return "$" + ((seed * 153.21) + 100).toFixed(2);
            if (c.includes("margin") || c.includes("%")) return ((seed * 2) % 40 + 10) + "%";
            if (c.includes("units") || c.includes("qty") || c.includes("hand") || c.includes("orders")) return Math.floor(Math.random() * 500) + 1;
            if (c.includes("sku")) return "SKU-" + (1000 + seed);
            if (c.includes("brand")) return ["Nike", "Adidas", "Stark", "Puma", "Reebok"][seed % 5];
            if (c.includes("customer")) return ["Alpha Corp", "Beta LLC", "Gamma Inc", "Delta Co", "Omega"][seed % 5];
            if (c.includes("status")) return ["Active", "Pending", "Closed"][seed % 3];
            return "Item " + seed;
        }

        function simulateValue(kpiName) {
            if (kpiName.includes("Revenue") || kpiName.includes("Value") || kpiName.includes("Sales") || kpiName.includes("Profit")) return "$" + (Math.random() * 50000 + 10000).toLocaleString(undefined, { maximumFractionDigits: 0 });
            if (kpiName.includes("Margin")) return "32.5%";
            if (kpiName.includes("Items") || kpiName.includes("Units")) return Math.floor(Math.random() * 2000);
            return "84";
        }

        function renderChart(labels, data) {
            if (chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('mainChart').getContext('2d');

            // Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, hexToRgba(config.color, 0.5));
            gradient.addColorStop(1, hexToRgba(config.color, 0.0));

            chartInstance = new Chart(ctx, {
                type: config.type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: config.kpis[0] || 'Value',
                        data: data,
                        backgroundColor: gradient,
                        borderColor: config.color,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } },
                        y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });
        }

        // Helper: Hex to RGBA
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16),
                g = parseInt(hex.slice(3, 5), 16),
                b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function filterTable(query) {
            const term = query.toLowerCase();
            const rows = document.querySelectorAll("#tableBody tr");
            rows.forEach(r => {
                r.style.display = r.textContent.toLowerCase().includes(term) ? "" : "none";
            });
        }

        function exportData() {
            if (!window.currentData || !window.currentData.length) {
                toast("Export Failed", "No data to export.", "error");
                return;
            }

            // Convert to CSV
            const headers = config.cols.join(",");
            const rows = window.currentData.map(obj => config.cols.map(c => `"${obj[c]}"`).join(","));
            const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].join("\n");

            // Download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${config.title.replace(/ /g, "_")}_Report.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            toast("Export Complete", `Downloaded ${config.title} as CSV.`);
        }

        // Start
        init();
    </script>
</body>

</html>
