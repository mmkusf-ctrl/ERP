<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Report View | Stark Premium ERP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=2">

    <style>
        /* View Specifics */
        .glass-panel {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--card-shadow);
        }

        /* Chart Container */
        .chart-box {
            height: 350px;
            width: 100%;
            position: relative;
            margin-bottom: 24px;
            padding: 16px;
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        /* Table Overrides */
        #reportTable th {
            text-align: left;
            padding: 16px;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--border);
            background: #f8fafc;
        }

        #reportTable td {
            padding: 14px 16px;
            color: var(--text-main);
            font-size: 13px;
            border-bottom: 1px solid #f1f5f9;
            background: white;
        }

        #reportTable tr:hover td {
            background: #f8fafc;
        }
    </style>
</head>

<body><main class="container" style="padding-top:40px;">

        <!-- Dynamic Header -->
        <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:32px;">
            <div>
                <h1 class="page-title" id="reportTitle"
                    style="font-size:32px; font-weight:800; margin-bottom:8px; color:var(--text-main);">Report
                    Loading...</h1>
                <p style="color:var(--text-muted);" id="reportDesc">Please wait while we generate your data.</p>
            </div>
            <div style="display:flex; gap:12px;">
                <input type="date" class="input" style="width:auto;" id="dateStart">
                <input type="date" class="input" style="width:auto;" id="dateEnd">
                <button class="btn btn-primary" onclick="renderReport()"
                    style="background:linear-gradient(135deg, #6366f1, #4f46e5); border:none;">Refresh</button>
            </div>
        </div>

        <!-- KPI Row -->
        <div class="grid grid-4" style="margin-bottom:32px;" id="kpiRow">
            <!-- Injected via JS -->
        </div>

        <!-- Main Content -->
        <div class="glass-panel" style="padding:24px;">
            <!-- Chart -->
            <div class="chart-box" id="chartContainer">
                <canvas id="mainChart"></canvas>
            </div>

            <!-- Data Grid -->
            <h3
                style="color:var(--text-main); font-size:18px; font-weight:700; margin-bottom:16px; display:flex; justify-content:space-between; align-items:center;">
                <span>Detailed Records</span>
                <input placeholder="Search query..." class="input"
                    style="width:240px; height:36px; font-size:13px; background:white; border:1px solid var(--border); color:var(--text-main);"
                    oninput="filterTable(this.value)">
            </h3>
            <div class="table-container" style="max-height:500px; overflow-y:auto;">
                <table id="reportTable" style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr id="tableHead"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

    </main>

    <div id="toastWrap" style="position:fixed; bottom:20px; right:20px; z-index:9999; display:grid; gap:10px;"></div>

    <!-- Chart.js (Simulated or Lightweight) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Note: If CDN fails (offline), we should implement a fallback, but for now assuming access or using simulated blocks -->

    <script src="erp.js"></script>
    <script>
        // --- Report Engine Configuration ---
        const REPORTS = {
            'brand_sales': {
                title: "Brand Sales by SKU",
                desc: "Revenue breakdown by Brand and individual SKU performance.",
                cols: ["Brand", "SKU", "Item Name", "Units Sold", "Revenue", "Margin"],
                type: "bar",
                kpis: ["Total Revenue", "Units Sold", "Avg Margin"],
                color: "#6366f1"
            },
            'cust_sales_brand': {
                title: "Customer Sales by Brand",
                desc: "Analysis of brand penetration within customer accounts.",
                cols: ["Customer", "Brand", "Orders", "Units", "Total Sales", "Last Order"],
                type: "line",
                kpis: ["Active Customers", "Top Brand", "Total Sales"],
                color: "#10b981"
            },
            'inventory_date': {
                title: "Inventory Snapshot",
                desc: "Stock levels and valuation as of a specific date.",
                cols: ["SKU", "Location", "On Hand", "Allocated", "Available", "Unit Cost", "Total Value"],
                type: "bar",
                kpis: ["Total Items", "Total Value", "Low Stock items"],
                color: "#f59e0b"
            },
            'profitability': {
                title: "Profitability Report",
                desc: "Net profit analysis by item and category.",
                cols: ["Item", "Category", "Cost of Goods", "Revenue", "Net Profit", "Margin %"],
                type: "line",
                kpis: ["Gross Profit", "Avg Margin", "Best Seller"],
                color: "#ddd6fe" // Purple
            },
            'default': {
                title: "General Report",
                desc: "Standard metric analysis.",
                cols: ["Date", "Reference", "Description", "Qty", "Amount", "Status"],
                type: "bar",
                kpis: ["Total Count", "Total Amount", "Avg Value"],
                color: "#64748b"
            }
        };

        // --- Engine Logic ---
        const urlParams = new URLSearchParams(window.location.search);
        const reportId = urlParams.get('id') || 'default';

        // Auto-Generate Title from ID if not found in REPORTS
        let config = REPORTS[reportId];

        if (!config) {
            // Fallback Generator
            const titleStr = reportId.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            config = {
                title: titleStr,
                desc: `Detailed analysis for ${titleStr}.`,
                cols: ["Date", "Reference", "Description", "Value", "Status", "Allocated"],
                type: "bar",
                kpis: ["Total Count", "Total Value", "Avg Metric"],
                color: "#6366f1"
            };
        }

        let chartInstance = null;

        function init() {
            // Set Titles
            document.getElementById("reportTitle").textContent = config.title;
            document.getElementById("reportDesc").textContent = config.desc;
            document.title = `${config.title} | Stark ERP`;

            // Chart Controls
            const chartBox = document.getElementById("chartContainer");
            const controls = document.createElement("div");
            controls.style.cssText = "position:absolute; top:16px; right:16px; display:flex; gap:8px;";
            controls.innerHTML = `
                <button class="btn btn-secondary" style="font-size:11px; padding:4px 10px; height:28px;" onclick="updateChartType('bar')">Bar</button>
                <button class="btn btn-secondary" style="font-size:11px; padding:4px 10px; height:28px;" onclick="updateChartType('line')">Line</button>
            `;
            chartBox.appendChild(controls);

            // Set Date Defaults
            const now = new Date();
            document.getElementById("dateEnd").valueAsDate = now;
            const prev = new Date(); prev.setMonth(prev.getMonth() - 1);
            document.getElementById("dateStart").valueAsDate = prev;

            renderReport();
        }

        function updateChartType(type) {
            config.type = type;
            renderReport();
        }

        function renderReport() {
            // 1. Generate KPIs with Trends
            const kpiHtml = config.kpis.map(k => {
                const val = simulateValue(k);
                // Simulate Trend
                const change = (Math.random() * 20 - 5).toFixed(1); // -5% to +15%
                const isPos = change > 0;
                const color = isPos ? "#10b981" : "#ef4444";
                const arrow = isPos ? "▲" : "▼";

                return `
            <div class="card" style="padding:20px; background:white; border:1px solid var(--border); box-shadow:var(--card-shadow); border-radius:12px;">
                <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">${k}</div>
                <div style="font-size:28px; font-weight:800; color:var(--text-main); margin-bottom:4px;">${val}</div>
                <div style="font-size:12px; color:${color}; font-weight:600;">
                    ${arrow} ${Math.abs(change)}% <span style="color:var(--text-muted); font-weight:400;">vs last period</span>
                </div>
            </div>`;
            }).join("");
            document.getElementById("kpiRow").innerHTML = kpiHtml;

            // 2. Build Table Headers
            const thead = document.getElementById("tableHead");
            thead.innerHTML = config.cols.map(c => `<th style="text-align:left; padding:12px;">${c}</th>`).join("");

            // 3. Generate Mock Data Rows
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";
            const rowCount = 25;
            const chartLabels = [];
            const chartData = [];
            window.currentData = []; // Store for export

            for (let i = 0; i < rowCount; i++) {
                const tr = document.createElement("tr");
                tr.className = "table-row-anim";
                tr.style.animationDelay = (i * 20) + "ms";

                let rowObj = {};
                let inner = "";
                config.cols.forEach((col, idx) => {
                    const text = generateCellData(col, i);
                    inner += `<td style="padding:12px;">${text}</td>`;
                    rowObj[col] = text;

                    // Collect Chart Data (Label = Col 0, Value = Col 4 or last numeric)
                    if (idx === 0) chartLabels.push(text);
                    if (idx === 4) chartData.push(parseFloat(text.replace(/[^0-9.-]+/g, "")) || 0); // heuristic
                });
                window.currentData.push(rowObj);

                tr.innerHTML = inner;
                tbody.appendChild(tr);
            }

            // 4. Render Chart
            renderChart(chartLabels.slice(0, 10), chartData.slice(0, 10)); // Top 10
        }

        function generateCellData(colName, seed) {
            const c = colName.toLowerCase();
            if (c.includes("date")) return new Date(2026, 0, seed + 1).toLocaleDateString();
            if (c.includes("revenue") || c.includes("amount") || c.includes("sales") || c.includes("cost") || c.includes("value") || c.includes("profit")) return "$" + ((seed * 153.21) + 100).toFixed(2);
            if (c.includes("margin") || c.includes("%")) return ((seed * 2) % 40 + 10) + "%";
            if (c.includes("units") || c.includes("qty") || c.includes("hand") || c.includes("orders")) return Math.floor(Math.random() * 500) + 1;
            if (c.includes("sku")) return "SKU-" + (1000 + seed);
            if (c.includes("brand")) return ["Nike", "Adidas", "Stark", "Puma", "Reebok"][seed % 5];
            if (c.includes("customer")) return ["Alpha Corp", "Beta LLC", "Gamma Inc", "Delta Co", "Omega"][seed % 5];
            if (c.includes("status")) return ["Active", "Pending", "Closed"][seed % 3];
            return "Item " + seed;
        }

        function simulateValue(kpiName) {
            if (kpiName.includes("Revenue") || kpiName.includes("Value") || kpiName.includes("Sales") || kpiName.includes("Profit")) return "$" + (Math.random() * 50000 + 10000).toLocaleString(undefined, { maximumFractionDigits: 0 });
            if (kpiName.includes("Margin")) return "32.5%";
            if (kpiName.includes("Items") || kpiName.includes("Units")) return Math.floor(Math.random() * 2000);
            return "84";
        }

        function renderChart(labels, data) {
            if (chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('mainChart').getContext('2d');

            // Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, hexToRgba(config.color, 0.5));
            gradient.addColorStop(1, hexToRgba(config.color, 0.0));

            chartInstance = new Chart(ctx, {
                type: config.type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: config.kpis[0] || 'Value',
                        data: data,
                        backgroundColor: gradient,
                        borderColor: config.color,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } },
                        y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });
        }

        // Helper: Hex to RGBA
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16),
                g = parseInt(hex.slice(3, 5), 16),
                b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function filterTable(query) {
            const term = query.toLowerCase();
            const rows = document.querySelectorAll("#tableBody tr");
            rows.forEach(r => {
                r.style.display = r.textContent.toLowerCase().includes(term) ? "" : "none";
            });
        }

        function exportData() {
            if (!window.currentData || !window.currentData.length) {
                toast("Export Failed", "No data to export.", "error");
                return;
            }

            // Convert to CSV
            const headers = config.cols.join(",");
            const rows = window.currentData.map(obj => config.cols.map(c => `"${obj[c]}"`).join(","));
            const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].join("\n");

            // Download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${config.title.replace(/ /g, "_")}_Report.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            toast("Export Complete", `Downloaded ${config.title} as CSV.`);
        }

        // Start
        init();
    </script>
</body>

</html>
