<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Create Sales Order | Stark Premium ERP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=8">
    <style>
        .form-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group-text {
            font-size: 12px;
            color: #64748b;
            font-weight: 700;
            text-transform: uppercase;
            display: block;
            margin-bottom: 6px;
        }

        /* Autocomplete Styles */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            max-height: 240px;
            overflow-y: auto;
            z-index: 50;
            display: none;
            margin-top: 4px;
        }

        .autocomplete-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .autocomplete-item:hover {
            background: #f8fafc;
        }

        .autocomplete-item strong {
            font-weight: 600;
            color: #0f172a;
        }

        .autocomplete-item span {
            color: #64748b;
            font-size: 13px;
        }
    </style>
</head>

<body>



    <main class="container soft-ui-wrapper" style="padding-top:40px; max-width:1200px;">

        <!-- Header -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <div>
                <button onclick="window.history.back()"
                    style="background:transparent; border:none; color:#64748b; font-weight:600; cursor:pointer; margin-bottom:8px;">←
                    Back to Orders</button>
                <h1 class="page-title" style="margin:0;">New Sales Order</h1>
            </div>
            <div style="display:flex; gap:12px;">
                <button class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
                <button class="btn btn-primary" onclick="submitOrder()"
                    style="background:#6366f1; border:none; box-shadow:0 4px 12px rgba(99, 102, 241, 0.3); padding:0 32px;">Submit
                    Order</button>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 3fr 1fr; gap:32px; align-items:start;">

            <!-- Left Col: Content -->
            <div style="display:grid; gap:24px;">

                <!-- Order Basics -->
                <div class="card-soft" style="padding:24px;">
                    <div class="section-title">Customer Details</div>
                    <div class="grid-2" style="gap:24px;">
                        <div>
                            <label class="input-group-text">Customer Name</label>
                            <input id="iCust" class="input" placeholder="e.g. Acme Corp">
                        </div>
                        <div>
                            <label class="input-group-text">Customer PO #</label>
                            <input id="iPO" class="input" placeholder="e.g. PO-998877">
                        </div>
                    </div>
                </div>

                <!-- Line Items -->
                <div class="card-soft" style="padding:24px; min-height:400px;">
                    <div class="section-title">Line Items</div>

                    <!-- Search Bar area -->
                    <div
                        style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:20px; margin-bottom:24px;">
                        <div class="grid-4"
                            style="gap:16px; grid-template-columns: 3fr 1fr 2fr 100px; align-items:end;">

                            <div class="autocomplete-wrapper">
                                <label class="input-group-text">SKU Lookup</label>
                                <input id="iSkuSearch" class="input" placeholder="Search by SKU or Name..."
                                    oninput="filterSkus(this.value)" onfocus="filterSkus(this.value)"
                                    style="border-color:#cbd5e1;">
                                <div id="skuList" class="autocomplete-list"></div>
                            </div>

                            <div>
                                <label class="input-group-text">Qty</label>
                                <input id="iQty" type="number" class="input" value="1" min="1"
                                    style="text-align:center;">
                            </div>

                            <div>
                                <label class="input-group-text">Notes / Customization</label>
                                <input id="iLineNote" class="input" placeholder="Optional notes...">
                            </div>

                            <button class="btn btn-primary" onclick="addLine()"
                                style="height:44px; justify-content:center;">Add</button>
                        </div>

                        <!-- Active Selection Preview -->
                        <div id="skuInfo"
                            style="margin-top:16px; padding-top:16px; border-top:1px dashed #cbd5e1; display:none;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <div style="font-size:15px; font-weight:700; color:#1e293b;"><span
                                            id="infoSku"></span> — <span id="infoName" style="font-weight:400;"></span>
                                    </div>
                                    <div style="font-size:12px; color:#64748b; margin-top:4px;">Retail: <strong
                                            id="infoPrice"></strong></div>
                                </div>
                                <div style="text-align:right;">
                                    <div
                                        style="font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase;">
                                        Inventory Status</div>
                                    <div style="display:flex; gap:12px; margin-top:4px;">
                                        <div class="badge badge-green" id="badgeOH">OH: <span id="infoOH"></span></div>
                                        <div id="infoPO"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <table style="width:100%; text-align:left; border-collapse:separate; border-spacing:0;">
                        <thead style="background:#f8fafc;">
                            <tr>
                                <th
                                    style="padding:12px 16px; border-top-left-radius:8px; border-bottom:1px solid #e2e8f0; font-size:12px; color:#64748b; font-weight:700;">
                                    SKU</th>
                                <th
                                    style="padding:12px 16px; border-bottom:1px solid #e2e8f0; font-size:12px; color:#64748b; font-weight:700;">
                                    Description</th>
                                <th
                                    style="padding:12px 16px; border-bottom:1px solid #e2e8f0; font-size:12px; color:#64748b; font-weight:700; text-align:right;">
                                    Price</th>
                                <th
                                    style="padding:12px 16px; border-bottom:1px solid #e2e8f0; font-size:12px; color:#64748b; font-weight:700; text-align:right;">
                                    Qty</th>
                                <th
                                    style="padding:12px 16px; border-bottom:1px solid #e2e8f0; font-size:12px; color:#64748b; font-weight:700; text-align:right;">
                                    Line Total</th>
                                <th
                                    style="padding:12px 16px; border-top-right-radius:8px; border-bottom:1px solid #e2e8f0;">
                                </th>
                            </tr>
                        </thead>
                        <tbody id="lineBody">
                            <tr>
                                <td colspan="6" style="text-align:center; padding:40px; color:#94a3b8; font-size:14px;">
                                    Your cart is empty. Add items above.</td>
                            </tr>
                        </tbody>
                        <tfoot id="tableFoot" style="display:none;">
                            <tr>
                                <td colspan="4" style="text-align:right; padding:16px; font-weight:700; color:#64748b;">
                                    TOTAL</td>
                                <td style="text-align:right; padding:16px; font-weight:800; font-size:16px; color:#0f172a;"
                                    id="orderTotal">$0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>

                </div>

            </div>

            <!-- Right Col: Sidebar -->
            <div style="display:grid; gap:24px; align-content:start;">

                <div class="card-soft" style="padding:24px;">
                    <div class="section-title">Shipping & Logistics</div>

                    <div style="margin-bottom:16px;">
                        <label class="input-group-text">Warehouse</label>
                        <select id="iWh" class="input">
                            <option value="Sarasota">Sarasota, FL (Main)</option>
                            <option value="Texas">Austin, TX (West)</option>
                        </select>
                    </div>

                    <div style="margin-bottom:16px;">
                        <label class="input-group-text">Need By Date</label>
                        <input id="iDate" type="date" class="input">
                    </div>

                    <hr style="border:none; border-top:1px solid #f1f5f9; margin:20px 0;">

                    <div style="margin-bottom:16px;">
                        <label class="input-group-text">Shipping Carrier</label>
                        <select id="iShip" class="input" style="font-weight:600;">
                            <optgroup label="UPS">
                                <option>UPS Ground</option>
                                <option>UPS 3 Day Select</option>
                                <option>UPS 2nd Day Air</option>
                                <option>UPS Next Day Air</option>
                            </optgroup>
                            <optgroup label="FedEx">
                                <option>FedEx Ground</option>
                                <option>FedEx Express Saver</option>
                                <option>FedEx 2Day</option>
                                <option>FedEx Standard Overnight</option>
                                <option>FedEx Priority Overnight</option>
                            </optgroup>
                        </select>
                    </div>

                    <div style="margin-bottom:16px;">
                        <label class="input-group-text">Account # (Optional)</label>
                        <input id="iAcct" class="input" placeholder="Use 3rd party acct...">
                    </div>

                    <div
                        style="margin-top:20px; padding-top:20px; border-top:1px solid #e2e8f0; display:flex; align-items:center; gap:12px;">
                        <input type="checkbox" id="isEvent" style="width:16px; height:16px;">
                        <label for="isEvent" style="font-size:13px; font-weight:600; color:#1e293b;">Is this an
                            Event?</label>
                        <div class="badge badge-purple" style="font-size:10px;">Auto-Create Event</div>
                    </div>
                </div>

                <div class="card-soft" style="padding:24px;">
                    <div class="section-title">Order Notes</div>
                    <textarea id="iOrderNote" class="input" rows="4"
                        placeholder="Special instructions for the warehouse team..."></textarea>
                </div>

            </div>

        </div>

    </main>

    <div id="toastWrap" style="position:fixed; bottom:20px; right:20px; z-index:9999; display:grid; gap:10px;"></div>

    <script src="erp.js"></script>
    <script>
        const ITEM_KEY = "stark_erp_items_v2";
        const ORDER_KEY = "stark_erp_orders_v1";

        let allItems = [];
        let orderLines = [];
        let selectedItem = null;

        // Init
        const PARAMS = new URLSearchParams(window.location.search);
        const EDIT_ID = PARAMS.get("id");

        (function init() {
            try { allItems = JSON.parse(localStorage.getItem(ITEM_KEY) || "[]"); } catch { allItems = []; }

            // Close autocomplete when clicking outside
            document.addEventListener("click", function (e) {
                if (!e.target.closest(".autocomplete-wrapper")) {
                    document.getElementById("skuList").style.display = "none";
                }
            });

            // Check for edit mode
            if (EDIT_ID) {
                document.querySelector(".page-title").textContent = "Edit Sales Order " + EDIT_ID;
                document.querySelector(".btn-primary").textContent = "Update Order";
                loadOrder(EDIT_ID);
            }
        })();

        function loadOrder(id) {
            const orders = JSON.parse(localStorage.getItem(ORDER_KEY) || "[]");
            const order = orders.find(o => o.id === id);

            if (!order) {
                toast("Error", "Order not found", "error");
                return;
            }

            document.getElementById("iCust").value = order.cust || "";
            document.getElementById("iPO").value = order.po || "";
            document.getElementById("iWh").value = order.wh || "Sarasota";
            document.getElementById("iDate").value = order.inHands || "";
            document.getElementById("iShip").value = order.ship || "";
            document.getElementById("iAcct").value = order.acct || "";
            document.getElementById("iOrderNote").value = order.note || "";

            orderLines = order.lines || [];
            renderLines();
        }

        // SKU Filter
        function filterSkus(val) {
            const listEl = document.getElementById("skuList");
            if (!val) {
                listEl.style.display = "none";
                return;
            }

            const matches = allItems.filter(i =>
                i.sku.toLowerCase().includes(val.toLowerCase()) ||
                (i.name && i.name.toLowerCase().includes(val.toLowerCase()))
            ).slice(0, 8);

            if (matches.length === 0) {
                listEl.style.display = "none";
                return;
            }

            listEl.innerHTML = matches.map(i => `
                <div class="autocomplete-item" onclick="selectSku('${i.sku}')">
                    <div>
                        <strong>${i.sku}</strong>
                        <div style="font-size:12px; color:#64748b;">${i.name || i.desc || ''}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:600; font-size:12px;">${i.on} OH</div>
                    </div>
                </div>
            `).join("");
            listEl.style.display = "block";
        }

        function selectSku(sku) {
            selectedItem = allItems.find(i => i.sku === sku);
            if (!selectedItem) return;

            // Fill & Show Info
            document.getElementById("iSkuSearch").value = selectedItem.sku;
            document.getElementById("skuList").style.display = "none";

            document.getElementById("infoSku").textContent = selectedItem.sku;
            document.getElementById("infoName").textContent = selectedItem.name || selectedItem.desc || "(No Name)";
            document.getElementById("infoPrice").textContent = window.formatMoney(selectedItem.retail || 0);

            document.getElementById("infoOH").textContent = selectedItem.on;

            // Sim Open PO check
            const hasPo = (selectedItem.starkEta || "").length > 0;
            const poHtml = hasPo ? `<div class="badge badge-green">Inbound: ${selectedItem.starkEta}</div>` : ``;
            document.getElementById("infoPO").innerHTML = poHtml;

            document.getElementById("skuInfo").style.display = "block";
            document.getElementById("iQty").focus();
        }

        function addLine() {
            if (!selectedItem) return toast("Error", "Please select a valid SKU first.");
            const qty = parseInt(document.getElementById("iQty").value) || 1;
            const note = document.getElementById("iLineNote").value;
            const price = selectedItem.retail || 0;

            orderLines.push({
                sku: selectedItem.sku,
                name: selectedItem.name || selectedItem.desc,
                qty: qty,
                price: price,
                note: note
            });

            // Reset Line Inputs
            document.getElementById("iSkuSearch").value = "";
            document.getElementById("iQty").value = "1";
            document.getElementById("iLineNote").value = "";
            document.getElementById("skuInfo").style.display = "none";
            selectedItem = null;

            renderLines();
        }

        function removeLine(idx) {
            orderLines.splice(idx, 1);
            renderLines();
        }

        function renderLines() {
            const tbody = document.getElementById("lineBody");
            const tfoot = document.getElementById("tableFoot");

            if (orderLines.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:40px; color:#94a3b8; font-size:14px;">Your cart is empty. Add items above.</td></tr>`;
                tfoot.style.display = "none";
                return;
            }

            let total = 0;
            tbody.innerHTML = orderLines.map((l, i) => {
                const lineTotal = l.qty * l.price;
                total += lineTotal;

                return `
                <tr style="border-bottom:1px solid #f1f5f9;">
                    <td style="padding:12px 16px;"><strong>${l.sku}</strong></td>
                    <td style="padding:12px 16px; font-size:13px;">
                        ${l.name || ""}
                        ${l.note ? `<div style="font-size:11px; color:#6366f1; font-style:italic;">Note: ${l.note}</div>` : ''}
                    </td>
                    <td style="padding:12px 16px; text-align:right;">${window.formatMoney(l.price)}</td>
                    <td style="padding:12px 16px; text-align:right;">${l.qty}</td>
                    <td style="padding:12px 16px; text-align:right; font-weight:600;">${window.formatMoney(lineTotal)}</td>
                    <td style="padding:12px 16px; text-align:right;">
                        <button onclick="removeLine(${i})" style="color:#94a3b8; background:none; border:none; cursor:pointer; font-size:18px;">&times;</button>
                    </td>
                </tr>
            `}).join("");

            document.getElementById("orderTotal").textContent = window.formatMoney(total);
            tfoot.style.display = "table-footer-group";
        }

        function submitOrder() {
            const cust = document.getElementById("iCust").value.trim();
            const shipMethod = document.getElementById("iShip").value;

            if (!cust) return toast("Error", "Customer Name Required");
            if (orderLines.length === 0) return toast("Error", "Add at least one item.");
            if (!shipMethod) return toast("Error", "Select a Shipping Method");

            const orders = JSON.parse(localStorage.getItem(ORDER_KEY) || "[]");

            // Generate ID if new, or use existing if edit
            let saveId;
            if (EDIT_ID) {
                saveId = EDIT_ID;
            } else {
                saveId = "ORD-" + (1000 + orders.length + 1);
            }

            let total = 0;
            orderLines.forEach(l => total += (l.price * l.qty));

            // Validation Logic (simplified mostly, same as before)
            let status = "Validated";
            if (EDIT_ID) {
                // Keep existing status unless overridden by validation issues below
                const existing = orders.find(o => o.id === EDIT_ID);
                if (existing) status = existing.status;
            }

            let holdReason = "";

            for (const line of orderLines) {
                const item = allItems.find(i => i.sku === line.sku);
                if (item) {
                    const restricted = ["Feeds Only", "Discontinued", "Internal Use", "Presentation"];
                    if (restricted.includes(item.status)) {
                        status = "On Hold";
                        holdReason = `Item ${line.sku} is ${item.status}`;
                        break;
                    }
                    if (line.qty > (item.on || 0)) {
                        status = "On Hold";
                        holdReason = `Insufficient Stock for ${line.sku} (Req: ${line.qty}, OH: ${item.on})`;
                        break;
                    }
                }
            }

            const newOrder = {
                id: saveId,
                cust: cust,
                po: document.getElementById("iPO").value,
                date: new Date().toISOString().split('T')[0],
                inHands: document.getElementById("iDate").value,
                wh: document.getElementById("iWh").value,
                ship: shipMethod,
                acct: document.getElementById("iAcct").value,
                note: document.getElementById("iOrderNote").value,
                lines: orderLines,
                total: total,
                status: status,
                holdReason: holdReason,
                // Preserve other fields if editing
                invoices: EDIT_ID ? (orders.find(o => o.id === EDIT_ID)?.invoices || []) : [],
                packages: EDIT_ID ? (orders.find(o => o.id === EDIT_ID)?.packages || []) : []
            };

            if (EDIT_ID) {
                // Update
                const idx = orders.findIndex(o => o.id === EDIT_ID);
                if (idx >= 0) orders[idx] = newOrder;
            } else {
                // Create
                orders.unshift(newOrder);
            }

            localStorage.setItem(ORDER_KEY, JSON.stringify(orders));

            const msg = status === "On Hold" ? `Order Saved (ON HOLD): ${holdReason}` : `Order Saved: ${saveId}`;
            const type = status === "On Hold" ? "Warning" : "Success";

            // Check Event Creation
            if (document.getElementById("isEvent").checked) {
                const EVENT_KEY = "stark_events_v1";
                const events = JSON.parse(localStorage.getItem(EVENT_KEY) || "[]");

                const evtId = "evt_" + Date.now();
                const evtDate = newOrder.inHands || newOrder.date; // Use In-Hands if available

                // Map lines to event items
                const evtItems = orderLines.map(l => ({ sku: l.sku, qty: l.qty }));

                const newEvent = {
                    id: evtId,
                    name: `Event for Order ${saveId}`,
                    customer: cust,
                    date: evtDate,
                    location: "See Order Logistics",
                    address: {
                        line1: "See Order " + saveId,
                        city: "", state: "", zip: ""
                    },
                    instructions: `Generated from Order ${saveId}. ${newOrder.note}`,
                    fulfill: "Hold", // Default for auto-created events
                    items: evtItems,
                    status: "Scheduled",
                    inventoryStatus: "Good"
                };

                events.push(newEvent);
                localStorage.setItem(EVENT_KEY, JSON.stringify(events));

                // Also trigger alert
                alert("Event automatically scheduled for " + evtDate);
            }

            toast(type, msg);
            setTimeout(() => {
                window.location.href = "orders.html";
            }, 1500);
        }

    </script>
</body>

</html>
