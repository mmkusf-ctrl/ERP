<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Create Sales Order | Stark Premium ERP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=9">


    font-size: 13px;
    }
    </style>
</head>

<body>

    <header class="topbar">
        <div class="topbar-inner">
            <a href="dashboard.html" class="logo">
                <img src="images/stark-logo.png" alt="Stark Premium">
                <span class="logo-text">Stark ERP</span>
            </a>
            <nav class="nav">
                <a class="nav-link" href="dashboard.html">Overview</a>
                <a class="nav-link" href="master.html">Items</a>
                <a class="nav-link active" href="orders.html">Orders</a>
                <a class="nav-link" href="inventory.html">Inventory</a>
                <a class="nav-link" href="crm.html">CRM</a>
            </nav>
            <div style="display:flex; align-items:center; gap:12px;">
                <div class="badge badge-green">Online</div>
                <button class="hamburger"
                    onclick="document.getElementById('mobileNav').classList.add('open')"><span></span><span></span><span></span></button>
            </div>
        </div>
    </header>

    <!-- Mobile Drawer -->
    <div class="mobile-nav" id="mobileNav">
        <div class="mobile-drawer">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <strong style="font-size:16px;">Navigation</strong>
                <button onclick="document.getElementById('mobileNav').classList.remove('open')"
                    style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <a class="mobile-link" href="dashboard.html">Overview</a>
            <a class="mobile-link active" href="orders.html">Orders</a>
        </div>
    </div>

    <main class="container soft-ui-wrapper" style="padding-top:40px; max-width:1200px;">

        <!-- Header -->
        <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:24px;">
            <a href="orders.html" class="text-secondary"
                style="font-size:13px; font-weight:600; text-decoration:none;">&larr; Back to Order List</a>
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;">
                <h1 class="page-title" style="margin:0;">New Sales Order</h1>
                <div style="display:flex; gap:12px;">
                    <button class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitOrder()">Submit Order</button>
                </div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 3fr 1fr; gap:32px; align-items:start;">

            <!-- Left Col: Content -->
            <div style="display:grid; gap:24px;">

                <!-- Order Basics -->
                <div class="card-soft" style="padding:24px;">
                    <h3
                        style="font-size:16px; margin:0 0 20px; color:#1e293b; border-bottom:1px solid #e2e8f0; padding-bottom:12px;">
                        Customer Details</h3>
                    <div class="grid-2" style="gap:24px;">
                        <div>
                            <label class="form-label">Customer Name</label>
                            <input id="iCust" class="input" placeholder="e.g. Acme Corp">
                        </div>
                        <div>
                            <label class="form-label">Customer PO #</label>
                            <input id="iPO" class="input" placeholder="e.g. PO-998877">
                        </div>
                    </div>
                </div>

                <!-- Line Items -->
                <div class="card-soft" style="padding:24px; min-height:400px;">
                    <h3 style="font-size:16px; margin:0 0 20px; color:#1e293b;">Line Items</h3>

                    <!-- Search Bar area -->
                    <div
                        style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:20px; margin-bottom:24px;">
                        <div class="grid-4"
                            style="gap:16px; grid-template-columns: 3fr 1fr 2fr 100px; align-items:end;">

                            <div class="autocomplete-wrapper">
                                <label class="form-label">SKU Lookup</label>
                                <input id="iSkuSearch" class="input" placeholder="Search by SKU or Name..."
                                    oninput="filterSkus(this.value)" onfocus="filterSkus(this.value)"
                                    style="border-color:#cbd5e1;">
                                <div id="skuList" class="autocomplete-list"></div>
                            </div>

                            <div>
                                <label class="form-label">Qty</label>
                                <input id="iQty" type="number" class="input" value="1" min="1"
                                    style="text-align:center;">
                            </div>

                            <div>
                                <label class="form-label">Notes / Customization</label>
                                <input id="iLineNote" class="input" placeholder="Optional notes...">
                            </div>

                            <button class="btn btn-primary" onclick="addLine()"
                                style="height:42px; justify-content:center;">Add</button>
                        </div>

                        <!-- Active Selection Preview -->
                        <div id="skuInfo"
                            style="margin-top:16px; padding-top:16px; border-top:1px dashed #cbd5e1; display:none;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <div style="font-size:15px; font-weight:700; color:#1e293b;"><span
                                            id="infoSku"></span> â€” <span id="infoName" style="font-weight:400;"></span>
                                    </div>
                                    <div style="font-size:12px; color:#64748b; margin-top:4px;">Retail: <strong
                                            id="infoPrice"></strong></div>
                                </div>
                                <div style="text-align:right;">
                                    <div
                                        style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase;">
                                        Inventory Status</div>
                                    <div style="display:flex; gap:12px; margin-top:4px;">
                                        <div class="badge badge-green" id="badgeOH">OH: <span id="infoOH"></span></div>
                                        <div id="infoPO"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-container"
                        style="box-shadow:none; border:1px solid #e2e8f0; padding:0; overflow:hidden;">
                        <table style="width:100%;">
                            <thead style="background:#f8fafc;">
                                <tr>
                                    <th
                                        style="padding:12px 16px; font-size:11px; text-transform:uppercase; color:#64748b;">
                                        SKU</th>
                                    <th
                                        style="padding:12px 16px; font-size:11px; text-transform:uppercase; color:#64748b;">
                                        Description</th>
                                    <th
                                        style="padding:12px 16px; font-size:11px; text-transform:uppercase; color:#64748b; text-align:right;">
                                        Price</th>
                                    <th
                                        style="padding:12px 16px; font-size:11px; text-transform:uppercase; color:#64748b; text-align:right;">
                                        Qty</th>
                                    <th
                                        style="padding:12px 16px; font-size:11px; text-transform:uppercase; color:#64748b; text-align:right;">
                                        Total</th>
                                    <th style="padding:12px 16px;"></th>
                                </tr>
                            </thead>
                            <tbody id="lineBody">
                                <tr>
                                    <td colspan="6"
                                        style="text-align:center; padding:40px; color:#94a3b8; font-size:14px;">Your
                                        cart is empty. Add items above.</td>
                                </tr>
                            </tbody>
                            <tfoot id="tableFoot" style="display:none; background:#f8fafc;">
                                <tr>
                                    <td colspan="4"
                                        style="text-align:right; padding:16px; font-weight:700; color:#64748b;">TOTAL
                                    </td>
                                    <td style="text-align:right; padding:16px; font-weight:800; font-size:16px; color:#0f172a;"
                                        id="orderTotal">$0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                </div>

            </div>

            <!-- Right Col: Sidebar -->
            <div style="display:grid; gap:24px; align-content:start;">

                <div class="card-soft" style="padding:24px;">
                    <h3
                        style="font-size:16px; margin:0 0 20px; color:#1e293b; border-bottom:1px solid #e2e8f0; padding-bottom:12px;">
                        Shipping & Logistics</h3>

                    <div style="margin-bottom:16px;">
                        <label class="form-label">Warehouse</label>
                        <select id="iWh" class="input">
                            <option value="Sarasota">Sarasota, FL (Main)</option>
                            <option value="Texas">Austin, TX (West)</option>
                        </select>
                    </div>

                    <div style="margin-bottom:16px;">
                        <label class="form-label">Need By Date</label>
                        <input id="iDate" type="date" class="input">
                    </div>

                    <hr style="border:none; border-top:1px solid #f1f5f9; margin:20px 0;">

                    <div style="margin-bottom:16px;">
                        <label class="form-label">Shipping Carrier</label>
                        <select id="iShip" class="input" style="font-weight:600;">
                            <optgroup label="UPS">
                                <option>UPS Ground</option>
                                <option>UPS 3 Day Select</option>
                                <option>UPS 2nd Day Air</option>
                                <option>UPS Next Day Air</option>
                            </optgroup>
                            <optgroup label="FedEx">
                                <option>FedEx Ground</option>
                                <option>FedEx Express Saver</option>
                                <option>FedEx 2Day</option>
                                <option>FedEx Standard Overnight</option>
                                <option>FedEx Priority Overnight</option>
                            </optgroup>
                        </select>
                    </div>

                    <div style="margin-bottom:16px;">
                        <label class="form-label">Account # (Optional)</label>
                        <input id="iAcct" class="input" placeholder="Use 3rd party acct...">
                    </div>
                </div>

                <div class="card-soft" style="padding:24px;">
                    <h3
                        style="font-size:16px; margin:0 0 20px; color:#1e293b; border-bottom:1px solid #e2e8f0; padding-bottom:12px;">
                        Order Notes</h3>
                    <textarea id="iOrderNote" class="input" rows="4"
                        placeholder="Special instructions for the warehouse team..."></textarea>
                </div>

            </div>

        </div>

    </main>

    <div id="toastWrap" style="position:fixed; bottom:20px; right:20px; z-index:9999; display:grid; gap:10px;"></div>

    <script src="erp.js"></script>
    <script>
        const ITEM_KEY = "stark_erp_items_v2";
        const ORDER_KEY = "stark_erp_orders_v1";

        let allItems = [];
        let orderLines = [];
        let selectedItem = null;

        (function init() {
            try { allItems = JSON.parse(localStorage.getItem(ITEM_KEY) || "[]"); } catch { allItems = []; }
            document.addEventListener("click", function (e) {
                if (!e.target.closest(".autocomplete-wrapper")) {
                    document.getElementById("skuList").style.display = "none";
                }
            });
        })();

        function filterSkus(val) {
            const listEl = document.getElementById("skuList");
            if (!val) { listEl.style.display = "none"; return; }

            const matches = allItems.filter(i => i.sku.toLowerCase().includes(val.toLowerCase()) || (i.name && i.name.toLowerCase().includes(val.toLowerCase()))).slice(0, 8);
            if (matches.length === 0) { listEl.style.display = "none"; return; }

            listEl.innerHTML = matches.map(i => `
                <div class="autocomplete-item" onclick="selectSku('${i.sku}')">
                    <div><strong>${i.sku}</strong><div style="font-size:12px; color:#64748b;">${i.name || i.desc || ''}</div></div>
                    <div style="text-align:right;"><div style="font-weight:600; font-size:12px;">${i.on} OH</div></div>
                </div>
            `).join("");
            listEl.style.display = "block";
        }

        function selectSku(sku) {
            selectedItem = allItems.find(i => i.sku === sku);
            if (!selectedItem) return;

            document.getElementById("iSkuSearch").value = selectedItem.sku;
            document.getElementById("skuList").style.display = "none";
            document.getElementById("infoSku").textContent = selectedItem.sku;
            document.getElementById("infoName").textContent = selectedItem.name || selectedItem.desc || "(No Name)";
            document.getElementById("infoPrice").textContent = window.formatMoney(selectedItem.retail || 0);
            document.getElementById("infoOH").textContent = selectedItem.on;

            const hasPo = (selectedItem.starkEta || "").length > 0;
            document.getElementById("infoPO").innerHTML = hasPo ? `<div class="badge badge-green">Inbound: ${selectedItem.starkEta}</div>` : ``;
            document.getElementById("skuInfo").style.display = "block";
            document.getElementById("iQty").focus();
        }

        function addLine() {
            if (!selectedItem) return toast("Error", "Please select a valid SKU first.", "error");
            const qty = parseInt(document.getElementById("iQty").value) || 1;
            const note = document.getElementById("iLineNote").value;
            const price = selectedItem.retail || 0;

            orderLines.push({ sku: selectedItem.sku, name: selectedItem.name || selectedItem.desc, qty: qty, price: price, note: note });

            document.getElementById("iSkuSearch").value = "";
            document.getElementById("iQty").value = "1";
            document.getElementById("iLineNote").value = "";
            document.getElementById("skuInfo").style.display = "none";
            selectedItem = null;
            renderLines();
        }

        function removeLine(idx) {
            orderLines.splice(idx, 1);
            renderLines();
        }

        function renderLines() {
            const tbody = document.getElementById("lineBody");
            const tfoot = document.getElementById("tableFoot");

            if (orderLines.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:40px; color:#94a3b8; font-size:14px;">Your cart is empty. Add items above.</td></tr>`;
                tfoot.style.display = "none";
                return;
            }

            let total = 0;
            tbody.innerHTML = orderLines.map((l, i) => {
                const lineTotal = l.qty * l.price;
                total += lineTotal;
                return `
                <tr class="master-row"> <!-- Using master-row from style.css for hover effect -->
                    <td style="padding:12px 16px;"><strong>${l.sku}</strong></td>
                    <td style="padding:12px 16px; font-size:13px;">${l.name || ""} ${l.note ? `<div style="font-size:11px; color:#6366f1; font-style:italic;">Note: ${l.note}</div>` : ''}</td>
                    <td style="padding:12px 16px; text-align:right;">${window.formatMoney(l.price)}</td>
                    <td style="padding:12px 16px; text-align:right;">${l.qty}</td>
                    <td style="padding:12px 16px; text-align:right; font-weight:600;">${window.formatMoney(lineTotal)}</td>
                    <td style="padding:12px 16px; text-align:right;">
                        <button onclick="removeLine(${i})" style="color:#ef4444; background:none; border:none; cursor:pointer; font-size:18px;">&times;</button>
                    </td>
                </tr>
            `}).join("");

            document.getElementById("orderTotal").textContent = window.formatMoney(total);
            tfoot.style.display = "table-footer-group";
        }

        function submitOrder() {
            const cust = document.getElementById("iCust").value.trim();
            const shipMethod = document.getElementById("iShip").value;
            if (!cust) return toast("Validation Error", "Customer Name Required", "error");
            if (orderLines.length === 0) return toast("Validation Error", "Add at least one item.", "error");
            if (!shipMethod) return toast("Validation Error", "Select a Shipping Method", "error");

            const orders = JSON.parse(localStorage.getItem(ORDER_KEY) || "[]");
            const newId = "ORD-" + (1000 + orders.length + 1);
            let total = 0;
            orderLines.forEach(l => total += (l.price * l.qty));

            let status = "Validated";
            let holdReason = "";
            for (const line of orderLines) {
                const item = allItems.find(i => i.sku === line.sku);
                if (item) {
                    if (["Feeds Only", "Discontinued", "Internal Use", "Presentation"].includes(item.status)) {
                        status = "On Hold"; holdReason = `Item ${line.sku} is ${item.status}`; break;
                    }
                    if (line.qty > (item.on || 0)) {
                        status = "On Hold"; holdReason = `Insufficient Stock for ${line.sku} (Req: ${line.qty}, OH: ${item.on})`; break;
                    }
                }
            }

            const newOrder = {
                id: newId, cust, po: document.getElementById("iPO").value, date: new Date().toISOString(), inHands: document.getElementById("iDate").value,
                wh: document.getElementById("iWh").value, ship: shipMethod, acct: document.getElementById("iAcct").value, note: document.getElementById("iOrderNote").value,
                lines: orderLines, total, status, holdReason
            };

            orders.unshift(newOrder);
            localStorage.setItem(ORDER_KEY, JSON.stringify(orders));

            toast(status === "On Hold" ? "Warning" : "Success", status === "On Hold" ? `Order Created (ON HOLD): ${holdReason}` : `Order Created: ${newId}`, status === "On Hold" ? "error" : "success");
            setTimeout(() => { window.location.href = "orders.html"; }, 1500);
        }
    </script>
</body>

</html>
