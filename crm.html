<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>CRM | Stark Premium ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    .kpi-num {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 4px;
    }
  </style>
</head>

<body>
  <!-- Top Navigation -->
  <header class="topbar">
    <div class="topbar-inner">
      <a href="dashboard.html" class="logo">
        <img src="images/stark-logo.png" alt="Stark Premium">
        <span class="logo-text">Stark ERP</span>
      </a>

      <nav class="nav">
        <a class="nav-link" href="dashboard.html">Overview</a>
        <a class="nav-link active" href="crm.html">CRM</a>
        <a class="nav-link" href="vendor.html">Vendor</a>
        <a class="nav-link" href="purchasing.html">Purchasing</a>
        <a class="nav-link" href="inventory.html">Inventory</a>
        <a class="nav-link" href="accounting.html">Accounting</a>
        <a class="nav-link" href="orders.html">Orders</a>
        <a class="nav-link" href="logistics.html">Logistics</a>
        <a class="nav-link" href="reports.html">Reports</a>
        <a class="nav-link" href="events.html">Events</a>
      </nav>

      <div style="display:flex; align-items:center; gap:12px;">
        <button class="btn btn-primary" onclick="openCustomerModal()">
          + Customer
        </button>
        <button class="hamburger" onclick="openMobileNav()">
          <span></span><span></span><span></span>
        </button>
      </div>
    </div>
  </header>

  <div class="mobile-nav" id="mobileNav">
    <div class="mobile-drawer">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <strong style="font-size:16px;">Navigation</strong>
        <button onclick="closeMobileNav()"
          style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
      </div>
      <a class="mobile-link" href="dashboard.html">Overview</a>
      <a class="mobile-link active" href="crm.html">CRM</a>
      <a class="mobile-link" href="inventory.html">Inventory</a>
      <a class="mobile-link" href="orders.html">Orders</a>
      <a class="mobile-link" href="logistics.html">Logistics</a>
      <a class="mobile-link" href="trends.html">Trends</a>
    </div>
  </div>

  <main class="container">

    <!-- Header -->
    <div class="page-header">
      <h1 class="page-title">Customer Relationship Management</h1>
      <p class="page-desc">Manage customer directory, view order activity, and analyze retention signals.</p>
      <div class="gold-line"></div>
    </div>

    <!-- Controls -->
    <section class="card" style="margin-bottom:24px;">
      <h2 style="font-size:16px; margin:0 0 16px;">Filters & Controls</h2>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
        <input id="search" class="input" placeholder="Search customer, location..." oninput="render()" />
        <select id="customerFilter" class="input" onchange="onCustomerFilterChange()">
          <!-- Filled by JS -->
        </select>
        <select id="monthSelect" class="input" onchange="render()"></select>
      </div>
    </section>

    <!-- KPI Grid -->
    <section class="kpi-grid" style="margin-bottom:24px;">
      <article class="card-kpi clickable-kpi active" onclick="setFilter('all')" id="kAll">
        <div class="card-header">
          <div class="card-title">All Customers</div>
          <div class="badge badge-green">Total</div>
        </div>
        <div class="stat-value" id="kpiTotal">0</div>
      </article>

      <article class="card-kpi clickable-kpi" onclick="setFilter('active')" id="kActive">
        <div class="card-header">
          <div class="card-title">Active Customers</div>
          <div class="badge badge-green">Engaged</div>
        </div>
        <div class="stat-value" id="kpiActive">0</div>
        <div class="stat-trend neutral">‚â• 1 sale this month</div>
      </article>

      <article class="card-kpi clickable-kpi" onclick="setFilter('nosales')" id="kZero">
        <div class="card-header">
          <div class="card-title">Zero Sales</div>
          <div class="badge badge-red">At Risk</div>
        </div>
        <div class="stat-value" id="kpiZero">0</div>
        <div class="stat-trend down">No activity this month</div>
      </article>

      <article class="card-kpi clickable-kpi" onclick="window.location.href='reports.html'">
        <div class="card-header">
          <div class="card-title">Monthly Revenue</div>
          <div class="badge badge-green">Income</div>
        </div>
        <div class="stat-value" id="kpiRev">$0.00</div>
        <div class="stat-trend neutral">This month</div>
      </article>
    </section>

    <div class="grid grid-2">
      <!-- Directory -->
      <section class="card" style="overflow:hidden;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h2 style="font-size:18px; margin:0;" id="dirTitle">Directory</h2>
          <span style="font-size:12px; color:var(--text-muted);">Click row to view details</span>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Company Name</th>
                <th>Location</th>
                <th>Orders (Mo)</th>
                <th>Total Spend</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="custBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Details Sidebar -->
      <aside style="display:grid; gap:24px; align-content:start;">
        <div class="card">
          <h2 style="font-size:16px; margin:0 0 16px;">Customer Insights</h2>

          <div id="detailPlaceholder"
            style="padding:40px 0; text-align:center; color:var(--text-muted); font-size:13px;">
            Select a customer to view details.
          </div>

          <div id="detailContent" style="display:none;">
            <div
              style="background:var(--bg-body); padding:20px; border-radius:var(--radius-md); border:1px solid var(--border); margin-bottom:16px;">
              <strong style="display:block; font-size:18px; margin-bottom:4px;" id="dName">Name</strong>
              <div style="font-size:13px; color:var(--text-muted); margin-bottom:12px;" id="dLoc">Location</div>

              <div style="display:grid; gap:8px; font-size:13px;">
                <div style="display:flex; gap:8px; align-items:center;">
                  <span style="color:var(--text-muted); width:20px;">üë§</span> <span id="dContact">Contact</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <span style="color:var(--text-muted); width:20px;">üìß</span> <span id="dEmail">Email</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <span style="color:var(--text-muted); width:20px;">üìû</span> <span id="dPhone">Phone</span>
                </div>
              </div>
            </div>

            <div
              style="background:#f8fafc; padding:16px; border-radius:var(--radius-md); border:1px solid var(--border); margin-bottom:12px;">
              <strong style="display:block; font-size:13px; margin-bottom:6px;">Order History (Last 6 Months)</strong>
              <div id="monthlyLine"
                style="font-size:13px; color:var(--primary); font-family:monospace; letter-spacing:2px;">‚Äî</div>
            </div>

            <div
              style="background:#f8fafc; padding:16px; border-radius:var(--radius-md); border:1px solid var(--border);">
              <strong style="display:block; font-size:13px; margin-bottom:4px;">Top SKU (Lifetime)</strong>
              <div id="skuLine" style="font-size:14px; font-weight:600;">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><span class="card-title">Quick Actions</span></div>
          <button class="btn btn-secondary" style="width:100%;" onclick="seedCustomers()">Reload Demo Data</button>
        </div>
      </aside>
    </div>

    <div style="margin-top:40px; text-align:center; color:var(--text-muted); font-size:13px;">
      &copy; 2026 Stark Premium ERP.
    </div>
  </main>

  <!-- Add Customer Modal -->
  <div class="mobile-nav" id="customerModal" style="z-index:900;">
    <div class="card"
      style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:min(90%, 500px); max-height:90vh; overflow-y:auto; box-shadow:var(--shadow-card);">
      <div
        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:12px; border-bottom:1px solid var(--border);">
        <h3 style="margin:0;">Add Customer</h3>
        <button onclick="closeCustomerModal()"
          style="border:none; bg:transparent; font-size:24px; cursor:pointer;">&times;</button>
      </div>

      <div style="display:grid; gap:16px;">
        <div>
          <label style="font-size:12px; font-weight:700; color:var(--text-muted);">Company Name</label>
          <input id="cName" class="input" placeholder="e.g. Acme Corp" />
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div>
            <label style="font-size:12px; font-weight:700; color:var(--text-muted);">Location</label>
            <input id="cLocation" class="input" placeholder="City, State" />
          </div>
          <div>
            <label style="font-size:12px; font-weight:700; color:var(--text-muted);">Type</label>
            <input id="cType" class="input" placeholder="Retailer" />
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div>
            <label style="font-size:12px; font-weight:700; color:var(--text-muted);">Contact Person</label>
            <input id="cContact" class="input" placeholder="Full Name" />
          </div>
          <div>
            <label style="font-size:12px; font-weight:700; color:var(--text-muted);">Phone</label>
            <input id="cPhone" class="input" placeholder="(555) 000-0000" />
          </div>
        </div>

        <div>
          <label style="font-size:12px; font-weight:700; color:var(--text-muted);">Email Address</label>
          <input id="cEmail" class="input" placeholder="name@company.com" />
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:8px;">
          <button class="btn btn-secondary" onclick="closeCustomerModal()">Cancel</button>
          <button class="btn btn-primary" onclick="addCustomer()">Save Profile</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toastWrap" style="position:fixed; bottom:20px; right:20px; z-index:9999; display:grid; gap:10px;"></div>

  <script src="erp.js"></script>
  <script>
    const AUTH_KEY = "stark_erp_auth_v1";
    (function () { try { const a = JSON.parse(localStorage.getItem(AUTH_KEY) || "null"); if (!a || !a.user) window.location.href = "index.html"; } catch { window.location.href = "index.html"; } })();

    const KEY_CUST = "stark_erp_customers_v1";
    const KEY_SALES = "stark_erp_sales_v1";
    let CURRENT_FILTER = "all"; // all, active, nosales

    // Setup Month Dropdown
    const monthSelect = document.getElementById("monthSelect");
    const today = new Date();
    for (let i = 0; i < 6; i++) {
      const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
      const val = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
      const lab = d.toLocaleString('default', { month: 'long', year: 'numeric' });
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = lab;
      monthSelect.appendChild(opt);
    }
    monthSelect.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}`;

    function load(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch { return fallback; }
    }
    function save(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
    function money(n) { return Number(n || 0).toLocaleString(undefined, { style: "currency", currency: "USD" }); }

    function openCustomerModal() { document.getElementById("customerModal").classList.add("open"); }
    function closeCustomerModal() { document.getElementById("customerModal").classList.remove("open"); }

    function addCustomer() {
      const name = (document.getElementById("cName").value || "").trim();
      const loc = (document.getElementById("cLocation").value || "").trim();
      if (!name) return toast("Required", "Company Name is missing.");

      const c = {
        id: "C-" + Date.now(),
        name,
        location: loc || "Unknown",
        type: document.getElementById("cType").value,
        contact: document.getElementById("cContact").value,
        email: document.getElementById("cEmail").value,
        phone: document.getElementById("cPhone").value,
        joined: new Date().toISOString()
      };

      const list = load(KEY_CUST, []);
      list.push(c);
      save(KEY_CUST, list);

      closeCustomerModal();
      toast("Success", "Customer profile created.");
      render();
    }

    function setFilter(f) {
      CURRENT_FILTER = f;
      document.querySelectorAll(".clickable-kpi").forEach(x => x.classList.remove("active"));
      if (f === 'all') document.getElementById("kAll").classList.add("active");
      if (f === 'active') document.getElementById("kActive").classList.add("active");
      if (f === 'nosales') document.getElementById("kZero").classList.add("active");
      render();
    }

    function render() {
      const customers = load(KEY_CUST, []);
      const sales = load(KEY_SALES, []);
      const search = (document.getElementById("search").value || "").toLowerCase();
      const selMonth = document.getElementById("monthSelect").value; // "YYYY-MM"
      const singleCust = document.getElementById("customerFilter").value;

      // Stats aggregation first
      const custStats = {};
      sales.forEach(s => {
        const ym = s.date.slice(0, 7);
        if (!custStats[s.customer]) custStats[s.customer] = { monthOrders: 0, monthRev: 0, lifeRev: 0, skus: {}, months: new Set() };
        const st = custStats[s.customer];
        st.lifeRev += (Number(s.unitPrice) * Number(s.qty));
        st.skus[s.sku] = (st.skus[s.sku] || 0) + Number(s.qty);
        st.months.add(ym);

        if (ym === selMonth) {
          st.monthOrders++;
          st.monthRev += (Number(s.unitPrice) * Number(s.qty));
        }
      });

      // Update KPIs
      let totalRev = 0;
      let activeCount = 0;
      let zeroCount = 0;

      customers.forEach(c => {
        const st = custStats[c.name];
        if (st && st.monthOrders > 0) {
          activeCount++;
          totalRev += st.monthRev;
        } else {
          zeroCount++;
        }
      });

      document.getElementById("kpiTotal").textContent = customers.length;
      document.getElementById("kpiActive").textContent = activeCount;
      document.getElementById("kpiZero").textContent = zeroCount;
      document.getElementById("kpiRev").textContent = money(totalRev);

      // Filtering List
      let shown = customers.filter(c => {
        const txt = (c.name + " " + c.location + " " + (c.contact || "")).toLowerCase();
        if (search && !txt.includes(search)) return false;
        if (singleCust && c.name !== singleCust) return false;

        const st = custStats[c.name] || { monthOrders: 0 };
        const isActive = st.monthOrders > 0;

        if (CURRENT_FILTER === 'active' && !isActive) return false;
        if (CURRENT_FILTER === 'nosales' && isActive) return false;

        return true;
      });

      // Build Table
      const tbody = document.getElementById("custBody");
      tbody.innerHTML = "";

      document.getElementById("dirTitle").textContent =
        CURRENT_FILTER === 'active' ? "Active Customers" :
          (CURRENT_FILTER === 'nosales' ? "Inactive Customers" : "Customer Directory");

      if (shown.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:var(--text-muted); padding:24px;">No customers found.</td></tr>`;
      }

      shown.forEach(c => {
        const st = custStats[c.name] || { monthOrders: 0, lifeRev: 0 };
        const isActive = st.monthOrders > 0;

        const tr = document.createElement("tr");
        tr.style.cursor = "pointer";
        tr.onclick = () => showDetail(c, st, selMonth);
        tr.innerHTML = `
          <td>
            <div style="font-weight:600; color:var(--text-main);">${escapeHtml(c.name)}</div>
            <div style="font-size:12px; color:var(--text-muted);">${escapeHtml(c.type || "Standard")}</div>
          </td>
          <td>${escapeHtml(c.location)}</td>
          <td>${st.monthOrders}</td>
          <td>${money(st.lifeRev)}</td>
          <td>${isActive ? `<span class="badge badge-green">Active</span>` : `<span class="badge badge-yellow">Quiet</span>`}</td>
        `;
        tbody.appendChild(tr);
      });

      // Customer Filter Init
      const cf = document.getElementById("customerFilter");
      if (cf.options.length <= 1) {
        cf.innerHTML = `<option value="">Filter by Company Name</option>`;
        customers.map(c => c.name).sort().forEach(n => {
          const opt = document.createElement("option");
          opt.value = n; opt.textContent = n;
          cf.appendChild(opt);
        });
      }
    }

    function showDetail(c, stats, selMonth) {
      document.getElementById("detailPlaceholder").style.display = "none";
      document.getElementById("detailContent").style.display = "block";

      document.getElementById("dName").textContent = c.name;
      document.getElementById("dLoc").textContent = c.location;
      document.getElementById("dContact").textContent = c.contact || "‚Äî";
      document.getElementById("dEmail").textContent = c.email || "‚Äî";
      document.getElementById("dPhone").textContent = c.phone || "‚Äî";

      // Monthly Line
      const h = [];
      if (stats && stats.months) {
        for (let i = 5; i >= 0; i--) {
          const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
          const ym = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
          const has = stats.months.has(ym) ? "‚óè" : "‚óã";
          h.push(has);
        }
      } else {
        for (let i = 0; i < 6; i++) h.push("‚óã");
      }
      document.getElementById("monthlyLine").textContent = h.join("  ");

      // SKU
      let topSku = "None"; let max = 0;
      if (stats && stats.skus) {
        for (const [k, v] of Object.entries(stats.skus)) {
          if (v > max) { max = v; topSku = k; }
        }
      }
      document.getElementById("skuLine").textContent = topSku + (max ? ` (${max} units)` : "");
    }

    function onCustomerFilterChange() { render(); }

    /* Demo Data Loading */
    function seedCustomers() {
      const demo = [
        { id: "C1", name: "Asha Retail", location: "Austin, TX", type: "Retailer", contact: "Sarah L", email: "sarah@asharetail.com", phone: "(512) 555-0101" },
        { id: "C2", name: "Blue Harbor", location: "Miami, FL", type: "Wholesale", contact: "Jim B", email: "jim@blueharbor.com", phone: "(305) 555-0123" },
        { id: "C3", name: "Citrine Luxe", location: "New York, NY", type: "Boutique", contact: "Elena R", email: "elena@citrine.com", phone: "(212) 555-0199" },
        { id: "C4", name: "Desert Pearl", location: "Phoenix, AZ", type: "Retailer", contact: "Marc D", email: "marc@desertp.com", phone: "(602) 555-0144" },
        { id: "C5", name: "Emerald Lane", location: "Seattle, WA", type: "Boutique", contact: "Lisa T", email: "lisa@emerald.com", phone: "(206) 555-0188" }
      ];
      save(KEY_CUST, demo);
      toast("Data Loaded", "Demo Customers loaded.");
      render();
    }

    // Init
    if (load(KEY_CUST, []).length === 0) seedCustomers();
    render();

  </script>
</body>

</html>
