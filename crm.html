<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>CRM | Stark Premium ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="erp.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

  <!-- Header / Topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <a href="dashboard.html" class="logo">
        <img src="images/stark-logo.png" alt="Stark Premium">
        <span class="logo-text">Stark ERP</span>
      </a>

      <nav class="nav">
        <a class="nav-link" href="dashboard.html">Home</a>
        <a class="nav-link" href="master.html">Master</a>
        <a class="nav-link active" href="crm.html">CRM</a>
        <a class="nav-link" href="vendor.html">Vendor</a>
        <a class="nav-link" href="purchasing.html">Purchasing</a>
        <a class="nav-link" href="inventory.html">Inventory</a>
        <a class="nav-link" href="accounting.html">Accounting</a>
        <a class="nav-link" href="orders.html">Orders</a>
        <a class="nav-link" href="logistics.html">Logistics</a>
        <a class="nav-link" href="reports.html">Reports</a>
        <a class="nav-link" href="events.html">Events</a>
      </nav>

      <div style="display:flex; align-items:center; gap:16px;">

        <div class="badge badge-green" style="display:none; @media(min-width:700px){display:inline-flex;}">
          Online
        </div>
        <button class="hamburger" onclick="openMobileNav()">
          <span></span><span></span><span></span>
        </button>
      </div>
    </div>
  </header>

  <div class="mobile-nav" id="mobileNav">
    <div class="mobile-drawer">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <strong style="font-size:16px;">Navigation</strong>
        <button onclick="closeMobileNav()"
          style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
      </div>
      <a class="mobile-link" href="dashboard.html">Overview</a>
      <a class="mobile-link active" href="crm.html">CRM</a>
      <a class="mobile-link" href="vendor.html">Vendor</a>
      <a class="mobile-link" href="purchasing.html">Purchasing</a>
      <a class="mobile-link" href="inventory.html">Inventory</a>
      <a class="mobile-link" href="accounting.html">Accounting</a>
      <a class="mobile-link" href="orders.html">Orders</a>
      <a class="mobile-link" href="logistics.html">Logistics</a>
    </div>
  </div>

  <!-- Main Content -->
  <main class="container soft-ui-wrapper">

    <!-- Page Title -->
    <div style="margin-bottom:32px;">
      <h1 class="page-title" style="margin-bottom:8px;">Customer Relationship Management</h1>
      <p class="page-desc" style="max-width:600px;">Manage customer directory, view order activity, and analyze
        retention signals.</p>
      <div class="gold-line" style="margin:16px 0 0; width:40px;"></div>
    </div>

    <!-- Filters & Controls -->
    <div class="card-soft" style="margin-bottom:32px; padding:24px;">
      <div style="font-size:13px; font-weight:700; color:var(--text-main); margin-bottom:16px;">Filters & Controls</div>
      <div style="display:grid; grid-template-columns: 2fr 1.5fr 1fr; gap:16px;">
        <input type="text" id="searchInput" class="input" placeholder="Search customer, location..."
          style="background:#f8fafc; border-color:#e2e8f0; height:48px;" oninput="renderCRM()">
        <select id="filterCompany" class="input" style="background:#f8fafc; border-color:#e2e8f0; height:48px;"
          onchange="renderCRM()">
          <option value="">Filter by Company Name</option>
          <option value="reset">Show All</option>
        </select>
        <div style="position:relative;">
          <select class="input" style="background:#f8fafc; border-color:#e2e8f0; height:48px;">
            <option>February 2026</option>
            <option>January 2026</option>
            <option>December 2025</option>
          </select>
        </div>
      </div>
    </div>

    <!-- KPI Grid -->
    <div class="grid grid-4" style="gap:24px; margin-bottom:32px;">
      <!-- All Customers -->
      <div class="kpi-card-soft" style="border-left:4px solid #6366f1; cursor:pointer;" onclick="filterStatus('all')">
        <div class="label">
          <span>All Customers</span>
          <span class="badge-soft" style="background:#e0e7ff; color:#4338ca;">Total</span>
        </div>
        <div class="val" id="kpiTotal">0</div>
      </div>

      <!-- Active Customers -->
      <div class="kpi-card-soft" style="border-left:4px solid #10b981; cursor:pointer;"
        onclick="filterStatus('Active')">
        <div class="label">
          <span>Active Customers</span>
          <span class="badge-soft" style="background:#d1fae5; color:#047857;">Engaged</span>
        </div>
        <div class="val" id="kpiActive">0</div>
        <div
          style="font-size:11px; background:#fff7ed; color:#c2410c; padding:4px 8px; border-radius:99px; display:inline-block; font-weight:600;">
          &gt; 1 sale this month
        </div>
      </div>

      <!-- Zero Sales -->
      <div class="kpi-card-soft" style="border-left:4px solid #ef4444; cursor:pointer;"
        onclick="filterStatus('AtRisk')">
        <div class="label">
          <span>Zero Sales</span>
          <span class="badge-soft" style="background:#fee2e2; color:#b91c1c;">At Risk</span>
        </div>
        <div class="val" id="kpiRisk">0</div>
        <div
          style="font-size:11px; background:#fef2f2; color:#b91c1c; padding:4px 8px; border-radius:99px; display:inline-block; font-weight:600;">
          No activity this month
        </div>
      </div>

      <!-- Monthly Revenue (Mock) -->
      <div class="kpi-card-soft" style="border-left:4px solid #f59e0b;">
        <div class="label">
          <span>Monthly Revenue</span>
          <span class="badge-soft" style="background:#dcfce7; color:#15803d;">Income</span>
        </div>
        <div class="val">$0.00</div>
        <div
          style="font-size:11px; background:#fffbeb; color:#b45309; padding:4px 8px; border-radius:99px; display:inline-block; font-weight:600;">
          This month
        </div>
      </div>
    </div>

    <!-- Directory Table (Full Width) -->
    <div class="card-soft" style="padding:0; overflow:hidden; min-height:500px;">
      <div
        style="padding:24px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="font-size:16px; margin:0; font-weight:700;">Customer Directory</h3>
        <button class="btn btn-primary" onclick="window.location.href='customer_add.html'"
          style="padding:8px 16px; font-weight:600; height:36px; display:flex; align-items:center; gap:8px;">
          <i class="fa-solid fa-plus"></i> Add Customer
        </button>
      </div>

      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background:#f8fafc; border-bottom:1px solid #e2e8f0;">
            <th
              style="text-align:left; padding:16px 24px; font-size:11px; text-transform:uppercase; color:var(--text-muted); font-weight:700;">
              Company Name</th>
            <th
              style="text-align:left; padding:16px 24px; font-size:11px; text-transform:uppercase; color:var(--text-muted); font-weight:700;">
              Location</th>
            <th
              style="text-align:left; padding:16px 24px; font-size:11px; text-transform:uppercase; color:var(--text-muted); font-weight:700;">
              Orders (Mo)</th>
            <th
              style="text-align:left; padding:16px 24px; font-size:11px; text-transform:uppercase; color:var(--text-muted); font-weight:700;">
              Total Spend</th>
            <th
              style="text-align:left; padding:16px 24px; font-size:11px; text-transform:uppercase; color:var(--text-muted); font-weight:700;">
              Status</th>
          </tr>
        </thead>
        <tbody id="crmTableBody">
          <!-- Populated via JS -->
        </tbody>
      </table>
    </div>

    <div style="margin-top:60px; text-align:center; color:var(--text-muted); font-size:13px; opacity:0.6;">
      &copy; 2026 Stark Premium ERP.
    </div>
  </main>

  <!-- Add Customer Modal -->
  <div class="modal" id="customerModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Add Customer</h3>
        <button class="x" onclick="closeCustomerModal()">×</button>
      </div>

      <div class="modal-body">
        <div class="modal-grid">
          <input id="cName" class="input" placeholder="Company Name (Required)" />
          <input id="cType" class="input" placeholder="Type (e.g. Retailer)" />
          <input id="cLocation" class="input" placeholder="Location (City, State)" />

          <input id="cEmail" class="input" placeholder="Email Contact" />
          <input id="cPhone" class="input" placeholder="Phone Number" />
        </div>
      </div>

      <div class="modal-footer">
        <div style="display:flex; justify-content:flex-end; gap:10px; width:100%;">
          <button class="btn secondary" onclick="closeCustomerModal()">Cancel</button>
          <button class="btn primary" onclick="addCustomer()">Save Customer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="erp.js"></script>
  <script>
    // --- CRM Data Logic ---
    const DEMO_DATA = [
      { id: 'C-101', name: 'Asha Retail', type: 'Retailer', location: 'Austin, TX', ordersMo: 0, spent: 11247.00, status: 'Quiet', email: 'contact@asha.com', phone: '512-555-0101', terms: 'Net 30' },
      { id: 'C-102', name: 'Blue Harbor', type: 'Wholesale', location: 'Miami, FL', ordersMo: 0, spent: 0.00, status: 'Quiet', email: 'sales@blueharbor.com', phone: '305-555-0102', terms: 'Due on Receipt' },
      { id: 'C-103', name: 'Citrine Luxe', type: 'Boutique', location: 'New York, NY', ordersMo: 0, spent: 4912.00, status: 'Quiet', email: 'info@citrine.com', phone: '212-555-0103', terms: 'Net 15' },
      { id: 'C-104', name: 'Stark Enterprises', type: 'Global', location: 'Los Angeles, CA', ordersMo: 5, spent: 1250000.00, status: 'Active', email: 'tony@stark.com', phone: '310-555-0104', terms: 'Net 60' },
      { id: 'C-105', name: 'Wayne Industries', type: 'Conglomerate', location: 'Gotham, NJ', ordersMo: 2, spent: 450000.00, status: 'Active', email: 'bruce@wayne.com', phone: '201-555-0105', terms: 'Net 90' }
    ];

    function getCustomers() {
      return JSON.parse(localStorage.getItem('stark_crm_customers') || '[]');
    }

    function saveCustomers(data) {
      localStorage.setItem('stark_crm_customers', JSON.stringify(data));
    }

    function resetDemoData() {
      saveCustomers(DEMO_DATA);
      window.location.reload();
    }

    // Init Data
    if (getCustomers().length === 0) {
      saveCustomers(DEMO_DATA);
    }

    let currentFilter = '';

    function renderCRM() {
      const customers = getCustomers();
      const search = document.getElementById('searchInput').value.toLowerCase();
      const companyFilter = document.getElementById('filterCompany').value;

      // Filter Logic
      let filtered = customers.filter(c =>
        (c.name.toLowerCase().includes(search) || c.location.toLowerCase().includes(search)) &&
        (companyFilter && companyFilter !== 'reset' ? c.name === companyFilter : true)
      );

      if (currentFilter === 'Active') {
        filtered = filtered.filter(c => c.status === 'Active' || c.ordersMo > 0);
      } else if (currentFilter === 'AtRisk') {
        filtered = filtered.filter(c => c.status === 'Quiet' || c.ordersMo === 0);
      }

      // Update KPIs
      document.getElementById('kpiTotal').textContent = customers.length;
      document.getElementById('kpiActive').textContent = customers.filter(c => c.status === 'Active' || c.ordersMo > 0).length;
      document.getElementById('kpiRisk').textContent = customers.filter(c => c.status === 'Quiet' || c.ordersMo === 0).length;

      // Populate Dropdown if empty
      const drop = document.getElementById('filterCompany');
      if (drop.options.length <= 2) {
        // Keep first 2, remove rest
        while (drop.options.length > 2) drop.remove(2);
        customers.forEach(c => {
          const op = document.createElement('option');
          op.value = c.name;
          op.text = c.name;
          drop.appendChild(op);
        });
      }

      // Render Table
      const tbody = document.getElementById('crmTableBody');
      tbody.innerHTML = '';

      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:32px; color:var(--text-muted);">No customers found matching filters.</td></tr>`;
        return;
      }

      filtered.forEach(c => {
        const badgeColor = c.status === 'Active' ? 'background:#d1fae5; color:#047857;' : 'background:#ffedd5; color:#c2410c;';

        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.onclick = () => showInsights(c.id);
        // Hover effect handled by CSS
        tr.className = 'table-row';
        tr.innerHTML = `
                    <td style="padding:16px 24px; border-bottom:1px solid #f1f5f9;">
                        <div style="font-weight:700; color:var(--text-main); font-size:14px;">${c.name}</div>
                        <div style="font-size:11px; color:var(--text-muted); margin-top:2px;">${c.type}</div>
                    </td>
                    <td style="padding:16px 24px; border-bottom:1px solid #f1f5f9; font-size:13px;">${c.location}</td>
                    <td style="padding:16px 24px; border-bottom:1px solid #f1f5f9; font-size:13px;">${c.ordersMo}</td>
                    <td style="padding:16px 24px; border-bottom:1px solid #f1f5f9; font-weight:600; font-size:13px;">$${c.spent.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                    <td style="padding:16px 24px; border-bottom:1px solid #f1f5f9;">
                        <span style="font-size:11px; padding:4px 10px; border-radius:12px; font-weight:700; text-transform:uppercase; ${badgeColor}">${c.status}</span>
                    </td>
                `;
        tbody.appendChild(tr);
      });
    }

    function filterStatus(status) {
      currentFilter = status === 'all' ? '' : status;
      renderCRM();
    }

    function showInsights(id) {
      const c = getCustomers().find(x => x.id === id);
      if (!c) return;

      const allOrders = JSON.parse(localStorage.getItem('stark_erp_orders_v1') || '[]');
      const recent = allOrders.filter(o => o.cust === c.name).slice(0, 3);

      const panel = document.getElementById('insightPanel');
      panel.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:24px; width:100%;">
                    <div>
                        <h3 style="margin:0; font-size:18px; font-weight:800; color:var(--text-main);">${c.name}</h3>
                        <div style="font-size:12px; color:var(--text-muted); margin-top:4px;">${c.location} • ${c.type}</div>
                    </div>
                     <span style="font-size:11px; padding:4px 10px; border-radius:12px; font-weight:700; text-transform:uppercase; background:#f3f4f6;">${c.status}</span>
                </div>
                
                <div style="display:grid; gap:16px; width:100%; text-align:left;">
                    <div style="background:#f8fafc; padding:16px; border-radius:12px;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                            <div>
                                <div style="font-size:11px; text-transform:uppercase; font-weight:700; color:var(--text-muted); margin-bottom:4px;">Contact</div>
                                <div style="font-size:13px; font-weight:600;">${c.email || 'No email'}</div>
                                <div style="font-size:13px;">${c.phone || 'No phone'}</div>
                            </div>
                            <div>
                                <div style="font-size:11px; text-transform:uppercase; font-weight:700; color:var(--text-muted); margin-bottom:4px;">Terms</div>
                                <div style="font-size:13px; font-weight:600; color:#4f46e5;">${c.terms || 'Due on Receipt'}</div>
                            </div>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div style="background:#fff; border:1px solid #e2e8f0; padding:12px; border-radius:12px; text-align:center;">
                             <div style="font-size:11px; text-transform:uppercase; font-weight:700; color:var(--text-muted);">Lifetime Spend</div>
                             <div style="font-size:16px; font-weight:800; color:#6366f1; margin-top:4px;">$${c.spent.toLocaleString()}</div>
                        </div>
                        <div style="background:#fff; border:1px solid #e2e8f0; padding:12px; border-radius:12px; text-align:center;">
                             <div style="font-size:11px; text-transform:uppercase; font-weight:700; color:var(--text-muted);">Avg Order</div>
                             <div style="font-size:16px; font-weight:800; color:#10b981; margin-top:4px;">$${(c.spent / (c.ordersMo || 1)).toLocaleString(undefined, { maximumFractionDigits: 0 })}</div>
                        </div>
                    </div>

                    <!-- Recent Orders -->
                    <div style="border-top:1px solid #e2e8f0; padding-top:16px;">
                        <div style="font-size:11px; text-transform:uppercase; font-weight:700; color:var(--text-muted); margin-bottom:8px;">Recent Orders</div>
                        ${recent.length === 0 ? '<div style="font-size:12px; color:var(--text-muted); font-style:italic;">No orders yet.</div>' : ''}
                        ${recent.map(o => `
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; font-size:13px;">
                                <div style="color:var(--primary); font-weight:600; cursor:pointer;" onclick="window.location.href='order_detail.html?id=${o.id}'">#${o.id}</div>
                                <div style="color:var(--text-muted);">${o.date}</div>
                                <div style="font-weight:600;">$${o.total.toLocaleString()}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top:16px; border-top:1px solid #e2e8f0; padding-top:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <div style="font-size:11px; text-transform:uppercase; font-weight:700; color:var(--text-muted);">Account Access</div>
                            ${c.auth && c.auth.isVerified ?
          `<span class="badge badge-green" style="font-size:10px;">Active</span>` :
          `<span class="badge badge-yellow" style="font-size:10px;">Invite Pending</span>`
        }
                        </div>
                        
                        ${!c.auth || !c.auth.isVerified ? `
                            <button class="btn btn-secondary" style="width:100%; justify-content:center; margin-bottom:8px; font-size:12px; height:32px;" onclick="resendInvite('${c.id}')">
                                <i class="fa fa-envelope" style="margin-right:6px;"></i> Resend Invite
                            </button>
                        ` : `
                             <button class="btn btn-secondary" style="width:100%; justify-content:center; margin-bottom:8px; font-size:12px; height:32px; color:#ef4444; border-color:#fee2e2;" onclick="revokeAccess('${c.id}')">
                                <i class="fa fa-ban" style="margin-right:6px;"></i> Revoke Access
                            </button>
                        `}
                        
                        <div style="background:#f8fafc; border-radius:8px; padding:12px; max-height:120px; overflow-y:auto; margin-top:8px;">
                            <div style="font-size:10px; font-weight:700; color:var(--text-muted); margin-bottom:6px; text-transform:uppercase;">Audit Log</div>
                            ${(c.auth && c.auth.audit) ? c.auth.audit.map(log => `
                                <div style="font-size:10px; margin-bottom:4px; color:#475569; display:flex; justify-content:space-between;">
                                    <span>${log.action}</span>
                                    <span style="color:#94a3b8;">${new Date(log.date).toLocaleDateString()}</span>
                                </div>
                            `).join('') : '<div style="font-size:10px; color:#94a3b8;">No activity logs.</div>'}
                        </div>
                    </div>

                    <button class="btn btn-primary" style="width:100%; justify-content:center; margin-top:12px;" onclick="window.location.href='customer_catalog.html?id=${c.id}'">
                        <i class="fa fa-list-ul" style="margin-right:8px;"></i> Manage Catalog
                    </button>
                    <button class="btn btn-secondary" style="width:100%; justify-content:center;" onclick="window.location.href='create_sales_order.html?cust=${encodeURIComponent(c.name)}'">
                        <i class="fa fa-plus" style="margin-right:8px;"></i> Create New Order
                    </button>
                </div>
            `;
    }

    function resendInvite(id) {
      const customers = getCustomers();
      const idx = customers.findIndex(c => c.id === id);
      if (idx === -1) return;

      // Generate new token
      const token = 'inv_' + Math.random().toString(36).substr(2, 9);
      if (!customers[idx].auth) customers[idx].auth = { status: 'Invited' };

      customers[idx].auth.token = token;
      customers[idx].auth.expires = Date.now() + (24 * 60 * 60 * 1000);

      if (!customers[idx].auth.audit) customers[idx].auth.audit = [];
      customers[idx].auth.audit.unshift({ action: "Invite Resent", date: new Date().toISOString(), ip: "Admin" });

      saveCustomers(customers);
      showInsights(id);

      // Popup Mailto
      const inviteLink = `${window.location.origin}/shop_register.html?token=${token}`;
      const mailBody = encodeURIComponent(`Here is your new invitation link:\n${inviteLink}\n\nValid for 24 hours.`);
      window.location.href = `mailto:${customers[idx].email}?subject=Invitation Update&body=${mailBody}`;
      toast("Success", "Invite resent via email.");
    }

    function revokeAccess(id) {
      if (!confirm("Are you sure? This will lock the account.")) return;
      const customers = getCustomers();
      const idx = customers.findIndex(c => c.id === id);
      if (idx === -1) return;

      customers[idx].auth.isVerified = false;
      customers[idx].auth.status = "Locked";
      customers[idx].auth.passwordHash = null;

      if (!customers[idx].auth.audit) customers[idx].auth.audit = [];
      customers[idx].auth.audit.unshift({ action: "Access Revoked", date: new Date().toISOString(), ip: "Admin" });

      saveCustomers(customers);
      showInsights(id);
      toast("Verified", "Access revoked.");
    }

    /* Modal Logic */
    function openCustomerModal() {
      document.getElementById("customerModal").classList.add("open");
    }
    function closeCustomerModal() {
      document.getElementById("customerModal").classList.remove("open");
    }
    function addCustomer() {
      const name = document.getElementById("cName").value;
      if (!name) return toast("Error", "Name required", "error");

      const newC = {
        id: 'C-' + Math.floor(Math.random() * 90000 + 10000),
        name: name,
        type: document.getElementById("cType").value || 'Prospect',
        location: document.getElementById("cLocation").value || 'Unknown',
        email: document.getElementById("cEmail").value || '',
        phone: document.getElementById("cPhone").value || '',
        status: 'Quiet',
        ordersMo: 0,
        spent: 0,
        terms: 'Due on Receipt'
      };
      const all = getCustomers();
      all.push(newC);
      saveCustomers(all);
      closeCustomerModal();
      renderCRM();
      toast("Success", "Customer added!", "success");
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      renderCRM();
    });

  </script>
</body>

</html>
