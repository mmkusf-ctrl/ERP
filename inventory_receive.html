<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Receive Inventory | Stark Premium ERP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=9">
</head>

<body class="theme-dark">

    <header class="topbar">
        <div class="topbar-inner">
            <a href="dashboard.html" class="logo">
                <img src="images/stark-logo.png" alt="Stark Premium">
                <span class="logo-text">Stark ERP</span>
            </a>
            <nav class="nav">
                <a class="nav-link" href="inventory.html">‚Üê Back to Inventory</a>
            </nav>
            <div style="display:flex; align-items:center; gap:12px;">
                <div class="badge badge-green">Secured Connection</div>
            </div>
        </div>
    </header>

    <main class="container soft-ui-wrapper" style="padding-top:40px; max-width:1400px;">

        <div class="receive-tool-layout">

            <!-- Sidebar: PO Selector -->
            <div class="card-soft"
                style="padding:0; overflow:hidden; border:none; display:flex; flex-direction:column; height:calc(100vh - 120px);">
                <div style="padding:20px; border-bottom:1px solid #e2e8f0; background:#f8fafc;">
                    <h3
                        style="margin:0 0 12px 0; font-size:14px; font-weight:700; color:#475569; text-transform:uppercase;">
                        Select Purchase Order</h3>
                    <select id="whSelect" class="input" style="font-size:13px; margin-bottom:8px;">
                        <option value="TX">Warehouse: Texas (Main)</option>
                        <option value="FL">Warehouse: Sarasota</option>
                    </select>
                    <input id="poSearch" class="input" placeholder="Search PO #..." oninput="renderPOList()"
                        style="font-size:13px;">
                </div>
                <div id="poList" style="overflow-y:auto; flex:1;">
                    <!-- List -->
                </div>
            </div>

            <!-- Main Area: Receipt Form -->
            <div id="receiptArea" class="glass-panel-dark"
                style="min-height:500px; padding:40px; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative;">

                <!-- Empty State -->
                <div id="emptyState" style="text-align:center; opacity:0.5;">
                    <div style="font-size:64px; margin-bottom:16px;">üöõ</div>
                    <h2 style="margin:0; font-size:24px; font-weight:700;">Ready to Receive</h2>
                    <p style="margin-top:8px;">Select a pending purchase order from the list to begin processing.</p>
                </div>

                <!-- Active Form -->
                <div id="activeForm" style="display:none; width:100%; max-width:900px;">
                    <div
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:32px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:24px;">
                        <div>
                            <div style="font-size:13px; color:#94a3b8; text-transform:uppercase; letter-spacing:1px;">
                                Receiving Order</div>
                            <h1 id="recPoId" style="margin:0; font-size:32px; font-weight:800;">PO-00000</h1>
                            <div id="recVendor" style="color:#cbd5e1; margin-top:4px;">Vendor Name</div>
                        </div>
                        <div style="text-align:right;">
                            <button onclick="commitReceipt()" class="btn btn-primary"
                                style="background:linear-gradient(135deg, #10b981, #059669); border:none; box-shadow:0 4px 12px rgba(16,185,129,0.3); padding:12px 32px; font-size:16px;">Finalize
                                Receipt</button>
                        </div>
                    </div>

                    <div
                        style="background:rgba(0,0,0,0.2); border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,0.05);">
                        <table style="width:100%; border-collapse:collapse;">
                            <thead
                                style="background:rgba(255,255,255,0.05); color:#94a3b8; font-size:12px; text-transform:uppercase;">
                                <tr>
                                    <th style="padding:16px; text-align:left;">Item Details</th>
                                    <th style="padding:16px; text-align:center; width:100px;">Expected</th>
                                    <th style="padding:16px; text-align:center; width:120px;">Received</th>
                                    <th style="padding:16px; text-align:center; width:100px;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="recTableBody">
                                <!-- Lines -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

        </div>

    </main>

    <div id="toastWrap" style="position:fixed; bottom:20px; right:20px; z-index:9999; display:grid; gap:10px;"></div>

    <script src="erp.js"></script>
    <script>
        const PO_KEY = "stark_erp_pos_v1";
        const ITEM_KEY = "stark_erp_items_v2";
        let SELECTED_PO = null;

        function loadItems() { try { return JSON.parse(localStorage.getItem(ITEM_KEY) || "[]"); } catch { return []; } }
        function loadPOs() { try { return JSON.parse(localStorage.getItem(PO_KEY) || "[]"); } catch { return []; } }
        function savePOs(d) { localStorage.setItem(PO_KEY, JSON.stringify(d)); }
        function saveItems(d) { localStorage.setItem(ITEM_KEY, JSON.stringify(d)); }

        function renderPOList() {
            const pos = loadPOs().filter(p => !['Completed', 'Delivered'].includes(p.status));
            const term = document.getElementById("poSearch").value.toLowerCase();
            const list = document.getElementById("poList");

            const filtered = pos.filter(p => p.id.toLowerCase().includes(term) || p.vendor.toLowerCase().includes(term));

            if (filtered.length === 0) {
                list.innerHTML = `<div style="padding:40px; text-align:center; color:#94a3b8;">No open POs found.</div>`;
                return;
            }

            list.innerHTML = filtered.map(p => `
                <div class="po-list-item ${SELECTED_PO && SELECTED_PO.id === p.id ? 'active' : ''}" onclick="selectPO('${p.id}')">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <strong style="color:#1e293b;">${p.id}</strong>
                         <span class="badge ${p.status === 'Approved' ? 'badge-green' : 'badge-gray'}">${p.status || 'Draft'}</span>
                    </div>
                    <div style="font-size:13px; color:#475569;">${p.vendor}</div>
                    <div style="font-size:11px; color:#94a3b8; margin-top:6px;">ETA: ${p.eta || 'N/A'}</div>
                </div>
            `).join("");
        }

        window.selectPO = function (id) {
            SELECTED_PO = loadPOs().find(p => p.id === id);
            renderPOList();

            if (!SELECTED_PO) return;

            document.getElementById("emptyState").style.display = 'none';
            const form = document.getElementById("activeForm");
            form.style.display = 'block';

            document.getElementById("recPoId").textContent = SELECTED_PO.id;
            document.getElementById("recVendor").textContent = SELECTED_PO.vendor;

            // Mock lines parsing
            const lines = (SELECTED_PO.lines || "").split("\n").filter(Boolean);
            const tbody = document.getElementById("recTableBody");

            tbody.innerHTML = lines.map((line, idx) => {
                let qty = 1;
                const m = line.match(/Qty:\s*(\d+)/i);
                if (m) qty = parseInt(m[1]);

                return `
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                        <td style="padding:16px;">
                            <div style="font-weight:600; color:white;">${line}</div>
                        </td>
                        <td style="padding:16px; text-align:center; color:#94a3b8;">${qty}</td>
                        <td style="padding:16px; text-align:center;">
                            <input type="number" class="dark-input" value="${qty}" min="0">
                        </td>
                        <td style="padding:16px; text-align:center;">
                            <span class="badge badge-green">Match</span>
                        </td>
                    </tr>
                `;
            }).join("");
        }

        window.commitReceipt = function () {
            if (!SELECTED_PO) return;

            const allPos = loadPOs();
            const target = allPos.find(p => p.id === SELECTED_PO.id);
            if (target) {
                target.status = "Completed";
                savePOs(allPos);

                const inv = loadItems();
                if (inv.length > 0) {
                    inv[0].on += 50; // Mock addition
                    saveItems(inv);
                }

                toast("Success", `Received ${SELECTED_PO.id} successfully.`, "success");
                SELECTED_PO = null;
                document.getElementById("activeForm").style.display = 'none';
                document.getElementById("emptyState").style.display = 'block';
                renderPOList();
            }
        }

        renderPOList();
    </script>
</body>

</html>
