<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Inventory | Stark Premium ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="style.css?v=4">

  <style>
    /* Specific Inventory Styles */
    .master-row {
      transition: transform 0.1s, background-color 0.1s;
    }

    .master-row:hover {
      transform: scale(1.002);
      background-color: #f8fafc;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      z-index: 10;
      position: relative;
    }

    /* Donut Chart */
    .donut-chart {
      position: relative;
      width: 140px;
      height: 140px;
      margin: 0 auto;
      border-radius: 50%;
      background: conic-gradient(var(--success) 0deg 240deg, var(--warning) 240deg 300deg, var(--danger) 300deg 360deg);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease;
    }

    .donut-chart:hover {
      transform: scale(1.05);
    }

    .donut-hole {
      width: 90px;
      height: 90px;
      background: white;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .action-icon-box {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-bottom: 12px;
    }
  </style>
</head>

<body>

  <!-- Top Navigation -->
  <header class="topbar">
    <div class="topbar-inner">
      <a href="dashboard.html" class="logo">
        <img src="images/stark-logo.png" alt="Stark Premium">
        <span class="logo-text">Stark ERP</span>
      </a>

      <nav class="nav">
        <a class="nav-link" href="dashboard.html">Overview</a>
        <a class="nav-link" href="master.html">Items</a>
        <a class="nav-link" href="crm.html">CRM</a>
        <a class="nav-link" href="vendor.html">Vendor</a>
        <a class="nav-link" href="purchasing.html">Purchasing</a>
        <a class="nav-link active" href="inventory.html">Inventory</a>
        <a class="nav-link" href="accounting.html">Accounting</a>
        <a class="nav-link" href="orders.html">Orders</a>
        <a class="nav-link" href="logistics.html">Logistics</a>
        <a class="nav-link" href="reports.html">Reports</a>
        <a class="nav-link" href="events.html">Events</a>
      </nav>

      <div style="display:flex; align-items:center; gap:12px;">
        <div class="badge badge-green" style="display:none; @media(min-width:700px){display:inline-flex;}">
          Online
        </div>
        <button class="hamburger" onclick="openMobileNav()">
          <span></span><span></span><span></span>
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile Drawer -->
  <div class="mobile-nav" id="mobileNav">
    <div class="mobile-drawer">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <strong style="font-size:16px;">Navigation</strong>
        <button onclick="closeMobileNav()"
          style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
      </div>
      <a class="mobile-link" href="dashboard.html">Overview</a>
      <a class="mobile-link" href="master.html">Items</a>
      <a class="mobile-link active" href="inventory.html">Inventory</a>
      <a class="mobile-link" href="orders.html">Orders</a>
      <a class="mobile-link" href="logistics.html">Logistics</a>
    </div>
  </div>

  <main class="container soft-ui-wrapper" style="padding-top:40px;">

    <!-- Header -->
    <div style="margin-bottom:32px;">
      <h1 class="page-title" style="margin-bottom:8px;">Inventory Operations</h1>
      <p class="page-desc">Manage stock levels, process inbound shipments, and maintain accuracy.</p>
      <div
        style="height:4px; width:40px; background:linear-gradient(90deg, #6366f1, transparent); border-radius:2px; margin-top:16px;">
      </div>
    </div>

    <!-- Section 1: Top KPI Grid -->
    <div class="grid grid-4" style="gap:24px; margin-bottom:32px;">
      <!-- Total SKUs -->
      <div class="card-soft clickable-stat-card active" onclick="setFilter('all')" id="kpiAll" style="padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
          <div style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">
            Total SKUs</div>
          <div class="badge badge-green">All</div>
        </div>
        <div class="stat-value" id="kTotal" style="font-size:32px;">‚Äî</div>
      </div>

      <!-- Low Stock -->
      <div class="card-soft clickable-stat-card" onclick="setFilter('low')" id="kpiLow" style="padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
          <div style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">
            Low Stock</div>
          <div class="badge badge-yellow">Reorder</div>
        </div>
        <div class="stat-value" id="kLow" style="color:#d97706; font-size:32px;">‚Äî</div>
      </div>

      <!-- Out of Stock -->
      <div class="card-soft clickable-stat-card" onclick="setFilter('oos')" id="kpiOos" style="padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
          <div style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">
            Stockout</div>
          <div class="badge badge-red">Critical</div>
        </div>
        <div class="stat-value" id="kOOS" style="color:#dc2626; font-size:32px;">‚Äî</div>
      </div>

      <!-- Valuation -->
      <div class="card-soft clickable-stat-card" onclick="setFilter('val')" id="kpiVal" style="padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
          <div style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">
            Valuation</div>
          <div class="badge badge-green">Asset</div>
        </div>
        <div class="stat-value" id="kValue" style="color:#059669; font-size:24px;">$0.00</div>
      </div>
    </div>

    <!-- Middle Section: Actions (Row 2) -->
    <div
      style="display:grid; grid-template-columns: repeat(3, 1fr); gap:24px; margin-bottom:32px; @media(max-width:900px){grid-template-columns:1fr;}">

      <!-- Receive -->
      <div class="card-soft clickable-stat-card" onclick="window.location.href='inventory_receive.html'"
        style="padding:24px;">
        <div class="action-icon-box" style="background:#e0e7ff; color:#4f46e5;">üì•</div>
        <h3 style="margin:0 0 8px; font-size:16px;">Receive Inventory</h3>
        <p style="font-size:13px; color:#64748b; margin:0 0 20px;">Process inbound shipments from counters to stock.</p>
        <button class="btn btn-primary" style="width:100%; height:40px; font-size:13px;">Start Reception &rarr;</button>
      </div>

      <!-- Adjust -->
      <div class="card-soft clickable-stat-card" onclick="window.location.href='inventory_adjust.html'"
        style="padding:24px;">
        <div class="action-icon-box" style="background:#f3e8ff; color:#7c3aed;">‚öôÔ∏è</div>
        <h3 style="margin:0 0 8px; font-size:16px;">Adjust Stock</h3>
        <p style="font-size:13px; color:#64748b; margin:0 0 20px;">Manual corrections for damages, loss, or found items.
        </p>
        <button class="btn btn-secondary" style="width:100%; height:40px; font-size:13px;">Adjust Now &rarr;</button>
      </div>

      <!-- Cycle Count -->
      <div class="card-soft clickable-stat-card" onclick="window.location.href='inventory_count.html'"
        style="padding:24px;">
        <div class="action-icon-box" style="background:#dbeafe; color:#2563eb;">üìã</div>
        <h3 style="margin:0 0 8px; font-size:16px;">Cycle Count</h3>
        <p style="font-size:13px; color:#64748b; margin:0 0 20px;">Verify physical stock accuracy by zone or category.
        </p>
        <button class="btn btn-secondary" style="width:100%; height:40px; font-size:13px;">Start Count &rarr;</button>
      </div>

    </div>

    <!-- Section 2: Search & Filter (Full Width) -->
    <div class="card-soft"
      style="padding:16px; margin-bottom:24px; display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="font-size:20px;">üîé</span>
        <strong style="font-size:14px; color:#1e293b;">Search</strong>
      </div>
      <div style="height:24px; width:1px; background:#e2e8f0; display:none; @media(min-width:600px){display:block;}">
      </div>

      <div style="flex:1; position:relative;">
        <input class="input" id="searchDel" placeholder="Search deliveries, SKUs, or POs..."
          oninput="renderDeliveries()"
          style="background:#f8fafc; border:1px solid #e2e8f0; height:44px; padding-left:16px; width:100%;">
      </div>

      <div style="display:flex; gap:8px;">
        <button class="btn btn-secondary" style="height:44px; font-size:13px; padding:0 16px;">Filter ‚ñæ</button>
      </div>
    </div>

    <!-- Bottom Section: Table & Sidebar -->
    <div class="grid grid-2" style="align-items:start;">

      <!-- Table -->
      <div class="card-soft table-container"
        style="padding:0; overflow:hidden; grid-column: span 2; @media(min-width: 1100px){ grid-column: auto; }">
        <div
          style="padding:20px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
          <h2
            style="font-size:14px; font-weight:700; color:#64748b; margin:0; text-transform:uppercase; letter-spacing:0.5px;"
            id="tableTitle">Upcoming Deliveries</h2>
          <button class="btn btn-secondary" style="height:32px; font-size:11px; padding:0 12px; display:none;"
            id="backToDel" onclick="setFilter('del')">Back to Deliveries</button>
        </div>

        <div class="table-container" style="box-shadow:none; border:none; border-radius:0;">
          <table id="mainTable">
            <thead>
              <tr
                style="background:#f8fafc; text-transform:uppercase; font-size:11px; letter-spacing:0.8px; color:#64748b;">
                <th style="padding:16px 24px; border-bottom:1px solid #e2e8f0;">Details</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0;">Reference</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0;">Source</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0;">Metric 1</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0;">Status</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0;">Action</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Sidebar -->
      <div
        style="display:grid; gap:24px; align-content:start; display:none; @media(min-width: 1100px){ display:grid; }">

        <!-- Stock Health -->
        <div class="card-soft" style="padding:24px;">
          <h3
            style="margin:0 0 24px; font-size:14px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">
            Portfolio Health</h3>

          <div style="margin-bottom:24px; text-align:center;">
            <div class="donut-chart" id="stockChart">
              <div class="donut-hole">
                <span style="font-size:24px; font-weight:800; color:#1e293b;" id="kTotalSide">‚Äî</span>
                <span style="font-size:10px; color:#94a3b8; font-weight:700; letter-spacing:0.5px;">ITEMS</span>
              </div>
            </div>
          </div>

          <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:24px; padding:0 8px;">
            <div style="text-align:center;">
              <div style="width:8px; height:8px; background:var(--success); border-radius:50%; margin:0 auto 6px;">
              </div>
              <div style="color:#64748b; margin-bottom:2px;">Healthy</div>
              <strong id="valGood" style="color:#1e293b; font-size:14px;">-</strong>
            </div>
            <div style="text-align:center;">
              <div style="width:8px; height:8px; background:var(--warning); border-radius:50%; margin:0 auto 6px;">
              </div>
              <div style="color:#64748b; margin-bottom:2px;">Reorder</div>
              <strong id="valLow" style="color:#1e293b; font-size:14px;">-</strong>
            </div>
            <div style="text-align:center;">
              <div style="width:8px; height:8px; background:var(--danger); border-radius:50%; margin:0 auto 6px;"></div>
              <div style="color:#64748b; margin-bottom:2px;">Empty</div>
              <strong id="valOos" style="color:#1e293b; font-size:14px;">-</strong>
            </div>
          </div>

          <button class="btn" onclick="openItemModal()"
            style="width:100%; background:linear-gradient(135deg, #10b981, #059669); color:white; border:none; font-weight:600; padding:0 12px; height:44px; border-radius:12px; box-shadow:0 4px 12px rgba(16, 185, 129, 0.3);">
            + Add Item
          </button>
        </div>

        <!-- Quick Links -->
        <div class="card-soft" style="padding:20px;">
          <div class="row-actions" style="opacity:1; transform:none; flex-direction:column; gap:8px;">
            <a href="reports.html"
              style="display:block; padding:12px; background:#f8fafc; border-radius:8px; text-decoration:none; color:#475569; font-size:13px; font-weight:600;">&rarr;
              Inventory Reports</a>
            <a href="logistics.html"
              style="display:block; padding:12px; background:#f8fafc; border-radius:8px; text-decoration:none; color:#475569; font-size:13px; font-weight:600;">&rarr;
              Track Inbound</a>
          </div>
        </div>

      </div>

    </div>

    <div style="margin-top:40px; text-align:center; color:var(--text-muted); font-size:13px;">
      &copy; 2026 Stark Premium ERP. secure. fast. reliable.
    </div>

  </main>

  <!-- Modals -->
  <div class="mobile-nav" id="receiveModal" style="z-index:900; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px);">
    <div class="card-soft"
      style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:min(90%, 500px); padding:24px; box-shadow:0 20px 40px rgba(0,0,0,0.2);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0; font-size:18px;">Receive Inventory</h3>
        <button onclick="closeReceiveModal()"
          style="border:none; background:transparent; font-size:24px; cursor:pointer; color:#94a3b8;">&times;</button>
      </div>
      <div style="display:grid; gap:16px;">
        <select id="rPo" class="input" style="background:#f8fafc; border:1px solid #e2e8f0;">
          <option value="">Select Purchase Order...</option>
        </select>
        <div
          style="text-align:center; padding:10px; background:#f1f5f9; border-radius:8px; color:var(--text-muted); font-size:12px; font-weight:700;">
          OR
        </div>
        <select id="rMetaItem" class="input" style="background:#f8fafc; border:1px solid #e2e8f0;">
          <!-- Filled by items -->
        </select>
        <input id="rQty" type="number" class="input" placeholder="Quantity Received"
          style="background:#f8fafc; border:1px solid #e2e8f0;">

        <button class="btn btn-primary" onclick="doReceive()">Process Receipt</button>
      </div>
    </div>
  </div>

  <div class="mobile-nav" id="adjustModal" style="z-index:900; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px);">
    <div class="card-soft"
      style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:min(90%, 500px); padding:24px; box-shadow:0 20px 40px rgba(0,0,0,0.2);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0; font-size:18px;">Adjust Stock</h3>
        <button onclick="closeAdjustModal()"
          style="border:none; background:transparent; font-size:24px; cursor:pointer; color:#94a3b8;">&times;</button>
      </div>
      <div style="display:grid; gap:16px;">
        <select id="aItem" class="input" style="background:#f8fafc; border:1px solid #e2e8f0;"></select>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <input id="aQty" type="number" class="input" placeholder="Qty Change (+/-)"
            style="background:#f8fafc; border:1px solid #e2e8f0;">
          <select id="aReason" class="input" style="background:#f8fafc; border:1px solid #e2e8f0;">
            <option>Damaged</option>
            <option>Lost/Stolen</option>
            <option>Found</option>
            <option>Correction</option>
          </select>
        </div>
        <button class="btn btn-warning" style="background:var(--warning); color:white; border:none;"
          onclick="doAdjust()">Apply Adjustment</button>
      </div>
    </div>
  </div>

  <div class="mobile-nav" id="countModal" style="z-index:900; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px);">
    <div class="card-soft"
      style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:min(90%, 500px); max-height:80vh; overflow-y:auto; padding:24px; box-shadow:0 20px 40px rgba(0,0,0,0.2);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0; font-size:18px;">Cycle Count Session</h3>
        <button onclick="closeCountModal()"
          style="border:none; background:transparent; font-size:24px; cursor:pointer; color:#94a3b8;">&times;</button>
      </div>
      <p style="font-size:13px; color:#64748b; margin-bottom:16px;">Please verify physical counts for the following
        randomly selected items:</p>
      <div id="countList" style="display:grid; gap:12px; margin-bottom:20px;"></div>
      <button class="btn btn-primary" onclick="doCycleCount()">Submit Counts</button>
    </div>
  </div>

  <div class="mobile-nav" id="itemModal" style="z-index:900; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px);">
    <div class="card-soft"
      style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:min(90%, 600px); max-height:90vh; overflow-y:auto; padding:24px; box-shadow:0 20px 40px rgba(0,0,0,0.2);">
      <div
        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:12px; border-bottom:1px solid #f1f5f9;">
        <h3 style="margin:0; font-size:18px;">Add Inventory Item</h3>
        <button onclick="closeItemModal()"
          style="border:none; background:transparent; font-size:24px; cursor:pointer; color:#94a3b8;">&times;</button>
      </div>
      <div style="display:grid; gap:16px;">
        <div style="display:grid; grid-template-columns:1fr 2fr; gap:16px;">
          <input id="iSku" class="input" placeholder="SKU (e.g. A-101)"
            style="background:#f8fafc; border:1px solid #e2e8f0;">
          <input id="iName" class="input" placeholder="Item Name" style="background:#f8fafc; border:1px solid #e2e8f0;">
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <input id="iCat" class="input" placeholder="Category" style="background:#f8fafc; border:1px solid #e2e8f0;">
          <input id="iWh" class="input" placeholder="Warehouse" style="background:#f8fafc; border:1px solid #e2e8f0;">
        </div>
        <input id="iSup" class="input" placeholder="Supplier" style="background:#f8fafc; border:1px solid #e2e8f0;">
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px;">
          <div>
            <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase;">On Hand</label>
            <input id="iOn" class="input" type="number" style="background:#f8fafc; border:1px solid #e2e8f0;">
          </div>
          <div>
            <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase;">Reorder Pt</label>
            <input id="iRop" class="input" type="number" style="background:#f8fafc; border:1px solid #e2e8f0;">
          </div>
          <div>
            <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase;">Unit Cost</label>
            <input id="iCost" class="input" type="number" step="0.01"
              style="background:#f8fafc; border:1px solid #e2e8f0;">
          </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px;">
          <button class="btn btn-secondary" onclick="closeItemModal()">Cancel</button>
          <button class="btn btn-primary" onclick="addItem()">Save Item</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toastWrap" style="position:fixed; bottom:20px; right:20px; z-index:9999; display:grid; gap:10px;"></div>

  <script src="erp.js"></script>
  <script>
    const AUTH_KEY = "stark_erp_auth_v1";
    (function () { try { const a = JSON.parse(localStorage.getItem(AUTH_KEY) || "null"); if (!a || !a.user) window.location.href = "index.html"; } catch { window.location.href = "index.html"; } })();

    const ITEM_KEY = "stark_erp_items_v2";
    const PO_KEY = "stark_erp_pos_v1";
    let CURRENT_FILTER = "all"; // all, low, oos, val, del

    function load(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch { return fallback; }
    }
    function save(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
    function money(n) { return Number(n || 0).toLocaleString(undefined, { style: "currency", currency: "USD" }); }

    // --- Modal Logic ---
    function openReceiveModal() { populateSelects(); document.getElementById("receiveModal").classList.add("open"); }
    function closeReceiveModal() { document.getElementById("receiveModal").classList.remove("open"); }
    function openAdjustModal() { populateSelects(); document.getElementById("adjustModal").classList.add("open"); }
    function closeAdjustModal() { document.getElementById("adjustModal").classList.remove("open"); }
    function openCountModal() { generateCountList(); document.getElementById("countModal").classList.add("open"); }
    function closeCountModal() { document.getElementById("countModal").classList.remove("open"); }
    function openItemModal() { document.getElementById("itemModal").classList.add("open"); }
    function closeItemModal() { document.getElementById("itemModal").classList.remove("open"); }

    // --- Core Logic ---
    function populateSelects() {
      const items = load(ITEM_KEY, []);
      const pos = load(PO_KEY, []);
      const itemOpts = `<option value="">Select Item...</option>` + items.map(i => `<option value="${i.sku}">${i.sku} - ${i.name} (Cur: ${i.on})</option>`).join("");
      document.getElementById("aItem").innerHTML = itemOpts;
      document.getElementById("rMetaItem").innerHTML = itemOpts;
      const poOpts = `<option value="">Select Purchase Order...</option>` + pos.filter(p => p.status !== "Completed").map(p => `<option value="${p.id}">${p.id} - ${p.vendor} (ETA: ${p.eta})</option>`).join("");
      document.getElementById("rPo").innerHTML = poOpts;
    }

    function doReceive() {
      const poId = document.getElementById("rPo").value;
      const sku = document.getElementById("rMetaItem").value;
      const qty = Number(document.getElementById("rQty").value);
      if (!qty || qty <= 0) return toast("Error", "Valid quantity required.", "error");
      const list = load(ITEM_KEY, []);
      if (poId) {
        const pos = load(PO_KEY, []);
        const p = pos.find(x => x.id === poId);
        if (p) {
          p.status = "Completed"; save(PO_KEY, pos);
          if (list.length) { list[0].on += qty; save(ITEM_KEY, list); }
          toast("Success", `Received against ${poId}.`, "success");
        }
      } else if (sku) {
        const item = list.find(x => x.sku === sku);
        if (item) { item.on += qty; save(ITEM_KEY, list); toast("Success", `Received ${sku}.`, "success"); }
      }
      closeReceiveModal();
      // Refresh current view
      setFilter(CURRENT_FILTER);
    }

    function doAdjust() {
      const sku = document.getElementById("aItem").value;
      const qty = Number(document.getElementById("aQty").value);
      if (!sku || !qty) return toast("Error", "Required fields missing.", "error");
      const list = load(ITEM_KEY, []);
      const item = list.find(x => x.sku === sku);
      if (item) {
        item.on += qty; save(ITEM_KEY, list);
        toast("Success", "Stock adjusted.", "success");
        closeAdjustModal();
        setFilter(CURRENT_FILTER);
      }
    }

    function generateCountList() {
      const items = load(ITEM_KEY, []);
      if (!items.length) return document.getElementById("countList").innerHTML = "No items.";
      const subset = items.sort(() => 0.5 - Math.random()).slice(0, 3);
      const html = subset.map(i => `
            <div style="background:#f8fafc; padding:12px; border-radius:8px; border:1px solid #e2e8f0;">
                 <div style="font-weight:600; font-size:13px; color:#1e293b;">${i.sku} - ${i.name}</div>
                 <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                     <span style="font-size:12px; color:#64748b;">System: ${i.on}</span>
                     <input class="input" style="width:100px; height:32px; font-size:13px; background:white;" placeholder="Actual" type="number" />
                 </div>
            </div>`).join("");
      document.getElementById("countList").innerHTML = html;
    }

    function doCycleCount() { toast("Success", "Counts submitted.", "success"); closeCountModal(); }

    function addItem() {
      const sku = (document.getElementById("iSku").value || "").trim();
      const name = (document.getElementById("iName").value || "").trim();
      if (!sku || !name) return toast("Error", "SKU/Name required.", "error");
      const item = {
        sku, name,
        cat: (document.getElementById("iCat").value || "").trim() || "General",
        wh: (document.getElementById("iWh").value || "").trim() || "WH-A",
        sup: (document.getElementById("iSup").value || "").trim() || "Vendor",
        on: Number(document.getElementById("iOn").value || 0),
        rop: Number(document.getElementById("iRop").value || 0),
        cost: Number(document.getElementById("iCost").value || 0)
      };
      const list = load(ITEM_KEY, []);
      list.unshift(item); save(ITEM_KEY, list);
      closeItemModal(); toast("Success", "Item added.", "success");
      setFilter(CURRENT_FILTER);
    }

    // --- Views ---
    function setFilter(type) {
      CURRENT_FILTER = type;
      // visual state
      document.querySelectorAll(".clickable-stat-card").forEach(el => el.classList.remove("active"));

      // We don't strictly have kpiAll enabled as active class targets, but let's add checking
      if (type === 'all') document.getElementById("kpiAll").classList.add("active");
      if (type === 'low') document.getElementById("kpiLow").classList.add("active");
      if (type === 'oos') document.getElementById("kpiOos").classList.add("active");
      if (type === 'val') document.getElementById("kpiVal").classList.add("active");

      // Render shared components
      renderStock();

      if (type === 'del') {
        renderDeliveries();
      } else {
        renderInventoryTable();
      }
    }

    function renderInventoryTable() {
      document.getElementById("tableTitle").textContent = (CURRENT_FILTER === 'all' ? "All Items" : (CURRENT_FILTER === 'low' ? "Low Stock Items" : (CURRENT_FILTER === 'oos' ? "Out of Stock" : "Inventory Valuation")));
      // Use display:block only if we were previously showing deliveries
      document.getElementById("backToDel").style.display = "none";

      const list = load(ITEM_KEY, []);
      let shown = list;

      if (CURRENT_FILTER === 'low') shown = list.filter(i => i.on <= i.rop && i.on > 0);
      if (CURRENT_FILTER === 'oos') shown = list.filter(i => i.on <= 0);
      if (CURRENT_FILTER === 'val') shown = [...list].sort((a, b) => (b.on * b.cost) - (a.on * a.cost));

      const table = document.getElementById("mainTable");

      // Switch Header
      table.querySelector("thead").innerHTML = `
            <tr style="background:#f8fafc; text-transform:uppercase; font-size:11px; letter-spacing:0.8px; color:#64748b;">
                <th style="padding:16px 24px; border-bottom:1px solid #e2e8f0;">SKU</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0;">Name</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0;">Category</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0; text-align:right;">On Hand</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0; text-align:right;">Cost</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0; text-align:right;">Value</th>
            </tr>
        `;

      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";

      if (!shown.length) return tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:24px; color:#64748b;">No items found.</td></tr>`;

      shown.forEach((i, index) => {
        const val = i.on * i.cost;
        let skuStyle = "font-weight:700; color:#1e293b;";
        if (i.on <= 0) skuStyle += " color:#dc2626;";
        else if (i.on <= i.rop) skuStyle += " color:#d97706;";

        const tr = document.createElement("tr");
        tr.className = "master-row";
        tr.style.cursor = "pointer";
        tr.style.borderBottom = "1px solid #f1f5f9";

        tr.innerHTML = `
                <td style="padding:16px 24px; ${skuStyle}">${i.sku}</td>
                <td style="padding:16px; color:#334155;">${i.name}</td>
                <td style="padding:16px; color:#475569;">${i.cat}</td>
                <td style="padding:16px; text-align:right;"><strong>${i.on}</strong> <span style="font-size:11px; color:#94a3b8;">(ROP: ${i.rop})</span></td>
                <td style="padding:16px; text-align:right; font-variant-numeric:tabular-nums;">${money(i.cost)}</td>
                <td style="padding:16px; text-align:right; font-variant-numeric:tabular-nums; font-weight:600; color:#059669;">${money(val)}</td>
           `;
        tbody.appendChild(tr);
      });
    }

    function renderStock() {
      const items = load(ITEM_KEY, []);

      // Calculate Stats
      const low = items.filter(i => i.on <= i.rop && i.on > 0).length;
      const oos = items.filter(i => i.on <= 0).length;
      const good = items.length - low - oos;
      const val = items.reduce((acc, i) => acc + (i.on * i.cost), 0);

      // Update Top Stats
      document.getElementById("kTotal").textContent = items.length;
      document.getElementById("kLow").textContent = low;
      document.getElementById("kOOS").textContent = oos;
      document.getElementById("kValue").textContent = money(val);

      // Update Sidebar Chart
      if (document.getElementById("kTotalSide")) {
        document.getElementById("kTotalSide").textContent = items.length;
        document.getElementById("valGood").textContent = good;
        document.getElementById("valLow").textContent = low;
        document.getElementById("valOos").textContent = oos;

        // Calculate Degrees
        const total = items.length || 1;
        const degGood = (good / total) * 360;
        const degLow = (low / total) * 360;
        const degOos = (oos / total) * 360;

        const chart = document.getElementById("stockChart");
        if (chart) {
          chart.style.background = `conic-gradient(
                var(--success) 0deg ${degGood}deg, 
                var(--warning) ${degGood}deg ${degGood + degLow}deg, 
                var(--danger) ${degGood + degLow}deg 360deg
            )`;
        }
      }
    }

    function renderDeliveries() {
      // Switch Title
      document.getElementById("tableTitle").textContent = "Incoming Deliveries";
      document.getElementById("backToDel").style.display = "none";

      const pos = load(PO_KEY, []);
      const active = pos.filter(p => p.status !== "Completed" && p.status !== "Delivered");
      active.sort((a, b) => new Date(a.eta) - new Date(b.eta));

      const table = document.getElementById("mainTable");

      // Header
      table.querySelector("thead").innerHTML = `
            <tr style="background:#f8fafc; text-transform:uppercase; font-size:11px; letter-spacing:0.8px; color:#64748b;">
                <th style="padding:16px 24px; border-bottom:1px solid #e2e8f0;">ETA</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0;">PO #</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0;">Vendor</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0;">Items</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0;">Status</th>
                <th style="padding:16px; border-bottom:1px solid #e2e8f0; text-align:right;">Action</th>
            </tr>
      `;

      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";

      if (!active.length) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:24px; color:#64748b;">No pending deliveries.</td></tr>`;
        return;
      }

      const q = (document.getElementById("searchDel").value || "").toLowerCase();

      active.forEach(p => {
        if (q && !JSON.stringify(p).toLowerCase().includes(q)) return;

        const tr = document.createElement("tr");
        tr.className = "master-row";
        tr.style.borderBottom = "1px solid #f1f5f9";
        tr.innerHTML = `
            <td style="padding:16px 24px; font-weight:600; color:#1e293b;">${p.eta}</td>
            <td style="padding:16px; color:#6366f1;">${p.id}</td>
            <td style="padding:16px; color:#475569;">${p.vendor}</td>
            <td style="padding:16px;">${(p.items || []).length} items</td>
            <td style="padding:16px;"><span class="badge badge-yellow">${p.status}</span></td>
            <td style="padding:16px; text-align:right;">
                <button class="btn btn-primary" onclick="openReceiveModal()" style="height:28px; font-size:11px; padding:0 12px; border-radius:6px;">Receive</button>
            </td>
          `;
        tbody.appendChild(tr);
      });
    }

    // Init
    setFilter('del'); // Default view
    renderStock();

  </script>
</body>

</html>
