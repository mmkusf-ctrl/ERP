<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inventory | Stark Premium ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="erp.css">
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="logo"><img src="images/stark-logo.png" alt="Stark Premium" /></div>

      <button class="hamburger" type="button" aria-label="Open menu" onclick="openMobileNav()">
        <span></span><span></span><span></span>
      </button>

      <nav class="nav" aria-label="ERP Navigation">
        <a href="dashboard.html">Home</a>
        <a href="account.html">Account</a>
        <a href="crm.html">CRM</a>
        <a href="inventory.html" class="active">Inventory</a>
        <a href="orders.html">Orders</a>
        <a href="logistics.html">Logistics</a>
        <a href="trends.html">Trends</a>
      </nav>

      <div class="top-actions">
        <div class="pill"><span class="dot"></span>Online</div>
        <button class="btn secondary" onclick="window.location.href='trends.html'">Trends</button>
        <button class="btn" onclick="openPOModal()">Create PO</button>
      </div>
    </div>
  </header>

  <div class="mobile-nav" id="mobileNav" aria-hidden="true">
    <div class="mobile-card">
      <div class="mobile-head">
        <strong>Menu</strong>
        <button class="mobile-close" type="button" aria-label="Close menu" onclick="closeMobileNav()">×</button>
      </div>
      <div class="mobile-links">
        <a href="dashboard.html">Home</a>
        <a href="account.html">Account</a>
        <a href="crm.html">CRM</a>
        <a class="active" href="inventory.html">Inventory</a>
        <a href="orders.html">Orders</a>
        <a href="logistics.html">Logistics</a>
        <a href="trends.html">Trends</a>
      </div>
    </div>
  </div>

  <main class="wrap">
    <div class="hero">
      <h1 class="h-title">Inventory</h1>
      <p class="h-sub">Manage SKU master data, reorder control, stock visibility, and purchase orders — modern & premium.</p>
      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn secondary" onclick="loadDemoItems()">Load Demo Data</button>
        <button class="btn" onclick="openItemModal()">Add Item</button>
      </div>
      <div class="toast-wrap" id="toastWrap"></div>
    </div>

    <section class="kpis">
      <div class="card">
        <div class="card-top"><div class="label">Trends</div><div class="chip good">Reactive</div></div>
        <div class="value" id="kTrends">—</div>
        <div class="sub">Track SKU performance in Trends</div>
      </div>

      <div class="card">
        <div class="card-top"><div class="label">Low stock</div><div class="chip warn">Reorder</div></div>
        <div class="value" id="kLow">0</div>
        <div class="sub">At / below reorder point</div>
      </div>

      <div class="card">
        <div class="card-top"><div class="label">Out of stock</div><div class="chip bad">Urgent</div></div>
        <div class="value" id="kOOS">0</div>
        <div class="sub">Immediate replenishment needed</div>
      </div>

      <div class="card">
        <div class="card-top"><div class="label">Inventory value</div><div class="chip good">Cost basis</div></div>
        <div class="value" id="kValue">$0.00</div>
        <div class="sub">On-hand × unit cost</div>
      </div>
    </section>

    <section class="section">
      <h2>Item Master</h2>
      <div class="goldline"></div>

      <div class="controls">
        <input id="q" class="input" placeholder="Search SKU / item / supplier..." oninput="renderItems()">
        <select id="catF" onchange="renderItems()"></select>
        <select id="whF" onchange="renderItems()"></select>
        <select id="supF" onchange="renderItems()"></select>
      </div>

      <div class="table-wrap" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>SKU</th>
              <th>Item</th>
              <th>Category</th>
              <th>Warehouse</th>
              <th>Supplier</th>
              <th>On hand</th>
              <th>ROP</th>
              <th>Unit cost</th>
              <th>Value</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="itemBody"></tbody>
        </table>
      </div>
    </section>

    <section class="section" id="po">
      <h2>Vendor Purchase Orders</h2>
      <div class="goldline"></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>PO</th>
              <th>Vendor</th>
              <th>Warehouse</th>
              <th>Lines</th>
              <th>Status</th>
              <th>ETA</th>
            </tr>
          </thead>
          <tbody id="poBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Add Item Modal -->
  <div class="modal" id="itemModal">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Add Inventory Item</h3>
        <button class="x" onclick="closeItemModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="controls">
          <input id="iSku" class="input" placeholder="SKU (required)" />
          <input id="iName" class="input" placeholder="Item name (required)" />
          <input id="iCat" class="input" placeholder="Category (e.g., Packaging)" />
          <input id="iWh" class="input" placeholder="Warehouse (e.g., WH-A)" />
        </div>
        <div class="controls" style="margin-top:10px;">
          <input id="iSup" class="input" placeholder="Supplier (e.g., PackPro)" />
          <input id="iOn" class="input" placeholder="On-hand" type="number" />
          <input id="iRop" class="input" placeholder="Reorder point" type="number" />
          <input id="iCost" class="input" placeholder="Unit cost" type="number" step="0.01" />
        </div>
      </div>
      <div class="modal-head" style="border-top:1px solid rgba(11,18,32,0.10);">
        <div style="color:#667085;font-size:12px;">Saved to localStorage</div>
        <div style="display:flex;gap:10px;">
          <button class="btn secondary" onclick="closeItemModal()">Cancel</button>
          <button class="btn" onclick="addItem()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create PO Modal -->
  <div class="modal" id="poModal">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Create Purchase Order</h3>
        <button class="x" onclick="closePOModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="controls">
          <input id="pVendor" class="input" placeholder="Vendor (required)" />
          <input id="pWh" class="input" placeholder="Warehouse (e.g., WH-A)" />
          <input id="pEta" class="input" type="date" />
          <select id="pStatus">
            <option>Open</option>
            <option>Awaiting approval</option>
            <option>Confirmed</option>
            <option>Delayed</option>
          </select>
        </div>
        <div style="margin-top:10px;">
          <textarea id="pLines" placeholder="PO lines (one per line): SKU,Qty   Example: BX-9001,100"></textarea>
        </div>
      </div>
      <div class="modal-head" style="border-top:1px solid rgba(11,18,32,0.10);">
        <div style="color:#667085;font-size:12px;">Saved to localStorage</div>
        <div style="display:flex;gap:10px;">
          <button class="btn secondary" onclick="closePOModal()">Cancel</button>
          <button class="btn" onclick="createPO()">Create</button>
        </div>
      </div>
    </div>
  </div>

  <script src="erp.js"></script>
  <script>
    requireAuth();
    setActiveNav("inventory.html");

    const ITEM_KEY = "stark_erp_items_v2";
    const PO_KEY   = "stark_erp_pos_v1";

    function load(key, fallback){
      try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch { return fallback; }
    }
    function save(key, data){ localStorage.setItem(key, JSON.stringify(data)); }
    function money(n){
      const v = Number(n||0);
      return v.toLocaleString(undefined,{style:"currency",currency:"USD"});
    }

    function openItemModal(){ document.getElementById("itemModal").classList.add("open"); }
    function closeItemModal(){ document.getElementById("itemModal").classList.remove("open"); }
    function openPOModal(){ document.getElementById("poModal").classList.add("open"); }
    function closePOModal(){ document.getElementById("poModal").classList.remove("open"); }

    function loadDemoItems(){
      const demo = [
        { sku:"BX-9001", name:"Premium Gift Box", cat:"Packaging", wh:"WH-A", sup:"PackPro", on:140, rop:50, cost:1.60 },
        { sku:"LB-3001", name:"Luxury Label Set", cat:"Packaging", wh:"WH-A", sup:"PackPro", on:18, rop:25, cost:0.75 },
        { sku:"NK-1001", name:"Necklace — Aurora", cat:"Finished Goods", wh:"WH-B", sup:"Stark Mfg", on:62, rop:30, cost:42.00 },
        { sku:"RG-2001", name:"Ring — Obsidian", cat:"Finished Goods", wh:"WH-B", sup:"Stark Mfg", on:0, rop:18, cost:38.00 },
        { sku:"ER-4040", name:"Earrings — Halo", cat:"Finished Goods", wh:"WH-B", sup:"Stark Mfg", on:24, rop:20, cost:16.50 }
      ];
      save(ITEM_KEY, demo);
      toast("Loaded demo", "Inventory demo items loaded.");
      renderItems(); renderKpis();
    }

    function addItem(){
      const sku = (document.getElementById("iSku").value||"").trim();
      const name = (document.getElementById("iName").value||"").trim();
      if(!sku || !name) return toast("Missing fields", "SKU and Item name are required.");

      const item = {
        sku,
        name,
        cat: (document.getElementById("iCat").value||"").trim() || "General",
        wh: (document.getElementById("iWh").value||"").trim() || "WH-A",
        sup: (document.getElementById("iSup").value||"").trim() || "Vendor",
        on: Number(document.getElementById("iOn").value||0),
        rop: Number(document.getElementById("iRop").value||0),
        cost: Number(document.getElementById("iCost").value||0)
      };

      const list = load(ITEM_KEY, []);
      if(list.some(x => (x.sku||"").toUpperCase() === sku.toUpperCase())){
        return toast("Duplicate SKU", "This SKU already exists.");
      }
      list.unshift(item);
      save(ITEM_KEY, list);
      closeItemModal();
      toast("Item added", `${sku} saved.`);
      renderItems(); renderKpis();
    }

    function createPO(){
      const vendor = (document.getElementById("pVendor").value||"").trim();
      if(!vendor) return toast("Missing field", "Vendor is required.");

      const po = {
        id: "PO-" + Math.floor(1000 + Math.random()*9000),
        vendor,
        wh: (document.getElementById("pWh").value||"").trim() || "WH-A",
        eta: (document.getElementById("pEta").value||"").trim(),
        status: document.getElementById("pStatus").value,
        lines: (document.getElementById("pLines").value||"").trim(),
        createdAt: Date.now()
      };

      const list = load(PO_KEY, []);
      list.unshift(po);
      save(PO_KEY, list);
      closePOModal();
      toast("PO created", `${po.id} saved.`);
      renderPOs();
    }

    function renderFilters(items){
      const cats = Array.from(new Set(items.map(x=>x.cat))).sort();
      const whs  = Array.from(new Set(items.map(x=>x.wh))).sort();
      const sups = Array.from(new Set(items.map(x=>x.sup))).sort();

      const catF = document.getElementById("catF");
      const whF  = document.getElementById("whF");
      const supF = document.getElementById("supF");

      if(!catF.dataset.init){
        catF.innerHTML = `<option value="">All categories</option>` + cats.map(c=>`<option>${escapeHtml(c)}</option>`).join("");
        whF.innerHTML  = `<option value="">All warehouses</option>` + whs.map(w=>`<option>${escapeHtml(w)}</option>`).join("");
        supF.innerHTML = `<option value="">All suppliers</option>` + sups.map(s=>`<option>${escapeHtml(s)}</option>`).join("");
        catF.dataset.init="1";
      }
    }

    function renderKpis(){
      const items = load(ITEM_KEY, []);
      const low = items.filter(i => Number(i.on) <= Number(i.rop) && Number(i.on) > 0).length;
      const oos = items.filter(i => Number(i.on) <= 0).length;
      const val = items.reduce((sum,i)=> sum + (Number(i.on)||0)*(Number(i.cost)||0), 0);

      document.getElementById("kLow").textContent = String(low);
      document.getElementById("kOOS").textContent = String(oos);
      document.getElementById("kValue").textContent = money(val);

      const skuCount = items.length;
      document.getElementById("kTrends").textContent = skuCount ? `${skuCount} SKUs` : "—";
    }

    function renderItems(){
      const items = load(ITEM_KEY, []);
      renderFilters(items);

      const q = (document.getElementById("q").value||"").toLowerCase().trim();
      const cat = document.getElementById("catF").value || "";
      const wh  = document.getElementById("whF").value || "";
      const sup = document.getElementById("supF").value || "";

      let list = items.slice();
      if(q){
        list = list.filter(i =>
          (i.sku||"").toLowerCase().includes(q) ||
          (i.name||"").toLowerCase().includes(q) ||
          (i.sup||"").toLowerCase().includes(q)
        );
      }
      if(cat) list = list.filter(i => i.cat === cat);
      if(wh)  list = list.filter(i => i.wh === wh);
      if(sup) list = list.filter(i => i.sup === sup);

      const tbody = document.getElementById("itemBody");
      tbody.innerHTML = "";

      if(list.length === 0){
        tbody.innerHTML = `<tr><td colspan="10" style="color:#667085;">No items found. Load demo data or add items.</td></tr>`;
        renderKpis();
        renderPOs();
        return;
      }

      for(const i of list){
        const on = Number(i.on)||0;
        const rop = Number(i.rop)||0;
        const cost = Number(i.cost)||0;
        const value = on*cost;

        let tag = `<span class="pilltag good">Healthy</span>`;
        if(on <= 0) tag = `<span class="pilltag bad">Out</span>`;
        else if(on <= rop) tag = `<span class="pilltag warn">Low</span>`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><strong>${escapeHtml(i.sku)}</strong></td>
          <td>${escapeHtml(i.name)}</td>
          <td>${escapeHtml(i.cat)}</td>
          <td>${escapeHtml(i.wh)}</td>
          <td>${escapeHtml(i.sup)}</td>
          <td>${on}</td>
          <td>${rop}</td>
          <td>${money(cost)}</td>
          <td>${money(value)}</td>
          <td>${tag}</td>
        `;
        tbody.appendChild(tr);
      }

      renderKpis();
      renderPOs();
    }

    function renderPOs(){
      const pos = load(PO_KEY, []);
      const tbody = document.getElementById("poBody");
      tbody.innerHTML = "";

      if(pos.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" style="color:#667085;">No purchase orders yet. Use “Create PO”.</td></tr>`;
        return;
      }

      for(const p of pos){
        const st = p.status || "Open";
        const chip = st.includes("Delayed") ? "bad" : (st.includes("Awaiting") ? "warn" : "good");
        const linesCount = (p.lines||"").trim() ? (p.lines.split("\n").filter(Boolean).length) : 0;
        const eta = p.eta ? new Date(p.eta).toLocaleDateString() : "—";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><strong>${escapeHtml(p.id)}</strong></td>
          <td>${escapeHtml(p.vendor)}</td>
          <td>${escapeHtml(p.wh)}</td>
          <td>${linesCount}</td>
          <td><span class="pilltag ${chip}">${escapeHtml(st)}</span></td>
          <td>${escapeHtml(eta)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    renderItems();
  </script>
</body>
</html>
