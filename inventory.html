<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Inventory | Stark Premium ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Card Hover & Icon Effects */
    /* KPI Horizontal Fix */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      /* Tighter gap */
    }

    @media (max-width: 768px) {
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .card-compact {
      padding: 16px !important;
      /* Smaller padding */
    }

    .card-compact .stat-value {
      font-size: 28px;
      /* Smaller font */
      margin-bottom: 4px;
    }

    .card-compact .card-header {
      margin-bottom: 12px;
    }

    /* Action Card Adjustment */
    .action-card {
      text-align: left;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 180px;
      /* Reduced height from 220px */
      padding: 20px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border);
    }

    .action-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
      border-color: var(--primary-light);
    }

    .action-card:hover .action-icon {
      transform: scale(1.15) rotate(8deg);
      opacity: 0.15;
    }

    .action-icon {
      position: absolute;
      bottom: -20px;
      right: -20px;
      font-size: 120px;
      /* Slightly smaller icon */
      opacity: 0.08;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      line-height: 1;
      color: var(--text-main);
      pointer-events: none;
    }

    /* Button Placement in Cards */
    .card-actions {
      margin-top: auto;
      padding-top: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* KPI Clickable Styles */
    .clickable-kpi {
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s;
    }

    .clickable-kpi:hover {
      transform: translateY(-2px);
      border-color: var(--primary);
    }

    .clickable-kpi.active {
      border-color: var(--primary);
      background: var(--bg-surface);
      box-shadow: 0 0 0 2px var(--primary-fade);
    }
  </style>
</head>

<body>
  <!-- Top Navigation -->
  <header class="topbar">
    <div class="topbar-inner">
      <a href="dashboard.html" class="logo">
        <img src="images/stark-logo.png" alt="Stark Premium">
        <span class="logo-text">Stark ERP</span>
      </a>

      <nav class="nav">
        <a class="nav-link" href="dashboard.html">Overview</a>
        <a class="nav-link" href="crm.html">CRM</a>
        <a class="nav-link" href="vendor.html">Vendor</a>
        <a class="nav-link" href="purchasing.html">Purchasing</a>
        <a class="nav-link active" href="inventory.html">Inventory</a>
        <a class="nav-link" href="accounting.html">Accounting</a>
        <a class="nav-link" href="orders.html">Orders</a>
        <a class="nav-link" href="logistics.html">Logistics</a>
        <a class="nav-link" href="reports.html">Reports</a>
        <a class="nav-link" href="events.html">Events</a>
      </nav>

      <div style="display:flex; align-items:center; gap:12px;">
        <div class="badge badge-green" style="display:none; @media(min-width:700px){display:inline-flex;}">
          Online
        </div>
        <button class="hamburger" onclick="openMobileNav()">
          <span></span><span></span><span></span>
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile Drawer -->
  <div class="mobile-nav" id="mobileNav">
    <div class="mobile-drawer">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <strong style="font-size:16px;">Navigation</strong>
        <button onclick="closeMobileNav()"
          style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
      </div>
      <a class="mobile-link" href="dashboard.html">Overview</a>
      <a class="mobile-link" href="crm.html">CRM</a>
      <a class="mobile-link" href="vendor.html">Vendor</a>
      <a class="mobile-link" href="purchasing.html">Purchasing</a>
      <a class="mobile-link active" href="inventory.html">Inventory</a>
      <a class="mobile-link" href="accounting.html">Accounting</a>
      <a class="mobile-link" href="orders.html">Orders</a>
      <a class="mobile-link" href="logistics.html">Logistics</a>
      <a class="mobile-link" href="trends.html">Trends</a>
    </div>
  </div>

  <main class="container">
    <!-- Header -->
    <div class="page-header" style="margin-bottom:24px;">
      <h1 class="page-title">Inventory Operations</h1>
      <p class="page-desc">Manage stock levels, process inbound shipments, and maintain accuracy.</p>
      <div class="gold-line"></div>
    </div>

    <!-- Top Section: Search & Stats -->
    <div class="grid"
      style="display:grid; grid-template-columns: 1fr 2fr; gap:24px; margin-bottom:24px; align-items:stretch;">

      <!-- Left: Search/Filter Panel -->
      <div class="card" style="display:flex; flex-direction:column; justify-content:center;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:16px;">
          <span style="font-size:18px; color:var(--success);">üì¶</span>
          <h3 style="margin:0; font-size:16px; font-weight:700; color:var(--text-main);">Upcoming Deliveries...</h3>
        </div>
        <div style="position:relative; margin-bottom:12px;">
          <input class="input" id="searchDel" placeholder="Search deliveries..." style="padding-right:32px;"
            oninput="renderDeliveries()">
          <span
            style="position:absolute; right:10px; top:50%; transform:translateY(-50%); color:var(--text-muted);">üîç</span>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-secondary"
            style="height:32px; font-size:12px; padding:0 12px; background:#f1f5f9; border:none;">ETA ‚ñæ</button>
          <button class="btn btn-secondary"
            style="height:32px; font-size:12px; padding:0 12px; background:#f1f5f9; border:none;">Vendor ‚ñæ</button>
          <button class="btn btn-secondary"
            style="height:32px; font-size:12px; padding:0 12px; background:#f1f5f9; border:none;">Status ‚ñæ</button>
        </div>
      </div>

      <!-- Right: Stats Panel -->
      <div class="card">
        <h3 style="margin:0 0 16px 0; font-size:16px; font-weight:700; color:var(--text-main);">Inventory Overview</h3>
        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:16px;">
          <!-- Total SKUs -->
          <div style="background:#f8fafc; padding:12px; border-radius:8px; border:1px solid var(--border);">
            <div style="font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">TOTAL SKUS
            </div>
            <div style="font-size:24px; font-weight:700; margin:4px 0;" id="kTotal">‚Äî</div>
            <div
              style="font-size:11px; background:#bfdbfe; color:#1e40af; padding:4px 8px; border-radius:4px; display:inline-block;">
              View All SKUs</div>
          </div>
          <!-- Low Stock -->
          <div style="background:#fff7ed; padding:12px; border-radius:8px; border:1px solid #fed7aa;">
            <div style="font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">LOW STOCK
            </div>
            <div style="font-size:24px; font-weight:700; margin:4px 0;" id="kLow">‚Äî</div>
            <div
              style="font-size:11px; background:#ffedd5; color:#9a3412; padding:4px 8px; border-radius:4px; display:inline-block;">
              Reorder Soon</div>
          </div>
          <!-- Out of Stock -->
          <div style="background:#fef2f2; padding:12px; border-radius:8px; border:1px solid #fecaca;">
            <div style="font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">OUT OF
              STOCK</div>
            <div style="font-size:24px; font-weight:700; margin:4px 0;" id="kOOS">‚Äî</div>
            <div
              style="font-size:11px; background:#fee2e2; color:#991b1b; padding:4px 8px; border-radius:4px; display:inline-block;">
              Restock Now</div>
          </div>
          <!-- Valuation -->
          <div style="background:#f0fdf4; padding:12px; border-radius:8px; border:1px solid #bbf7d0;">
            <div style="font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">VALUATION
            </div>
            <div style="font-size:20px; font-weight:700; margin:4px 0; word-break:break-all;" id="kValue">$0.00</div>
            <div
              style="font-size:11px; background:#dcfce7; color:#166534; padding:4px 8px; border-radius:4px; display:inline-block;">
              Total Cost Basis</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Middle Section: Actions -->
    <div class="grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:24px; margin-bottom:24px;">

      <!-- Receive -->
      <div class="card clickable-kpi" onclick="openReceiveModal()"
        style="background: linear-gradient(135deg, #ede9fe, #ddd6fe); border:1px solid #c4b5fd;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
          <span style="font-size:20px;">üì¶</span>
          <h3 style="margin:0; font-size:16px;">Receive Inventory</h3>
        </div>
        <p style="font-size:13px; color:#5b21b6; margin-bottom:16px;">Process specific items for all POs arrival.</p>
        <button class="btn"
          style="width:100%; background:#8b5cf6; color:white; border:none; display:flex; justify-content:space-between; align-items:center;">
          + Start Reception <span>&rarr;</span>
        </button>
      </div>

      <!-- Adjust -->
      <div class="card clickable-kpi" onclick="openAdjustModal()" style="background:#fffbeb; border:1px solid #fcd34d;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
          <h3 style="margin:0; font-size:16px; color:#92400e;">Adjust Stock</h3>
          <span style="font-size:20px;">‚öôÔ∏è</span>
        </div>
        <p style="font-size:13px; color:#92400e; margin-bottom:16px;">Manual adjustments for damage, loss, or extras.
        </p>
        <button class="btn"
          style="width:100%; background:transparent; border:1px solid #d97706; color:#92400e; display:flex; justify-content:space-between; align-items:center;">
          Adjust Now <span>&rarr;</span>
        </button>
      </div>

      <!-- Cycle Count -->
      <div class="card clickable-kpi" onclick="openCountModal()" style="background:#ecfeff; border:1px solid #a5f3fc;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
          <h3 style="margin:0; font-size:16px; color:#0e7490;">Cycle Count</h3>
          <span style="font-size:20px;">üìã</span>
        </div>
        <p style="font-size:13px; color:#0e7490; margin-bottom:16px;">Verify physical stock accuracy by zone.</p>
        <button class="btn"
          style="width:100%; background:transparent; border:1px solid #0891b2; color:#0e7490; display:flex; justify-content:space-between; align-items:center;">
          Start Count <span>&rarr;</span>
        </button>
      </div>

    </div>

    <!-- Bottom Section: Table & Sidebar -->
    <div class="grid" style="display:grid; grid-template-columns: 2.5fr 1fr; gap:24px; align-items:start;">

      <!-- Table -->
      <div class="card">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:20px;">
          <span style="font-size:18px; color:var(--success);">üì¶</span>
          <h2 style="font-size:16px; margin:0;">Upcoming Deliveries...</h2>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr
                style="background:#f8fafc; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--text-muted);">
                <th style="padding:12px;">ETA</th>
                <th style="padding:12px;">PO #</th>
                <th style="padding:12px;">Vendor</th>
                <th style="padding:12px;">Items</th>
                <th style="padding:12px;">Status</th>
                <th style="padding:12px;">Action</th>
              </tr>
            </thead>
            <tbody id="delBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="card" style="background:#f8fafc;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:16px;">
          <span style="font-size:16px; background:#dcfce7; padding:4px; border-radius:4px; color:#166534;">+</span>
          <h3 style="margin:0; font-size:16px;">Inventory Overview</h3>
        </div>

        <div
          style="background:white; padding:16px; border-radius:8px; border:1px solid var(--border); margin-bottom:16px;">
          <div
            style="font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase; display:flex; justify-content:space-between;">
            TOTAL SKUS <span style="font-size:14px;">&rsaquo;</span>
          </div>
          <div style="font-size:32px; font-weight:700; margin:4px 0;" id="kTotalSide">‚Äî</div>
          <div style="background:#ffedd5; padding:8px; border-radius:4px; margin-top:8px;">
            <div style="font-size:12px; font-weight:600; color:#9a3412;">Reorder Soon</div>
          </div>
        </div>

        <button class="btn" onclick="openItemModal()"
          style="width:100%; background:linear-gradient(to right, #6ee7b7, #3b82f6); color:white; border:none; font-weight:600; padding:12px;">
          Add New Item
        </button>
      </div>

    </div>

    <div style="margin-top:40px; text-align:center; color:var(--text-muted); font-size:13px;">
      &copy; 2026 Stark Premium ERP. secure. fast. reliable.
    </div>

  </main>

  <!-- Modals (Same as before) -->
  <div class="mobile-nav" id="receiveModal" style="z-index:900;">
    <div class="card"
      style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:min(90%, 500px); box-shadow:var(--shadow-card);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0;">Receive Inventory</h3>
        <button onclick="closeReceiveModal()"
          style="border:none; background:transparent; font-size:24px; cursor:pointer;">&times;</button>
      </div>
      <div style="display:grid; gap:16px;">
        <select id="rPo" class="input">
          <option value="">Select Purchase Order...</option>
        </select>
        <div
          style="text-align:center; padding:10px; background:#f8fafc; border-radius:8px; color:var(--text-muted); font-size:13px;">
          OR
        </div>
        <select id="rMetaItem" class="input"> <!-- Filled by items -->
        </select>
        <input id="rQty" type="number" class="input" placeholder="Quantity Received" />

        <button class="btn btn-primary" onclick="doReceive()">Process Receipt</button>
      </div>
    </div>
  </div>

  <div class="mobile-nav" id="adjustModal" style="z-index:900;">
    <div class="card"
      style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:min(90%, 500px); box-shadow:var(--shadow-card);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0;">Adjust Stock</h3>
        <button onclick="closeAdjustModal()"
          style="border:none; background:transparent; font-size:24px; cursor:pointer;">&times;</button>
      </div>
      <div style="display:grid; gap:16px;">
        <select id="aItem" class="input"></select>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <input id="aQty" type="number" class="input" placeholder="Qty Change (+/-)" />
          <select id="aReason" class="input">
            <option>Damaged</option>
            <option>Lost/Stolen</option>
            <option>Found</option>
            <option>Correction</option>
          </select>
        </div>
        <button class="btn btn-warning" style="background:var(--warning); color:white; border:none;"
          onclick="doAdjust()">Apply Adjustment</button>
      </div>
    </div>
  </div>

  <div class="mobile-nav" id="countModal" style="z-index:900;">
    <div class="card"
      style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:min(90%, 500px); max-height:80vh; overflow-y:auto; box-shadow:var(--shadow-card);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0;">Cycle Count Session</h3>
        <button onclick="closeCountModal()"
          style="border:none; background:transparent; font-size:24px; cursor:pointer;">&times;</button>
      </div>
      <p style="font-size:13px; color:var(--text-muted);">Please verify physical counts for the following randomly
        selected items:</p>
      <div id="countList" style="display:grid; gap:12px; margin-bottom:16px;"></div>
      <button class="btn btn-primary" onclick="doCycleCount()">Submit Counts</button>
    </div>
  </div>

  <div class="mobile-nav" id="itemModal" style="z-index:900;">
    <div class="card"
      style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:min(90%, 600px); max-height:90vh; overflow-y:auto; box-shadow:var(--shadow-card);">
      <div
        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:12px; border-bottom:1px solid var(--border);">
        <h3 style="margin:0;">Add Inventory Item</h3>
        <button onclick="closeItemModal()"
          style="border:none; bg:transparent; font-size:24px; cursor:pointer;">&times;</button>
      </div>
      <div style="display:grid; gap:16px;">
        <div style="display:grid; grid-template-columns:1fr 2fr; gap:16px;">
          <input id="iSku" class="input" placeholder="SKU (e.g. A-101)" />
          <input id="iName" class="input" placeholder="Item Name" />
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <input id="iCat" class="input" placeholder="Category" />
          <input id="iWh" class="input" placeholder="Warehouse" />
        </div>
        <input id="iSup" class="input" placeholder="Supplier" />
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px;">
          <div>
            <label style="font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">On
              Hand</label>
            <input id="iOn" class="input" type="number" />
          </div>
          <div>
            <label style="font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Reorder
              Pt</label>
            <input id="iRop" class="input" type="number" />
          </div>
          <div>
            <label style="font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Unit
              Cost</label>
            <input id="iCost" class="input" type="number" step="0.01" />
          </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px;">
          <button class="btn btn-secondary" onclick="closeItemModal()">Cancel</button>
          <button class="btn btn-primary" onclick="addItem()">Save Item</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toastWrap" style="position:fixed; bottom:20px; right:20px; z-index:9999; display:grid; gap:10px;"></div>

  <script src="erp.js"></script>
  <script>
    const AUTH_KEY = "stark_erp_auth_v1";
    (function () { try { const a = JSON.parse(localStorage.getItem(AUTH_KEY) || "null"); if (!a || !a.user) window.location.href = "index.html"; } catch { window.location.href = "index.html"; } })();

    const KEY_CUST = "stark_erp_customers_v1";
    (function () { try { const a = JSON.parse(localStorage.getItem(AUTH_KEY) || "null"); if (!a || !a.user) window.location.href = "index.html"; } catch { window.location.href = "index.html"; } })();

    const ITEM_KEY = "stark_erp_items_v2";
    const PO_KEY = "stark_erp_pos_v1";
    let CURRENT_FILTER = "all"; // all, low, oos

    function load(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch { return fallback; }
    }
    function save(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
    function money(n) { return Number(n || 0).toLocaleString(undefined, { style: "currency", currency: "USD" }); }

    // --- Modal Logic ---
    function openReceiveModal() { populateSelects(); document.getElementById("receiveModal").classList.add("open"); }
    function closeReceiveModal() { document.getElementById("receiveModal").classList.remove("open"); }
    function openAdjustModal() { populateSelects(); document.getElementById("adjustModal").classList.add("open"); }
    function closeAdjustModal() { document.getElementById("adjustModal").classList.remove("open"); }
    function openCountModal() { generateCountList(); document.getElementById("countModal").classList.add("open"); }
    function closeCountModal() { document.getElementById("countModal").classList.remove("open"); }
    function openItemModal() { document.getElementById("itemModal").classList.add("open"); }
    function closeItemModal() { document.getElementById("itemModal").classList.remove("open"); }

    // --- Core Logic ---
    function populateSelects() {
      const items = load(ITEM_KEY, []);
      const pos = load(PO_KEY, []);
      const itemOpts = `<option value="">Select Item...</option>` + items.map(i => `<option value="${i.sku}">${i.sku} - ${i.name} (Cur: ${i.on})</option>`).join("");
      document.getElementById("aItem").innerHTML = itemOpts;
      document.getElementById("rMetaItem").innerHTML = itemOpts;
      const poOpts = `<option value="">Select Purchase Order...</option>` + pos.filter(p => p.status !== "Completed").map(p => `<option value="${p.id}">${p.id} - ${p.vendor} (ETA: ${p.eta})</option>`).join("");
      document.getElementById("rPo").innerHTML = poOpts;
    }

    function doReceive() {
      const poId = document.getElementById("rPo").value;
      const sku = document.getElementById("rMetaItem").value;
      const qty = Number(document.getElementById("rQty").value);
      if (!qty || qty <= 0) return toast("Error", "Valid quantity required.");
      const list = load(ITEM_KEY, []);
      if (poId) {
        const pos = load(PO_KEY, []);
        const p = pos.find(x => x.id === poId);
        if (p) {
          p.status = "Completed"; save(PO_KEY, pos);
          if (list.length) { list[0].on += qty; save(ITEM_KEY, list); }
          toast("Success", `Received against ${poId}.`);
        }
      } else if (sku) {
        const item = list.find(x => x.sku === sku);
        if (item) { item.on += qty; save(ITEM_KEY, list); toast("Success", `Received ${sku}.`); }
      }
      closeReceiveModal(); renderAll();
    }

    function doAdjust() {
      const sku = document.getElementById("aItem").value;
      const qty = Number(document.getElementById("aQty").value);
      const reason = document.getElementById("aReason").value;
      if (!sku || !qty) return toast("Error", "Required fields missing.");
      const list = load(ITEM_KEY, []);
      const item = list.find(x => x.sku === sku);
      if (item) {
        item.on += qty; save(ITEM_KEY, list);
        toast("Success", "Stock adjusted.");
        closeAdjustModal(); renderAll();
      }
    }

    function generateCountList() {
      const items = load(ITEM_KEY, []);
      if (!items.length) return document.getElementById("countList").innerHTML = "No items.";
      const subset = items.sort(() => 0.5 - Math.random()).slice(0, 3);
      const html = subset.map(i => `
            <div style="background:#f8fafc; padding:12px; border-radius:8px; border:1px solid var(--border);">
                 <div style="font-weight:600; font-size:13px;">${i.sku} - ${i.name}</div>
                 <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                     <span style="font-size:12px; color:var(--text-muted);">System: ${i.on}</span>
                     <input class="input" style="width:100px; height:32px;" placeholder="Actual" type="number" />
                 </div>
            </div>`).join("");
      document.getElementById("countList").innerHTML = html;
    }

    function doCycleCount() { toast("Success", "Counts submitted."); closeCountModal(); }

    function addItem() {
      const sku = (document.getElementById("iSku").value || "").trim();
      const name = (document.getElementById("iName").value || "").trim();
      if (!sku || !name) return toast("Error", "SKU/Name required.");
      const item = {
        sku, name,
        cat: (document.getElementById("iCat").value || "").trim() || "General",
        wh: (document.getElementById("iWh").value || "").trim() || "WH-A",
        sup: (document.getElementById("iSup").value || "").trim() || "Vendor",
        on: Number(document.getElementById("iOn").value || 0),
        rop: Number(document.getElementById("iRop").value || 0),
        cost: Number(document.getElementById("iCost").value || 0)
      };
      const list = load(ITEM_KEY, []);
      list.unshift(item); save(ITEM_KEY, list);
      closeItemModal(); toast("Success", "Item added."); renderAll();
    }

    // --- Views ---
    function setFilter(type) {
      CURRENT_FILTER = type;
      // visual state
      document.querySelectorAll(".clickable-kpi").forEach(el => el.classList.remove("active"));
      if (type !== 'all') {
        const el = document.getElementById("kpi" + type.charAt(0).toUpperCase() + type.slice(1));
        if (el) el.classList.add("active");
        document.getElementById("stockBadge").style.display = "inline-flex";
        document.getElementById("stockBadge").textContent = (type === 'low' ? 'Low Stock' : 'Out of Stock');
      } else {
        document.getElementById("stockBadge").style.display = "none";
      }
      renderStock();
    }

    function renderStock() {
      // Logic for main Stock Card (now removed/replaced by specific views, but we reused logic?)
      // We need to update the top stats and the sidebar stats
      const items = load(ITEM_KEY, []);

      // Calculate Stats
      const low = items.filter(i => i.on <= i.rop && i.on > 0).length;
      const oos = items.filter(i => i.on <= 0).length;
      const val = items.reduce((acc, i) => acc + (i.on * i.cost), 0);

      // Update Top Stats
      document.getElementById("kTotal").textContent = items.length;
      document.getElementById("kLow").textContent = low;
      document.getElementById("kOOS").textContent = oos;
      document.getElementById("kValue").textContent = money(val);

      // Update Sidebar Stats
      if (document.getElementById("kTotalSide")) {
        document.getElementById("kTotalSide").textContent = items.length;
      }
    }

    function renderDeliveries() {
      const pos = load(PO_KEY, []);
      const active = pos.filter(p => p.status !== "Completed" && p.status !== "Delivered");
      active.sort((a, b) => new Date(a.eta) - new Date(b.eta));

      const search = (document.getElementById("searchDel") ? document.getElementById("searchDel").value : "").toLowerCase();

      const tbody = document.getElementById("delBody");
      tbody.innerHTML = "";

      // Filter
      const shown = active.filter(p => {
        if (search && !(p.id + p.vendor).toLowerCase().includes(search)) return false;
        return true;
      });

      if (!shown.length) return tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:24px; color:var(--text-muted);">No upcoming deliveries match.</td></tr>`;

      shown.forEach(p => {
        const tr = document.createElement("tr");

        // Mock statuses
        let statusClass = "badge-yellow";
        let statusText = p.status || "OPEN";
        const etaDate = new Date(p.eta);
        const today = new Date();
        if (etaDate < today) { statusClass = "badge-red"; statusText = "DELAYED"; }
        else if (statusText === 'Approved') { statusClass = "badge-green"; statusText = "APPROVED"; }

        tr.innerHTML = `
                <td style="padding:16px;">${p.eta || "‚Äî"}</td>
                <td style="padding:16px;"><strong>${p.id}</strong></td>
                <td style="padding:16px;">${p.vendor}</td>
                <td style="padding:16px;">${(p.lines || "").split("\n").filter(Boolean).length} lines</td>
                <td style="padding:16px;"><span class="badge ${statusClass}">${statusText}</span></td>
                <td style="padding:16px;"><button class="btn btn-secondary" style="height:32px; padding:0 12px; font-size:12px;" onclick="document.getElementById('receiveModal').classList.add('open')">Receive</button></td>
             `;
        tbody.appendChild(tr);
      });
    }

    function renderDeliveries() {
      const pos = load(PO_KEY, []);
      const active = pos.filter(p => p.status !== "Completed" && p.status !== "Delivered");
      active.sort((a, b) => new Date(a.eta) - new Date(b.eta));
      const tbody = document.getElementById("delBody");
      tbody.innerHTML = "";
      if (!active.length) return tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:var(--text-muted);">No upcoming deliveries.</td></tr>`;

      active.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
                <td>${p.eta || "‚Äî"}</td>
                <td><strong>${p.id}</strong></td>
                <td>${p.vendor}</td>
                <td>${(p.lines || "").split("\n").filter(Boolean).length} lines</td>
                <td><span class="badge badge-yellow">${p.status}</span></td>
                <td><button class="btn btn-secondary" style="height:32px; padding:0 12px; font-size:12px;" onclick="document.getElementById('receiveModal').classList.add('open')">Receive</button></td>
             `;
        tbody.appendChild(tr);
      });
    }

    function renderAll() {
      renderStock();
      renderDeliveries();
    }

    // Auto-seed
    if (load(ITEM_KEY, []).length === 0) {
      const demo = [
        { sku: "BX-9001", name: "Premium Gift Box", cat: "Packaging", wh: "WH-A", sup: "PackPro", on: 140, rop: 50, cost: 1.60 },
        { sku: "NK-1001", name: "Necklace ‚Äî Aurora", cat: "Finished Goods", wh: "WH-B", sup: "Stark Mfg", on: 62, rop: 30, cost: 42.00 },
        { sku: "RG-2001", name: "Ring ‚Äî Obsidian", cat: "Finished Goods", wh: "WH-B", sup: "Stark Mfg", on: 0, rop: 18, cost: 38.00 }
      ];
      save(ITEM_KEY, demo);
    }

    renderAll();
  </script>
</body>

</html>
