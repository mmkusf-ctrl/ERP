<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Cycle Count | Stark Premium ERP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=2">

    <style>
        /* Count Page Specifics */
        .glass-panel {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
        }

        /* Count Cards */
        .count-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .count-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }

        /* Dynamic Status Borders */
        .count-card.status-match {
            border-left: 4px solid var(--success);
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
        }

        .count-card.status-variance {
            border-left: 4px solid var(--danger);
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.05) 0%, transparent 50%);
        }

        /* Progress Bar */
        .progress-track {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 16px;
            margin-bottom: 24px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.5s ease;
        }
    </style>
</head>

<body>
    <!-- Top Navigation (Unified) -->
    <header class="topbar">
        <div class="topbar-inner">
            <a href="dashboard.html" class="logo">
                <img src="images/stark-logo.png" alt="Stark Premium">
                <span class="logo-text">Stark ERP</span>
            </a>
            <nav class="nav">
                <a class="nav-link" href="inventory.html">‚Üê Back to Inventory</a>
            </nav>
            <div style="display:flex; align-items:center; gap:12px;">
                <span style="font-size:13px; color:var(--text-muted);">Session: <strong
                        style="color:var(--text-main);">#CC-2026-009</strong></span>
            </div>
        </div>
    </header>

    <main class="container" style="padding-top:40px; max-width:800px;">

        <!-- Header -->
        <div style="text-align:center; margin-bottom:40px;">
            <h1 class="page-title" style="font-size:32px; font-weight:800; margin-bottom:8px;">Cycle Count
                Session</h1>
            <p style="color:var(--text-muted); font-size:16px;">Verify physical stock by zone. Input actual counts
                below.</p>
        </div>

        <!-- Controls -->
        <div class="glass-panel" style="margin-bottom:32px;">
            <div style="display:flex; gap:16px; align-items:end;">
                <div style="flex:1;">
                    <label
                        style="font-size:12px; font-weight:700; color:var(--text-muted); letter-spacing:0.05em; text-transform:uppercase;">Select
                        Brand</label>
                    <select id="brandSelect" class="input" style="margin-top:8px;">
                        <option value="">Loading Brands...</option>
                    </select>
                </div>
                <button onclick="startSession()" class="btn btn-primary" style="height:48px; padding:0 32px;">
                    Start Session
                </button>
            </div>
        </div>

        <!-- Active Session View -->
        <div id="sessionView" style="display:none;">

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="color:var(--text-main); font-weight:700;">Progress</div>
                <div style="color:var(--text-muted); font-size:13px;"><span id="progText">0/0</span> items counted</div>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="progBar"></div>
            </div>

            <div id="countList" style="display:grid; gap:16px; margin-bottom:32px;">
                <!-- Count Cards Injected Here -->
            </div>

            <div style="display:flex; gap:16px;">
                <button onclick="exportCSV()" class="btn btn-secondary" style="flex:1;">
                    <i class="fa-solid fa-file-excel" style="margin-right:8px;"></i> Export to Excel
                </button>
                <button onclick="submitSession()" class="btn btn-primary"
                    style="flex:2; height:56px; font-size:16px; background:linear-gradient(135deg, #10b981, #059669); border:none; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);">
                    Submit Verified Counts
                </button>
            </div>

        </div>

    </main>

    <div id="toastWrap" style="position:fixed; bottom:20px; right:20px; z-index:9999; display:grid; gap:10px;"></div>

    <script src="erp.js"></script>
    <script>
        const ITEM_KEY = "stark_erp_items_v2";
        let activeItems = [];
        let selectedBrand = "";

        function loadItems() {
            try { return JSON.parse(localStorage.getItem(ITEM_KEY) || "[]"); } catch { return []; }
        }

        // Init: Populate Brands
        (function init() {
            const items = loadItems();
            const brands = [...new Set(items.map(i => i.brand).filter(b => b))].sort();

            const sel = document.getElementById("brandSelect");
            if (brands.length === 0) {
                sel.innerHTML = '<option value="">No Brands Found</option>';
            } else {
                sel.innerHTML = brands.map(b => `<option value="${b}">${b}</option>`).join("");
            }
        })();

        function startSession() {
            selectedBrand = document.getElementById("brandSelect").value;
            if (!selectedBrand) return toast("Error", "Please select a brand.");

            const allItems = loadItems();
            activeItems = allItems.filter(i => i.brand === selectedBrand);

            if (activeItems.length === 0) return toast("Empty", "No items found for this brand.");

            renderCards();
            document.getElementById("sessionView").style.display = "block";
            // Smooth scroll
            setTimeout(() => {
                document.getElementById("sessionView").scrollIntoView({ behavior: "smooth" });
            }, 100);

            toast("Session Started", `${selectedBrand} loaded (${activeItems.length} items).`);
        }

        function renderCards() {
            const container = document.getElementById("countList");
            container.innerHTML = "";

            activeItems.forEach((item, idx) => {
                const card = document.createElement("div");
                card.className = "count-card anim-item";
                card.style.animationDelay = (idx * 50) + "ms";
                card.id = `card-${item.sku}`;

                card.innerHTML = `
                <div style="flex:1;">
                    <div style="font-size:16px; font-weight:700; color:var(--text-main);">${item.sku}</div>
                    <div style="color:var(--text-muted); font-size:12px; margin-bottom:4px;">Model: ${item.model || '-'}</div>
                    <div style="color:var(--text-muted); font-size:13px;">${item.name}</div>
                </div>
                
                <div style="display:flex; align-items:center; gap:24px;">
                     <div style="text-align:right;">
                        <div style="font-size:11px; color:#64748b; text-transform:uppercase; font-weight:700;">System</div>
                        <div style="font-size:18px; color:#64748b; font-family:'Courier New', monospace; font-weight:700;">${item.on}</div>
                     </div>
                     
                     <div>
                        <input type="number" 
                               class="input" 
                               placeholder="Actual" 
                               id="inp-${item.sku}"
                               oninput="checkVariance(this, ${item.on}, 'card-${item.sku}')"
                               style="width:100px; height:48px; font-size:18px; text-align:center; background:white !important; color:var(--text-main); border:1px solid #e2e8f0;">
                     </div>
                </div>
            `;
                container.appendChild(card);
            });

            updateProgress();
        }

        function checkVariance(input, expected, cardId) {
            const val = input.value;
            const card = document.getElementById(cardId);

            // Remove classes
            card.classList.remove("status-match", "status-variance");

            if (val === "") {
                updateProgress();
                return;
            }

            const num = Number(val);
            if (num === expected) {
                card.classList.add("status-match");
            } else {
                card.classList.add("status-variance");
            }
            updateProgress();
        }

        function updateProgress() {
            const total = activeItems.length;
            const inputs = document.querySelectorAll("#countList input");
            let completed = 0;

            inputs.forEach(inp => {
                if (inp.value !== "") completed++;
            });

            const pct = Math.round((completed / total) * 100);
            document.getElementById("progBar").style.width = pct + "%";
            document.getElementById("progText").innerText = `${completed}/${total}`;
        }

        function exportCSV() {
            if (activeItems.length === 0) return toast("Error", "No data to export.");

            let csv = "Brand,SKU,Model,Name,System Qty,Actual Qty,Variance\n";
            activeItems.forEach(item => {
                const inp = document.getElementById(`inp-${item.sku}`);
                const actual = inp ? inp.value : "";
                const variance = actual !== "" ? (Number(actual) - item.on) : "";

                csv += `"${selectedBrand}","${item.sku}","${item.model || ''}","${item.name}",${item.on},${actual},${variance}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `CycleCount_${selectedBrand}_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            toast("Exported", "CSV file download started.");
        }

        function submitSession() {
            if (confirm("Submit these counts? Any variances will be logged for review.")) {
                toast("Success", "Cycle Count Submitted.");
                setTimeout(() => window.location.href = "inventory.html", 1500);
            }
        }
    </script>
</body>

</html>
