<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Detail | Stark ERP</title>
    <link href="style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        /* Document / Print Styles */
        body {
            background-color: #f1f5f9;
        }

        .document-page {
            background: white;
            max-width: 850px;
            /* A4ish width */
            margin: 0 auto;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            /* Slight rounding on screen, zero on print */
            color: #1e293b;
            font-family: 'Inter', sans-serif;
            position: relative;
        }

        .doc-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
        }

        .doc-title {
            font-size: 32px;
            font-weight: 800;
            color: #0f172a;
            margin-bottom: 24px;
        }

        .doc-section-title {
            background-color: #0f766e;
            /* Using a green like the reference */
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 4px 8px;
            display: inline-block;
            /* Tag style */
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .addr-block {
            font-size: 13px;
            line-height: 1.5;
            color: #334155;
        }

        .meta-grid {
            margin: 30px 0;
            display: grid;
            gap: 8px;
            font-size: 14px;
        }

        .meta-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            align-items: center;
        }

        .meta-label {
            color: #64748b;
        }

        .highlight-val {
            background: #fef08a;
            /* Yellow highlight style from image */
            padding: 0 4px;
            font-weight: 600;
        }

        /* Table */
        .doc-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            margin-top: 10px;
        }

        .doc-table th {
            background: #f8fafc;
            text-align: left;
            padding: 12px;
            font-size: 12px;
            text-transform: uppercase;
            color: #0f172a;
            font-weight: 700;
            border-bottom: 2px solid #e2e8f0;
        }

        .doc-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
            font-size: 14px;
        }

        .doc-table td.num {
            text-align: right;
        }

        /* Totals */
        .totals-section {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 40px;
        }

        .totals-grid {
            width: 300px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            text-align: right;
        }

        .total-row-label {
            color: #64748b;
            font-size: 14px;
        }

        .total-row-value {
            font-weight: 600;
            font-size: 14px;
        }

        .grand-total {
            border-top: 2px solid #e2e8f0;
            padding-top: 12px;
            margin-top: 4px;
            font-size: 18px;
            font-weight: 800;
            color: #0f172a;
        }

        /* Terms */
        .terms-row {
            display: flex;
            margin-bottom: 16px;
            align-items: center;
        }

        .terms-label {
            background-color: #0f766e;
            color: white;
            font-size: 13px;
            font-weight: 700;
            padding: 6px 12px;
            width: 140px;
            margin-right: 20px;
            text-align: right;
        }

        .terms-value {
            font-size: 14px;
            font-weight: 600;
            color: #334155;
            background: #fef08a;
            /* Highlight style */
            padding: 0 4px;
        }

        .side-marker {
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%) translateX(100%);
            background: #0f766e;
            color: white;
            padding: 8px 12px;
            font-weight: 700;
            font-size: 12px;
            text-align: center;
            display: none;
            /* Hidden by default as it might break fluid layout, enable if strictly following image on wider screens */
        }

        @media (min-width: 1100px) {
            .side-marker {
                display: block;
            }
        }

        @media print {
            body {
                background: white;
                margin: 0;
                padding: 0;
            }

            .no-print {
                display: none !important;
            }

            .document-page {
                box-shadow: none;
                margin: 0;
                padding: 0;
                width: 100%;
                max-width: none;
                border-radius: 0;
            }

            .container {
                padding: 0 !important;
                margin: 0 !important;
                max-width: none !important;
            }

            nav,
            .breadcrumbs,
            .page-header {
                display: none;
            }
        }
    </style>
</head>

<body>
    <nav class="top-nav no-print">
        <div class="nav-brand">
            <span class="material-icons-round" style="color:#6366f1; font-size:24px;">all_inclusive</span>
            <span>Stark<span style="font-weight:400; color:#94a3b8;">ERP</span></span>
        </div>
        <div class="nav-links">
            <a href="dashboard.html">Dashboard</a>
            <a href="orders.html" class="active">Orders</a>
            <a href="inventory.html">Inventory</a>
            <a href="master.html">Master</a>
        </div>
        <div class="user-profile">
            <div class="avatar">JM</div>
        </div>
    </nav>

    <div class="breadcrumbs no-print">
        <a href="orders.html">Orders</a>
        <span class="separator">/</span>
        <span class="current" id="crumbId">ORD-....</span>
    </div>

    <main class="container" style="padding-bottom:60px; max-width: 1000px; margin: 0 auto;">

        <!-- Controls -->
        <div class="no-print"
            style="max-width:850px; margin:0 auto 20px; display:flex; justify-content:space-between; align-items:center;">
            <button onclick="window.history.back()" class="btn btn-secondary"
                style="display:flex; align-items:center; gap:6px;">
                <span class="material-icons-round" style="font-size:16px;">arrow_back</span> Back
            </button>
            <div style="display:flex; gap:12px; align-items:center;">
                <div id="hStatusBadge" class="badge">Processing</div>
                <button onclick="window.print()" class="btn btn-primary"
                    style="display:flex; align-items:center; gap:6px;">
                    <span class="material-icons-round" style="font-size:18px;">print</span> Print / Save PDF
                </button>
            </div>
        </div>

        <!-- Warning Banner -->
        <div id="holdBanner" class="no-print"
            style="display:none; max-width:850px; margin:0 auto 24px; background:#fef2f2; border:1px solid #fee2e2; border-radius:12px; padding:16px; color:#991b1b; gap:12px; align-items:flex-start;">
            <span class="material-icons-round">warning</span>
            <div>
                <strong style="display:block; margin-bottom:4px;">Order On Hold</strong>
                <span id="holdReason">...</span>
            </div>
        </div>

        <!-- DOCUMENT -->
        <div class="document-page">

            <h1 class="doc-title">Sales Order</h1>

            <div
                style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:40px; position:relative;">

                <!-- Left Column: Company -->
                <div style="position:relative; padding-left:24px; border-left: 4px solid #0f766e;">
                    <!-- Floating Tag like in image -->
                    <div
                        style="position:absolute; left:-145px; top:10px; background:#0f766e; color:white; padding:6px 10px; font-weight:700; font-size:12px; width:110px; text-align:right; display:none; /* Hidden on small screens */ @media(min-width:1100px){display:block;}">
                        Company Details</div>
                    <div class="doc-section-title" style="@media(min-width:1100px){display:none;}">Company Details</div>
                    <!-- Mobile fallback -->

                    <div class="addr-block">
                        <strong style="background:#fef08a; padding:0 2px;">Stark Manufacturing</strong><br>
                        <span style="background:#fef08a; padding:0 2px;">123 Innovation Dr.</span><br>
                        <span style="background:#fef08a; padding:0 2px;">Tech City, CA 90210</span><br>
                        <span style="background:#fef08a; padding:0 2px;">USA</span><br>
                        <span style="background:#fef08a; padding:0 2px; color:#000;">billing@starkmfg.com</span>
                    </div>
                </div>

                <!-- Right Column: Customer -->
                <div style="position:relative; width:45%; text-align:left;">
                    <!-- Side Marker for Customer Details -->
                    <div
                        style="position:absolute; top:-30px; right:0; background:#0f766e; color:white; padding:6px 12px; font-weight:700; font-size:12px;">
                        Customer Details</div>

                    <div class="addr-block" style="margin-top:10px;">
                        <strong id="dCust" class="highlight-val"
                            style="font-size:14px; display:inline-block; margin-bottom:2px;">-</strong><br>
                        <div id="dShipAddr" style="display:flex; flex-direction:column; gap:2px;">
                            <span class="highlight-val" style="width:fit-content;">742 Evergreen Terrace</span>
                            <span class="highlight-val" style="width:fit-content;">Springfield, IL 62704</span>
                            <span class="highlight-val" style="width:fit-content;">USA</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Meta Data (No. Date) -->
            <div class="meta-grid">
                <div class="meta-row">
                    <span class="meta-label">Sales Order No.:</span>
                    <strong class="highlight-val" id="hOrderId">-</strong>
                </div>
                <div class="meta-row">
                    <span class="meta-label">Date:</span>
                    <strong class="highlight-val" id="hDate">-</strong>
                </div>
            </div>

            <!-- Items -->
            <div style="position:relative; margin-bottom:20px;">
                <div class="side-marker" style="right:-90px; top:50%;">Products<br>Purchased</div>

                <table class="doc-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th style="padding:12px;">Price</th>
                            <th style="text-align:right;">QTY</th>
                            <th style="text-align:right;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="lineBody">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>

            <div style="display:flex; gap:40px; align-items:flex-start; margin-bottom:40px;">

                <!-- Left Bottom: Remarks -->
                <div style="flex:1; position:relative;">
                    <div
                        style="position:absolute; left:-145px; top:20px; background:#0f766e; color:white; padding:6px 10px; font-weight:700; font-size:12px; width:110px; text-align:right; line-height:1.3; display:none; @media(min-width:1100px){display:block;}">
                        Balance and<br>Accounting<br>Information</div>

                    <div
                        style="background:#f1f5f9; padding:8px 12px; font-weight:700; font-size:12px; margin-bottom:0; display:flex; align-items:center; gap:8px;">
                        Other Remarks
                    </div>
                    <div style="border:1px solid #f1f5f9; padding:12px; min-height:80px; font-size:13px; color:#475569;"
                        id="dNote">
                        -
                    </div>
                </div>

                <!-- Right Bottom: Totals -->
                <div class="totals-section" style="margin-bottom:0;">
                    <div class="totals-grid">
                        <span class="total-row-label">Subtotal</span>
                        <span class="total-row-value" id="sSubtotal">$0.00</span>

                        <span class="total-row-label">Discount</span>
                        <span class="total-row-value" style="color:#0f172a;">$0.00</span>

                        <span class="total-row-label">Tax</span>
                        <span class="total-row-value" id="sTax">$0.00</span>

                        <span class="total-row-label grand-total">Total</span>
                        <span class="grand-total" id="sTotal">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Footer Terms -->
            <div style="margin-top:20px; padding-top:20px; border-top:1px solid #e2e8f0;">
                <div class="terms-row">
                    <div class="terms-label">Shipping Terms</div>
                    <div class="terms-value">
                        <span id="dShip">Standard Ground</span>
                    </div>
                    <div
                        style="margin-left:auto; background:#0f766e; color:white; padding:4px 12px; font-weight:700; font-size:12px;">
                        Shipping Terms</div>
                </div>
                <div class="terms-row">
                    <div class="terms-label">Payment Terms</div>
                    <div class="terms-value">
                        <span id="dPayTerms">Net 30</span>
                    </div>
                    <div
                        style="margin-left:auto; background:#0f766e; color:white; padding:4px 12px; font-weight:700; font-size:12px;">
                        Payment Terms</div>
                </div>
            </div>

        </div>
    </main>

    <script src="erp.js"></script>
    <script>
        const AUTH_KEY = "stark_erp_auth_v1";
        const ORDER_KEY = "stark_erp_orders_v1";
        const CUST_KEY = "stark_erp_customers_v1";

        (function () {
            try {
                const a = JSON.parse(localStorage.getItem(AUTH_KEY) || "null");
                if (!a || !a.user) window.location.href = "index.html";
            } catch {
                window.location.href = "index.html";
            }
        })();

        const params = new URLSearchParams(window.location.search);
        const orderId = params.get("id");
        let currentOrder = null;

        function init() {
            if (!orderId) {
                alert("No Order ID specified");
                window.location.href = "orders.html";
                return;
            }

            const orders = JSON.parse(localStorage.getItem(ORDER_KEY) || "[]");
            currentOrder = orders.find(o => o.id === orderId);

            if (!currentOrder) {
                document.querySelector("main").innerHTML = `<div style="text-align:center; padding:100px;"><h2>Order Not Found</h2><a href="orders.html" class="btn btn-primary" style="margin-top:20px; display:inline-block;">Back to Orders</a></div>`;
                return;
            }

            // Load Customers for linking
            const customers = JSON.parse(localStorage.getItem(CUST_KEY) || "[]");
            const customer = customers.find(c => c.name === currentOrder.cust);

            renderOrder(currentOrder, customer);
            renderActions(currentOrder);
        }

        function renderOrder(o, c) {
            // Header
            document.getElementById("hOrderId").textContent = o.id;
            document.getElementById("crumbId").textContent = o.id;
            document.getElementById("hDate").textContent = o.date;

            // Status Badge
            const badge = document.getElementById("hStatusBadge");
            badge.textContent = o.status;
            badge.className = "badge";
            if (o.status === "Validated" || o.status === "Shipped") badge.classList.add("badge-green");
            else if (o.status === "On Hold") badge.classList.add("badge-red");
            else badge.classList.add("badge-blue");

            // Hold Banner
            if (o.status === "On Hold") {
                document.getElementById("holdBanner").style.display = "flex";
                document.getElementById("holdReason").textContent = o.holdReason || "Reason not specified";
            } else {
                document.getElementById("holdBanner").style.display = "none";
            }

            // Customer Details
            document.getElementById("dCust").textContent = o.cust;

            const addrBlock = document.getElementById("dShipAddr");
            if (c) {
                // Dynamic Data
                addrBlock.innerHTML = `
                    <span class="highlight-val" style="width:fit-content;">${c.location}</span>
                    <span class="highlight-val" style="width:fit-content;">${c.contact || ""}</span>
                    <span class="highlight-val" style="width:fit-content;">${c.phone || ""}</span>
                `;
            } else {
                // Fallback / Mock
                addrBlock.innerHTML = `
                    <span class="highlight-val" style="width:fit-content;">Walk-in / Unknown</span>
                    <span class="highlight-val" style="width:fit-content;">-</span>
                `;
            }

            document.getElementById("dPayTerms").textContent = o.terms || "Net 30";

            if (o.note) {
                document.getElementById("dNote").textContent = o.note;
            } else {
                document.getElementById("dNote").textContent = "No remarks.";
            }

            // Logistics
            document.getElementById("dShip").textContent = o.shipMethod || "Standard Ground";

            // Lines
            const tbody = document.getElementById("lineBody");
            let total = 0;
            tbody.innerHTML = (o.lines || []).map(l => {
                const lineTotal = (l.price || 0) * (l.qty || 0);
                total += lineTotal;
                return `
                    <tr>
                        <td style="vertical-align:top;">
                            <div style="font-weight:600; color:#1e293b;">${l.name || "Product"}</div>
                            <div style="color:#64748b; font-size:12px; margin-top:2px;">${l.sku}</div>
                        </td>
                        <td style="padding:12px; vertical-align:top;">${window.formatMoney ? window.formatMoney(l.price) : l.price}</td>
                        <td class="num" style="vertical-align:top;">${l.qty}</td>
                        <td class="num" style="font-weight:600; vertical-align:top;">${window.formatMoney ? window.formatMoney(lineTotal) : lineTotal}</td>
                    </tr>
                `;
            }).join("");

            // Summary
            const discount = o.discount || 0;
            const taxRate = 0.08875;
            const subtotal = total;
            const tax = (subtotal - discount) * taxRate;
            const grandTotal = subtotal - discount + tax;

            document.getElementById("sSubtotal").textContent = window.formatMoney(subtotal);
            document.getElementById("sTax").textContent = window.formatMoney(tax);
            document.getElementById("sTotal").textContent = window.formatMoney(grandTotal);
        }

        function renderActions(o) {
            // Remove existing action buttons first (if any, though we usually just append or init once)
            const controlsDiv = document.querySelector(".no-print > div:last-child"); // The div with badge and print button

            // Clean up old action buttons if re-rendering
            const oldBtns = controlsDiv.querySelectorAll(".action-btn");
            oldBtns.forEach(b => b.remove());

            // Helper to create btn
            const addBtn = (label, icon, colorClass, onClick) => {
                const b = document.createElement("button");
                b.className = `btn ${colorClass} action-btn`;
                b.style = "display:flex; align-items:center; gap:6px; margin-right:8px;";
                b.innerHTML = `<span class="material-icons-round" style="font-size:18px;">${icon}</span> ${label}`;
                b.onclick = onClick;
                controlsDiv.insertBefore(b, controlsDiv.firstChild); // Insert before badge
            };

            if (o.status === "Processing") {
                addBtn("Hold", "pause", "btn-secondary", () => updateStatus("On Hold"));
                addBtn("Validate", "check_circle", "btn-primary", () => updateStatus("Validated"));
            } else if (o.status === "On Hold") {
                addBtn("Release", "play_arrow", "btn-primary", () => updateStatus("Processing"));
            } else if (o.status === "Validated") {
                addBtn("Ship", "local_shipping", "btn-primary", () => updateStatus("Shipped"));
            }
        }

        function updateStatus(newStatus) {
            if (!currentOrder) return;

            if (newStatus === "On Hold") {
                const reason = prompt("Enter reason for holding order:");
                if (!reason) return; // Cancelled
                currentOrder.holdReason = reason;
            } else {
                // Clear hold reason if moving out of hold
                delete currentOrder.holdReason;
            }

            currentOrder.status = newStatus;

            // Save to LocalStorage using the full list
            const orders = JSON.parse(localStorage.getItem(ORDER_KEY) || "[]");
            const idx = orders.findIndex(o => o.id === currentOrder.id);
            if (idx >= 0) {
                orders[idx] = currentOrder;
                localStorage.setItem(ORDER_KEY, JSON.stringify(orders));
            }

            // Feedback
            if (window.toast) toast("Status Updated", `Order marked as ${newStatus}`, "success");

            // Re-render
            init(); // Reloads data and re-renders
        }

        // Helper if formatMoney isn't loaded yet (though erp.js should handle it)
        window.formatMoney = window.formatMoney || function (n) {
            return Number(n).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        };

        window.addEventListener("DOMContentLoaded", init);

    </script>
</body>

</html>
