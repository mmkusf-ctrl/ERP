<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Events | Stark Premium ERP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .calendar-header {
            background: #f8fafc;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-muted);
        }

        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 8px;
            position: relative;
        }

        .calendar-day:hover {
            background: #f8fafc;
        }

        .day-num {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .event-chip {
            font-size: 11px;
            padding: 4px 6px;
            border-radius: 4px;
            margin-bottom: 2px;
            background: var(--primary-light);
            color: var(--primary);
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-chip.urgent {
            background: #fef2f2;
            color: var(--danger);
        }

        .event-chip.warning {
            background: #fffbeb;
            color: #d97706;
        }
    </style>
</head>

<body>
    <!-- Top Navigation -->
    <header class="topbar">
        <div class="topbar-inner">
            <a href="dashboard.html" class="logo">
                <img src="images/stark-logo.png" alt="Stark Premium">
                <span class="logo-text">Stark ERP</span>
            </a>

            <nav class="nav">
                <a class="nav-link" href="dashboard.html">Overview</a>
                <a class="nav-link" href="crm.html">CRM</a>
                <a class="nav-link" href="vendor.html">Vendor</a>
                <a class="nav-link" href="purchasing.html">Purchasing</a>
                <a class="nav-link" href="inventory.html">Inventory</a>
                <a class="nav-link" href="accounting.html">Accounting</a>
                <a class="nav-link" href="orders.html">Orders</a>
                <a class="nav-link" href="logistics.html">Logistics</a>
                <a class="nav-link" href="reports.html">Reports</a>
                <a class="nav-link active" href="events.html">Events</a>
            </nav>

            <div style="display:flex; align-items:center; gap:12px;">
                <div class="badge badge-green" style="display:none; @media(min-width:700px){display:inline-flex;}">
                    Online
                </div>
                <button class="hamburger" onclick="openMobileNav()">
                    <span></span><span></span><span></span>
                </button>
            </div>
        </div>
    </header>

    <div class="mobile-nav" id="mobileNav">
        <div class="mobile-drawer">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <strong style="font-size:16px;">Navigation</strong>
                <button onclick="closeMobileNav()"
                    style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <a class="mobile-link" href="dashboard.html">Overview</a>
            <a class="mobile-link" href="crm.html">CRM</a>
            <a class="mobile-link" href="vendor.html">Vendor</a>
            <a class="mobile-link" href="purchasing.html">Purchasing</a>
            <a class="mobile-link" href="inventory.html">Inventory</a>
            <a class="mobile-link" href="accounting.html">Accounting</a>
            <a class="mobile-link" href="orders.html">Orders</a>
            <a class="mobile-link" href="logistics.html">Logistics</a>
            <a class="mobile-link" href="reports.html">Reports</a>
            <a class="mobile-link active" href="events.html">Events</a>
        </div>
    </div>

    <main class="container">
        <div class="page-header">
            <h1 class="page-title">Corporate Events Calendar</h1>
            <p class="page-desc">Schedule, track, and manage company-wide events and deadlines.</p>
            <div class="gold-line"></div>
        </div>

        <!-- KPI Grid -->
        <section class="kpi-grid" style="margin-bottom:32px;">
            <article class="card-kpi">
                <div class="card-header">
                    <div class="card-title">Upcoming</div>
                    <div class="badge badge-green">Future</div>
                </div>
                <div class="stat-value">12</div>
                <div class="stat-trend neutral">Next 30 Days</div>
            </article>
            <article class="card-kpi">
                <div class="card-header">
                    <div class="card-title">This Week</div>
                    <div class="badge badge-yellow">Action</div>
                </div>
                <div class="stat-value">4</div>
                <div class="stat-trend neutral">Meeting Heavy</div>
            </article>
            <article class="card-kpi">
                <div class="card-header">
                    <div class="card-title">Invites</div>
                    <div class="badge badge-green">Pending</div>
                </div>
                <div class="stat-value">3</div>
                <div class="stat-trend up">Need Response</div>
            </article>
            <article class="card-kpi click-action" onclick="openEventModal()">
                <div class="card-header">
                    <div class="card-title">Quick Add</div>
                </div>
                <div style="margin-top:10px; text-align:center;">
                    <span style="font-size:24px;">üìÖ</span>
                    <div style="font-size:13px; font-weight:600; color:var(--primary);">+ Schedule Event</div>
                </div>
            </article>
        </section>

        <div class="grid" style="display:grid; grid-template-columns: 7fr 3fr; gap:24px; align-items:start;">
            <!-- Left: Calendar (70%) -->
            <section class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="font-size:18px; margin:0;" id="calendarTitle">February 2026</h2>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-secondary" style="height:32px;" onclick="changeMonth(-1)">&larr;</button>
                        <button class="btn btn-secondary" style="height:32px;" onclick="changeMonth(1)">&rarr;</button>
                    </div>
                </div>

                <div class="calendar-grid" id="calendarGrid">
                    <!-- Filled by JS -->
                </div>
            </section>

            <!-- Right: Agenda (30%) - Sticky -->
            <aside style="display:grid; gap:24px; align-content:start; position:sticky; top:20px;">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h2 style="font-size:16px; margin:0;">Agenda</h2>
                        <span class="badge badge-yellow" id="selectedDateLabel">Selected Date</span>
                    </div>

                    <div id="agendaList"
                        style="display:grid; gap:12px; max-height:600px; overflow-y:auto; padding-right:4px;">
                        <!-- Filled by JS -->
                    </div>

                    <!-- Empty State Template (Hidden) -->
                    <div id="emptyState"
                        style="display:none; text-align:center; padding:20px 0; color:var(--text-muted);">
                        <div style="font-size:24px; margin-bottom:8px;">üì≠</div>
                        <div style="font-size:13px; font-weight:600;">No events for this day</div>
                        <div style="font-size:12px;">Click "Quick Add" to schedule something.</div>
                        <button class="btn btn-secondary" style="width:100%; margin-top:12px;"
                            onclick="openEventModal()">+ Create Event</button>
                    </div>
                </div>
            </aside>
        </div>

        <div style="margin-top:40px; text-align:center; color:var(--text-muted); font-size:13px;">
            &copy; 2026 Stark Premium ERP.
        </div>
    </main>

    <!-- Create Event Modal -->
    <div class="mobile-nav" id="eventModal" style="z-index:900;">
        <!-- Modal Content Same as Before -->
        <div class="card"
            style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:min(90%, 600px); max-height:90vh; overflow-y:auto; box-shadow:var(--shadow-card);">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:12px; border-bottom:1px solid var(--border);">
                <h3 style="margin:0;">Create New Event</h3>
                <button onclick="closeEventModal()"
                    style="border:none; background:transparent; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <div style="display:grid; gap:16px;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                    <div>
                        <label
                            style="font-size:12px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Customer
                            Name</label>
                        <input id="eCustomer" class="input" placeholder="e.g. Acme Corp" />
                    </div>
                    <div>
                        <label
                            style="font-size:12px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Event
                            Name</label>
                        <input id="eName" class="input" placeholder="e.g. Summer Gala" />
                    </div>
                </div>
                <div>
                    <label
                        style="font-size:12px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Ship
                        To Address</label>
                    <input id="eAddress" class="input" placeholder="123 Main St, City, State" />
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                    <div>
                        <label
                            style="font-size:12px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">In
                            Hands Date</label>
                        <input id="eDate" type="date" class="input" />
                    </div>
                    <div>
                        <label
                            style="font-size:12px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Delivery
                            Method</label>
                        <select id="eDelivery" class="input">
                            <option value="ASAP">ASAP (Ship Immediately)</option>
                            <option value="HOLD">HOLD (Do Not Ship)</option>
                        </select>
                    </div>
                </div>
                <div
                    style="background:#f8fafc; padding:12px; border-radius:var(--radius-md); border:1px solid var(--border);">
                    <label
                        style="font-size:12px; font-weight:700; color:var(--text-muted); text-transform:uppercase; display:block; margin-bottom:8px;">Add
                        Items</label>
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <input id="iSku" class="input" placeholder="SKU / Item Name" style="flex:2;" />
                        <input id="iQty" type="number" class="input" placeholder="Qty" style="flex:1;" />
                        <button class="btn btn-secondary" onclick="addItemRow()">+</button>
                    </div>
                    <div id="itemList" style="display:grid; gap:4px; max-height:100px; overflow-y:auto;">
                        <div style="font-size:13px; color:var(--text-muted); font-style:italic; padding:4px;">No items
                            added yet.</div>
                    </div>
                </div>
                <div>
                    <label
                        style="font-size:12px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Special
                        Instructions</label>
                    <textarea id="eInstr" class="input" rows="3"
                        placeholder="Gate code, packing requirements, etc."></textarea>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:8px;">
                    <button class="btn btn-secondary" onclick="closeEventModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveEvent()">Create Event</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toastWrap" style="position:fixed; bottom:20px; right:20px; z-index:9999; display:grid; gap:10px;"></div>

    <script src="erp.js"></script>
    <script>
        const AUTH_KEY = "stark_erp_auth_v1";
        const EVENTS_KEY = "stark_erp_events_v1";
        let CURRENT_MONTH = new Date(2026, 1, 1); // Feb 2026
        let SELECTED_DATE = null;

        (function () { try { const a = JSON.parse(localStorage.getItem(AUTH_KEY) || "null"); if (!a || !a.user) window.location.href = "index.html"; } catch { window.location.href = "index.html"; } })();

        function openMobileNav() { document.getElementById("mobileNav").classList.add("open"); }
        function closeMobileNav() { document.getElementById("mobileNav").classList.remove("open"); }
        function openEventModal() { document.getElementById("eventModal").classList.add("open"); }
        function closeEventModal() { document.getElementById("eventModal").classList.remove("open"); }

        // Core Calendar Logic
        function renderCalendar() {
            const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || "[]");
            const grid = document.getElementById("calendarGrid");
            const m = CURRENT_MONTH.getMonth();
            const y = CURRENT_MONTH.getFullYear();

            document.getElementById("calendarTitle").textContent = CURRENT_MONTH.toLocaleString('default', { month: 'long', year: 'numeric' });

            grid.innerHTML = `
                <div class="calendar-header">Sun</div><div class="calendar-header">Mon</div><div class="calendar-header">Tue</div>
                <div class="calendar-header">Wed</div><div class="calendar-header">Thu</div><div class="calendar-header">Fri</div>
                <div class="calendar-header">Sat</div>
            `;

            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();

            // Empty slots
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div class="calendar-day" style="background:#f8fafc;"></div>`;
            }

            // Days
            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`; // YYYY-MM-DD
                const dayEvents = events.filter(e => e.date === dateStr);

                let chips = "";
                dayEvents.slice(0, 3).forEach(e => {
                    const style = e.delivery === 'HOLD' ? 'warning' : '';
                    chips += `<div class="event-chip ${style}">${e.name}</div>`;
                });
                if (dayEvents.length > 3) chips += `<div style="font-size:10px; color:var(--text-muted); padding-left:4px;">+${dayEvents.length - 3} more</div>`;

                const isSelected = SELECTED_DATE === dateStr;
                const activeData = isSelected ? 'border:2px solid var(--primary);' : '';

                grid.innerHTML += `
                    <div class="calendar-day" style="${activeData} cursor:pointer;" onclick="selectDate('${dateStr}')">
                        <div class="day-num" style="${isSelected ? 'color:var(--primary); font-weight:800;' : ''}">${i}</div>
                        ${chips}
                    </div>
                `;
            }
        }

        function selectDate(dateStr) {
            SELECTED_DATE = dateStr;
            renderCalendar(); // Re-render to show active state
            renderAgenda();
        }

        function renderAgenda() {
            const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || "[]");
            const list = document.getElementById("agendaList");
            const empty = document.getElementById("emptyState");

            // Format Title
            if (!SELECTED_DATE) {
                document.getElementById("selectedDateLabel").textContent = "All Upcoming";
            } else {
                const d = new Date(SELECTED_DATE + "T12:00:00");
                document.getElementById("selectedDateLabel").textContent = d.toLocaleDateString('default', { month: 'short', day: 'numeric' });
            }

            // Filter
            let shown = [];
            if (SELECTED_DATE) {
                shown = events.filter(e => e.date === SELECTED_DATE);
            } else {
                shown = events.filter(e => new Date(e.date) >= new Date());
                shown.sort((a, b) => new Date(a.date) - new Date(b.date));
                shown = shown.slice(0, 10); // Limit global view
            }

            list.innerHTML = "";
            if (shown.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'block';
            } else {
                list.style.display = 'grid';
                empty.style.display = 'none';

                shown.forEach(e => {
                    const itemCount = e.items ? e.items.length : 0;
                    list.innerHTML += `
                        <div class="card" style="padding:16px; border:1px solid var(--border); box-shadow:none;">
                            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                                <div style="font-weight:700; font-size:14px; color:var(--text-main);">${escapeHtml(e.name)}</div>
                                <span class="badge ${e.delivery === 'HOLD' ? 'badge-red' : 'badge-green'}">${e.delivery}</span>
                            </div>
                            <div style="font-size:13px; margin-bottom:4px;">
                                <span style="color:var(--text-muted);">Customer:</span> <strong>${escapeHtml(e.customer)}</strong>
                            </div>
                            <div style="font-size:13px; color:var(--text-muted); margin-bottom:8px;">
                                üìç ${escapeHtml(e.address)}
                            </div>
                            ${e.instr ? `<div style="font-size:12px; background:#f1f5f9; padding:6px; border-radius:4px; color:var(--text-main);">üìù ${escapeHtml(e.instr)}</div>` : ''}
                            ${itemCount > 0 ? `<div style="font-size:12px; margin-top:8px; color:var(--primary); font-weight:600;">üì¶ ${itemCount} Items Included</div>` : ''}
                            
                             <div style="display:flex; gap:8px; margin-top:12px;">
                                <button class="btn btn-secondary" style="height:28px; font-size:11px; width:100%;">View Order</button>
                                <button class="btn btn-secondary" style="height:28px; font-size:11px; width:100%;">Reschedule</button>
                            </div>
                        </div>
                    `;
                });
            }

            // Stats
            const future = events.filter(e => new Date(e.date) > new Date()).length;
            const week = events.filter(e => {
                const d = new Date(e.date);
                const now = new Date();
                const diffTime = Math.abs(d - now);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= 7 && d >= now;
            }).length;

            try {
                document.getElementById("kpiFuture").textContent = future;
                document.getElementById("kpiWeek").textContent = week;
                document.getElementById("kpiHold").textContent = events.filter(e => e.delivery === 'HOLD').length;
            } catch { }
        }

        function changeMonth(delta) {
            CURRENT_MONTH.setMonth(CURRENT_MONTH.getMonth() + delta);
            renderCalendar();
        }

        // Init
        // Item Logic (same as before)
        let currentItems = [];
        function addItemRow() {
            const sku = document.getElementById("iSku").value.trim();
            const qty = document.getElementById("iQty").value.trim();
            if (!sku || !qty) return;
            currentItems.push({ sku, qty });
            renderItems();
            document.getElementById("iSku").value = ""; document.getElementById("iQty").value = ""; document.getElementById("iSku").focus();
        }
        function removeItem(idx) { currentItems.splice(idx, 1); renderItems(); }
        function renderItems() {
            const list = document.getElementById("itemList");
            if (currentItems.length === 0) { list.innerHTML = `<div style="font-size:13px; color:var(--text-muted); font-style:italic; padding:4px;">No items added yet.</div>`; return; }
            list.innerHTML = currentItems.map((item, idx) => `
                <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:6px 10px; border:1px solid var(--border); border-radius:4px; font-size:13px;">
                    <div><strong>${item.sku}</strong> <span style="color:var(--text-muted);">x${item.qty}</span></div>
                    <button onclick="removeItem(${idx})" style="border:none; background:transparent; color:var(--danger); cursor:pointer;">&times;</button>
                </div>`).join("");
        }

        function saveEvent() {
            const customer = document.getElementById("eCustomer").value;
            const name = document.getElementById("eName").value;
            const address = document.getElementById("eAddress").value;
            const date = document.getElementById("eDate").value;
            const delivery = document.getElementById("eDelivery").value;
            const instr = document.getElementById("eInstr").value;
            if (!customer || !name || !date) return alert("Required fields missing.");

            const newEvent = { id: "EVT-" + Date.now(), customer, name, address, date, delivery, instr, items: currentItems, status: "Scheduled" };
            const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || "[]");
            events.push(newEvent);
            localStorage.setItem(EVENTS_KEY, JSON.stringify(events));

            closeEventModal();
            currentItems = []; renderItems(); document.querySelectorAll("input, textarea").forEach(i => i.value = "");

            selectDate(date); // Auto-select the new date
            alert("Event Scheduled!");
        }

        renderCalendar();
        renderAgenda();
    </script>
</body>

</html>
