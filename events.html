<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Company Events | Stark Premium ERP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=2">
    <style>
        /* Calendar Specific Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }

        .calendar-header {
            background: #f8fafc;
            padding: 12px;
            text-align: center;
            font-weight: 700;
            font-size: 13px;
            color: #64748b;
            text-transform: uppercase;
        }

        .calendar-day {
            background: white;
            min-height: 80px;
            padding: 4px;
            position: relative;
            transition: background 0.2s;
        }

        .calendar-day:hover {
            background: #f8fafc;
        }

        .calendar-day.other-month {
            background: #f9fafb;
            color: #cbd5e1;
        }

        .day-number {
            font-size: 13px;
            font-weight: 600;
            color: #334155;
            margin-bottom: 8px;
            display: block;
        }

        .calendar-day.today .day-number {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .event-chip {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 4px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: transform 0.1s;
        }

        .event-chip:hover {
            transform: scale(1.02);
        }

        .event-hr {
            background: #fee2e2;
            color: #b91c1c;
            border-left: 3px solid #b91c1c;
        }

        .event-sales {
            background: #dbf4ff;
            color: #0284c7;
            border-left: 3px solid #0284c7;
        }

        .event-ops {
            background: #dcfce7;
            color: #15803d;
            border-left: 3px solid #15803d;
        }

        .event-logistics {
            background: #f3e8ff;
            color: #7e22ce;
            border-left: 3px solid #7e22ce;
        }

        .timeline-item {
            display: flex;
            gap: 16px;
            padding-bottom: 24px;
            border-left: 2px solid #e2e8f0;
            padding-left: 24px;
            position: relative;
        }

        .timeline-item::before {
            content: "";
            position: absolute;
            left: -7px;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--primary);
        }

        .timeline-item:last-child {
            border-left: 2px solid transparent;
        }
    </style>
</head>

<body>
    <!-- Top Navigation -->
    <header class="topbar">
        <div class="topbar-inner">
            <a href="dashboard.html" class="logo">
                <img src="images/stark-logo.png" alt="Stark Premium">
                <span class="logo-text">Stark ERP</span>
            </a>

            <nav class="nav">
                <a class="nav-link" href="dashboard.html">Home</a>
                <a class="nav-link" href="master.html">Master</a>
                <a class="nav-link" href="crm.html">CRM</a>
                <a class="nav-link" href="vendor.html">Vendor</a>
                <a class="nav-link" href="purchasing.html">Purchasing</a>
                <a class="nav-link" href="inventory.html">Inventory</a>
                <a class="nav-link" href="accounting.html">Accounting</a>
                <a class="nav-link" href="orders.html">Orders</a>
                <a class="nav-link" href="logistics.html">Logistics</a>
                <a class="nav-link" href="reports.html">Reports</a>
                <a class="nav-link active" href="events.html">Events</a>
            </nav>

            <div style="display:flex; align-items:center; gap:12px;">
                <div class="badge badge-green" style="display:none; @media(min-width:700px){display:inline-flex;}">
                    Online
                </div>
                <button class="hamburger" onclick="openMobileNav()">
                    <span></span><span></span><span></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Drawer -->
    <div class="mobile-nav" id="mobileNav">
        <div class="mobile-drawer">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <strong style="font-size:16px;">Navigation</strong>
                <button onclick="closeMobileNav()"
                    style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <a class="mobile-link" href="dashboard.html">Home</a>
            <a class="mobile-link" href="master.html">Master</a>
            <a class="mobile-link" href="crm.html">CRM</a>
            <a class="mobile-link" href="vendor.html">Vendor</a>
            <a class="mobile-link" href="purchasing.html">Purchasing</a>
            <a class="mobile-link" href="inventory.html">Inventory</a>
            <a class="mobile-link" href="accounting.html">Accounting</a>
            <a class="mobile-link" href="orders.html">Orders</a>
            <a class="mobile-link" href="logistics.html">Logistics</a>
            <a class="mobile-link" href="reports.html">Reports</a>
            <a class="mobile-link active" href="events.html">Events</a>
            <a class="mobile-link" href="trends.html">Trends</a>
        </div>
    </div>

    <main class="container" style="padding-top:40px;">
        <!-- Header -->
        <div class="page-header" style="flex-direction:row; justify-content:space-between; align-items:end;">
            <div>
                <h1 class="page-title">Company Schedule</h1>
                <p class="page-desc">Upcoming meetings, holidays, and operational deadlines.</p>
            </div>
            <div style="display:flex; gap:12px;">
                <button class="btn btn-secondary" onclick="toast('Syncing...', 'Google Calendar Sync Started')">ðŸ”„ Sync
                    Cal</button>
                <button class="btn btn-primary" onclick="window.location.href='event_create.html'">+ Add Event</button>
            </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 320px; align-items:start; gap:24px;">

            <!-- Inventory Status Section (Left) -->
            <div class="card animate-enter">
                <h3 style="font-size:16px; font-weight:700; margin-bottom:16px;">Order Fulfillment Events & Inventory
                    Risks
                </h3>

                <div style="margin-bottom:16px;">
                    <input type="text" id="customerFilter" class="input" placeholder="Filter by Customer Name..."
                        onkeyup="filterTable()" style="padding:8px 12px; font-size:13px;">
                </div>

                <div class="table-container">
                    <table style="width:100%; font-size:13px; border-collapse:collapse;">
                        <thead>
                            <tr style="border-bottom:2px solid #f1f5f9; text-align:left; color:var(--text-muted);">
                                <th style="padding:12px 8px;">Event Name</th>
                                <th style="padding:12px 8px;">Customer</th>
                                <th style="padding:12px 8px;">PO #</th>
                                <th style="padding:12px 8px;">Ref Item</th>
                                <th style="padding:12px 8px;">Status</th>
                                <th style="padding:12px 8px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="eventsListBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Main Calendar -->
            <div class="animate-enter">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h2 style="font-size:18px; font-weight:700;">February 2026</h2>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-sm btn-secondary">&lt;</button>
                        <button class="btn btn-sm btn-secondary">&gt;</button>
                    </div>
                </div>

                <div class="calendar-grid">
                    <!-- Headers -->
                    <div class="calendar-header">Sun</div>
                    <div class="calendar-header">Mon</div>
                    <div class="calendar-header">Tue</div>
                    <div class="calendar-header">Wed</div>
                    <div class="calendar-header">Thu</div>
                    <div class="calendar-header">Fri</div>
                    <div class="calendar-header">Sat</div>

                    <!-- Week 1 -->
                    <div class="calendar-day other-month"><span class="day-number">26</span></div>
                    <div class="calendar-day other-month"><span class="day-number">27</span></div>
                    <div class="calendar-day other-month"><span class="day-number">28</span></div>
                    <div class="calendar-day other-month"><span class="day-number">29</span></div>
                    <div class="calendar-day other-month"><span class="day-number">30</span></div>
                    <div class="calendar-day other-month"><span class="day-number">31</span></div>
                    <div class="calendar-day"><span class="day-number">1</span></div>

                    <!-- Week 2 -->
                    <div class="calendar-day"><span class="day-number">2</span></div>
                    <div class="calendar-day">
                        <span class="day-number">3</span>
                        <div class="event-chip event-sales">9:00 AM Sales Sync</div>
                        <div class="event-chip event-ops">2:00 PM Inventory Audit</div>
                    </div>
                    <div class="calendar-day"><span class="day-number">4</span></div>
                    <div class="calendar-day">
                        <span class="day-number">5</span>
                        <div class="event-chip event-hr">New Hire Orientation</div>
                    </div>
                    <div class="calendar-day"><span class="day-number">6</span></div>
                    <div class="calendar-day"><span class="day-number">7</span></div>
                    <div class="calendar-day"><span class="day-number">8</span></div>

                    <!-- Week 3 -->
                    <div class="calendar-day"><span class="day-number">9</span></div>
                    <div class="calendar-day">
                        <span class="day-number">10</span>
                        <div class="event-chip event-sales">Q1 Strategy Review</div>
                    </div>
                    <div class="calendar-day"><span class="day-number">11</span></div>
                    <div class="calendar-day today">
                        <span class="day-number">12</span>
                        <div class="event-chip event-logistics">Container Arrival (#8821)</div>
                    </div>
                    <div class="calendar-day">
                        <span class="day-number">13</span>
                        <div class="event-chip event-hr">Company Lunch</div>
                    </div>
                    <div class="calendar-day"><span class="day-number">14</span></div>
                    <div class="calendar-day"><span class="day-number">15</span></div>

                    <!-- Week 4 -->
                    <div class="calendar-day"><span class="day-number">16</span></div>
                    <div class="calendar-day">
                        <span class="day-number">17</span>
                        <div class="event-chip event-ops">Server Maintenance</div>
                    </div>
                    <div class="calendar-day"><span class="day-number">18</span></div>
                    <div class="calendar-day"><span class="day-number">19</span></div>
                    <div class="calendar-day"><span class="day-number">20</span></div>
                    <div class="calendar-day"><span class="day-number">21</span></div>
                    <div class="calendar-day"><span class="day-number">22</span></div>

                    <!-- Week 5 -->
                    <div class="calendar-day"><span class="day-number">23</span></div>
                    <div class="calendar-day"><span class="day-number">24</span></div>
                    <div class="calendar-day"><span class="day-number">25</span></div>
                    <div class="calendar-day"><span class="day-number">26</span></div>
                    <div class="calendar-day"><span class="day-number">27</span></div>
                    <div class="calendar-day"><span class="day-number">28</span></div>
                    <div class="calendar-day other-month"><span class="day-number">1</span></div>
                </div>
            </div>

        </div>

        <!-- Add Event Modal (Hidden) -->
        <div id="addEventModal"
            style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
            <div class="card" style="width:400px; max-width:90%;">
                <h3 style="margin-top:0;">New Event</h3>
                <div style="margin-bottom:16px;">
                    <label style="display:block; font-size:12px; font-weight:700; margin-bottom:4px;">Event Name</label>
                    <input class="input" placeholder="e.g. Q2 Planning..." />
                </div>
                <div style="margin-bottom:16px;">
                    <label style="display:block; font-size:12px; font-weight:700; margin-bottom:4px;">Type</label>
                    <select class="input">
                        <option>General</option>
                        <option>Sales</option>
                        <option>HR</option>
                        <option>Logistics</option>
                    </select>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:8px;">
                    <button class="btn btn-secondary"
                        onclick="document.getElementById('addEventModal').style.display='none'">Cancel</button>
                    <button class="btn btn-primary"
                        onclick="toast('Event Created', 'Added to schedule.', 'success'); document.getElementById('addEventModal').style.display='none'">Save</button>
                </div>
            </div>
        </div>





    </main>

    <script src="erp.js"></script>
    <script>
        const EVENT_KEY = "stark_events_v1";

        // Seed Data if Empty
        let events = JSON.parse(localStorage.getItem(EVENT_KEY) || "[]");
        if (events.length === 0) {
            events = [
                {
                    id: "evt_seed_1",
                    name: "Shipment - Order #SO-8891",
                    customer: "Acme Corp",
                    date: "2026-02-15",
                    items: [{ sku: "Office Chair X1", qty: 5 }],
                    status: "Good",
                    fulfill: "Hold"
                },
                {
                    id: "evt_seed_2",
                    name: "Delivery - Order #SO-8920",
                    customer: "Stark Ind.",
                    date: "2026-02-18",
                    items: [{ sku: "Titanium Alloy Sheet", qty: 20 }],
                    status: "Risk",
                    fulfill: "Hold"
                },
                {
                    id: "evt_seed_3",
                    name: "Installation - Project Alpha",
                    customer: "Globex Corp",
                    date: "2026-02-22",
                    items: [{ sku: "Server Rack Mounts", qty: 10 }],
                    status: "Good",
                    fulfill: "Hold"
                }
            ];
            localStorage.setItem(EVENT_KEY, JSON.stringify(events));
        }

        // Render Table
        function renderEventsTable() {
            const tbody = document.getElementById("eventsListBody");
            tbody.innerHTML = "";
            let currentEvents = JSON.parse(localStorage.getItem(EVENT_KEY) || "[]");

            // URL Filter Logic
            const urlParams = new URLSearchParams(window.location.search);
            const filterItemVal = (urlParams.get('item') || "").trim();

            // Show Filter State if active
            const filterContainer = document.getElementById("activeFilterDisplay");
            if (filterItemVal) {
                // Resolve Name -> SKU using Master Items (v2)
                const masterItems = JSON.parse(localStorage.getItem("stark_erp_items_v2") || "[]");
                const foundItem = masterItems.find(i => (i.name || "").toLowerCase() === filterItemVal.toLowerCase());

                const validIdentifiers = [filterItemVal.toLowerCase()];
                if (foundItem && foundItem.sku) validIdentifiers.push(foundItem.sku.toLowerCase());

                // Filter events that contain this item
                currentEvents = currentEvents.filter(evt =>
                    evt.items && evt.items.some(line => {
                        const val = (line.sku || "").toLowerCase();
                        return validIdentifiers.includes(val);
                    })
                );

                // Inject visual feedback if not already there
                if (!filterContainer) {
                    const statusDiv = document.createElement('div');
                    statusDiv.id = "activeFilterDisplay";
                    statusDiv.style.marginBottom = "12px";
                    statusDiv.innerHTML = `
                        <div style="display:inline-flex; align-items:center; gap:8px; background:#eff6ff; border:1px solid #bfdbfe; color:#1e40af; padding:8px 12px; border-radius:6px; font-size:13px;">
                            <strong>Filtered by Item:</strong> ${filterItemVal}
                            <button onclick="window.location.href='events.html'" style="border:none; background:transparent; font-weight:700; color:#1e40af; cursor:pointer;">&times; Clear</button>
                        </div>
                    `;
                    // Insert before the customer filter input
                    const filterInputDiv = document.getElementById("customerFilter").parentNode;
                    filterInputDiv.parentNode.insertBefore(statusDiv, filterInputDiv);
                }
            } else if (filterContainer) {
                filterContainer.remove();
            }

            if (currentEvents.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted);">No events found matching <strong>${filterItemVal}</strong>.</td></tr>`;
                return;
            }

            currentEvents.forEach(evt => {
                const isRisk = evt.status === "Risk";
                const bg = isRisk ? "#fee2e2" : "#dcfce7";
                const color = isRisk ? "#991b1b" : "#166534";
                const dot = isRisk ? "#dc2626" : "#16a34a";
                const label = isRisk ? "Risk" : "Good";

                // For 'Action' button, check if allocated
                const primaryItem = evt.items && evt.items.length > 0 ? evt.items[0].sku : "General Item";
                const isAllocated = JSON.parse(localStorage.getItem('stark_allocated_items') || "[]").includes(primaryItem);

                let actionBtn;
                if (isRisk) {
                    actionBtn = `<button class="btn btn-sm btn-secondary" onclick="window.location.href='purchasing.html'" style="color:#b91c1c; border-color:#fecaca;">Order</button>`;
                } else if (isAllocated) {
                    actionBtn = `<button class="btn btn-sm btn-primary" disabled>Allocated âœ“</button>`;
                } else {
                    actionBtn = `<button class="btn btn-sm btn-secondary" onclick="allocateItem('${primaryItem}', this)">Allocate</button>`;
                }

                tbody.innerHTML += `
                     <tr style="border-bottom:1px solid #f1f5f9; transition:background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                        <td style="padding:12px 8px; font-weight:600;">
                            <a href="event_view.html?id=${evt.id}" style="color:inherit; text-decoration:none; border-bottom:1px dashed #94a3b8;">${evt.name}</a>
                        </td>
                        <td style="padding:12px 8px;">${evt.customer}</td>
                        <td style="padding:12px 8px; font-family:monospace; color:var(--text-purple-dark);">PO-${Math.floor(Math.random() * 9000) + 1000}</td>
                        <td style="padding:12px 8px;">${primaryItem}</td>
                        <td style="padding:12px 8px;">
                             <span class="badge" style="background:${bg}; color:${color}; display:inline-flex; align-items:center; gap:6px;">
                                <span style="width:6px; height:6px; background:${dot}; border-radius:50%;"></span>
                                ${label}
                            </span>
                        </td>
                        <td style="padding:12px 8px;">${actionBtn}</td>
                     </tr>
                `;
            });
        }

        // Init
        renderEventsTable();

        function allocateItem(itemName, btn) {
            // Save to localStorage
            let allocated = JSON.parse(localStorage.getItem('stark_allocated_items') || "[]");
            if (!allocated.includes(itemName)) {
                allocated.push(itemName);
                localStorage.setItem('stark_allocated_items', JSON.stringify(allocated));
            }

            // Visual Feedback
            btn.innerHTML = "Allocated âœ“";
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-primary');
            btn.disabled = true;

            toast('Inventory Allocated', `Reserved stock for ${itemName}`, 'success');
        }

        function filterTable() {
            const input = document.getElementById("customerFilter");
            const filter = input.value.toUpperCase();
            // Select the body rows of the first table (Inventory Risks table)
            const table = document.querySelector(".table-container table tbody");
            const tr = table.getElementsByTagName("tr");

            for (let i = 0; i < tr.length; i++) {
                // Customer is 2nd column (index 1)
                const td = tr[i].getElementsByTagName("td")[1];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }
    </script>

</html>
