<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Dashboard | Stark Premium ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="erp.css">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <a href="dashboard.html" class="logo">
        <img src="images/stark-logo.png" alt="Stark Premium">
        <span class="logo-text">Stark ERP</span>
      </a>

      <nav class="nav">
        <a class="nav-link active" href="dashboard.html">Home</a>
        <a class="nav-link" href="master.html">Master</a>
        <a class="nav-link" href="crm.html">CRM</a>
        <a class="nav-link" href="vendor.html">Vendor</a>
        <a class="nav-link" href="purchasing.html">Purchasing</a>
        <a class="nav-link" href="inventory.html">Inventory</a>
        <a class="nav-link" href="accounting.html">Accounting</a>
        <a class="nav-link" href="orders.html">Orders</a>
        <a class="nav-link" href="logistics.html">Logistics</a>
        <a class="nav-link" href="reports.html">Reports</a>
        <a class="nav-link" href="events.html">Events</a>
      </nav>

      <div style="display:flex; align-items:center; gap:12px;">
        <div class="badge badge-green" style="display:none; @media(min-width:700px){display:inline-flex;}">
          Online
        </div>
        <div
          style="display:flex; align-items:center; gap:8px; border-left:1px solid rgba(0,0,0,0.1); padding-left:12px; margin-left:4px;">
          <span id="navUser" style="font-size:13px; font-weight:600; color:var(--text-main);">User</span>
          <button onclick="logout()"
            style="background:none; border:none; cursor:pointer; color:var(--text-muted); font-size:12px; font-weight:600; padding:4px;">Sign
            Out</button>
        </div>
        <button class="hamburger" onclick="openMobileNav()">
          <span></span><span></span><span></span>
        </button>
      </div>
    </div>
  </header>

  <div class="mobile-nav" id="mobileNav">
    <div class="mobile-drawer">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <strong style="font-size:16px;">Navigation</strong>
        <button onclick="closeMobileNav()"
          style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
      </div>
      <a class="mobile-link active" href="dashboard.html">Home</a>
      <a class="mobile-link" href="master.html">Master</a>
      <a class="mobile-link" href="crm.html">CRM</a>
      <a class="mobile-link" href="vendor.html">Vendor</a>
      <a class="mobile-link" href="purchasing.html">Purchasing</a>
      <a class="mobile-link" href="inventory.html">Inventory</a>
      <a class="mobile-link" href="accounting.html">Accounting</a>
      <a class="mobile-link" href="orders.html">Orders</a>
      <a class="mobile-link" href="logistics.html">Logistics</a>
      <a class="mobile-link" href="reports.html">Reports</a>
      <a class="mobile-link" href="events.html">Events</a>
      <a class="mobile-link" href="trends.html">Trends</a>
    </div>
  </div>


  <main class="container">
    <div class="page-header" style="display:flex; justify-content:space-between; align-items:end;">
      <div>
        <h1 class="page-title">Dashboard</h1>
        <p class="page-desc">Premium operations overview: tasks, vendor POs, order validation, and execution cadence.
        </p>
        <div class="gold-line"></div>
      </div>
      <div style="display:flex; gap:10px; margin-bottom:12px;">
        <button class="btn secondary" onclick="loadDemoTasks()">Load Demo Tasks</button>
        <button class="btn" onclick="openTaskModal()">Add Task</button>
      </div>
    </div>



    <!-- KPI Grid -->
    <div class="kpi-grid" style="margin-bottom:24px;">
      <div class="card-kpi click-kpi" onclick="window.location.href='orders.html'">
        <div class="card-header">
          <span class="card-title">Pending Orders</span>
          <span class="stat-trend neutral"><i class="fa-solid fa-clock"></i> Today</span>
        </div>
        <div class="stat-value" id="kpiOrders">12</div>
        <div class="note">Requires validation</div>
      </div>

      <div class="card-kpi click-kpi" onclick="window.location.href='inventory.html'">
        <div class="card-header">
          <span class="card-title">Low Stock</span>
          <span class="stat-trend down">Alert</span>
        </div>
        <div class="stat-value" id="kpiStock">4</div>
        <div class="note">Items below ROP</div>
      </div>

      <div class="card-kpi click-kpi" onclick="window.location.href='purchasing.html'">
        <div class="card-header">
          <span class="card-title">Active POs</span>
          <span class="stat-trend up">On Track</span>
        </div>
        <div class="stat-value" id="kpiPO">8</div>
        <div class="note">Arriving this week</div>
      </div>

      <div class="card-kpi click-kpi" onclick="window.location.href='logistics.html'">
        <div class="card-header">
          <span class="card-title">In Transit</span>
          <span class="stat-trend neutral">Tracking</span>
        </div>
        <div class="stat-value" id="kpiShip">3</div>
        <div class="note">Shipments live</div>
      </div>

      <div class="card-kpi click-kpi" style="border-color:var(--primary); background:var(--bg-surface);"
        onclick="openTaskModal()">
        <div class="card-header">
          <span class="card-title" style="color:var(--primary);">My Tasks</span>
          <span class="badge badge-red" id="kpiTasksSub">High Priority</span>
        </div>
        <div class="stat-value" id="kpiTasks" style="color:var(--primary);">5</div>
        <div class="note">Action items due</div>
      </div>
    </div>

    <div class="grid2">
      <section class="card card-premium" style="min-height:500px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <h2>Task Manager</h2>
            <div class="gold-line" style="margin:8px 0 16px; width:40px;"></div>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn secondary" onclick="window.location.href='tasks.html'">
              <i class="fa-solid fa-up-right-from-square" style="margin-right:6px;"></i> Full Board
            </button>
            <span class="badge" style="background:#f1f5f9; color:#64748b;"><i class="fa-solid fa-users"></i> Team
              View</span>
          </div>
        </div>

        <div class="controls" style="margin-bottom:16px;">
          <input class="input" id="search" placeholder="Search task / assignees..." oninput="render()"
            style="background:#f8fafc;" />
          <select id="cat" onchange="render()" style="background:#f8fafc;">
            <option value="">All categories</option>
            <option>Purchasing</option>
            <option>Inventory</option>
            <option>Orders</option>
            <option>Logistics</option>
          </select>
          <select id="priority" onchange="render()" style="background:#f8fafc;">
            <option value="">All priority</option>
            <option>High</option>
            <option>Medium</option>
            <option>Low</option>
          </select>
          <select id="due" onchange="render()" style="background:#f8fafc;">
            <option value="">All due dates</option>
            <option value="today">Due today</option>
            <option value="overdue">Overdue</option>
            <option value="upcoming">Upcoming</option>
          </select>
        </div>

        <div class="table-wrap">
          <table style="width:100%;">
            <thead>
              <tr style="border-bottom:2px solid #f1f5f9;">
                <th style="padding-left:12px;">Task</th>
                <th>Category</th>
                <th>Priority</th>
                <th>Due</th>
                <th>Assignees</th>
                <th>Status</th>
                <th style="text-align:right; padding-right:12px;">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="note" style="margin-top:16px; display:flex; gap:8px; align-items:center;">
          <i class="fa-solid fa-circle-info" style="color:var(--primary);"></i>
          <span>Tasks utilize local storage. For multi-user sync, enable Firebase backend.</span>
        </div>
      </section>

      <aside style="display:flex; flex-direction:column; gap:20px;">

        <!-- Quick Actions Card -->
        <div class="card" style="padding:24px;">
          <h3 style="margin:0 0 12px; font-size:15px;">Quick Actions</h3>
          <div class="gold-line" style="margin:0 0 20px; width:30px;"></div>

          <div style="display:grid; gap:12px;">
            <button class="btn btn-secondary" style="justify-content:flex-start; text-align:left;"
              onclick="window.location.href='create_sku.html'">
              <span
                style="background:var(--bg-body); width:28px; height:28px; border-radius:6px; display:flex; align-items:center; justify-content:center; margin-right:8px;">+</span>
              Create New SKU
            </button>
            <button class="btn btn-secondary" style="justify-content:flex-start; text-align:left;"
              onclick="window.location.href='orders.html'">
              <span
                style="background:var(--bg-body); width:28px; height:28px; border-radius:6px; display:flex; align-items:center; justify-content:center; margin-right:8px;">ðŸ“¦</span>
              Validate Orders
            </button>
            <button class="btn btn-secondary" style="justify-content:flex-start; text-align:left;"
              onclick="window.location.href='inventory.html'">
              <span
                style="background:var(--bg-body); width:28px; height:28px; border-radius:6px; display:flex; align-items:center; justify-content:center; margin-right:8px;">ðŸ“‰</span>
              Stock Adjustment
            </button>
          </div>
        </div>

        <!-- System Status Card -->
        <div class="card" style="background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color:white;">
          <div style="display:flex; justify-content:space-between; align-items:start;">
            <div>
              <h3 style="margin:0; font-size:14px; text-transform:uppercase; letter-spacing:1px; opacity:0.8;">System
                Status</h3>
              <div style="font-size:24px; font-weight:700; margin-top:4px; color:#4ade80;">Operational</div>
            </div>
            <div style="width:10px; height:10px; background:#4ade80; border-radius:50%; box-shadow:0 0 10px #4ade80;">
            </div>
          </div>
          <div style="height:1px; background:rgba(255,255,255,0.1); margin:16px 0;"></div>
          <div style="font-size:12px; opacity:0.6; line-height:1.5;">
            Database: <strong>Local (v2.1)</strong><br>
            Sync: <strong>Manual</strong><br>
            Last Backup: <strong>Today, 09:00 AM</strong>
          </div>
        </div>

      </aside>
    </div>

    <div class="footer">Â© 2026 Stark Premium. All rights reserved.</div>
  </main>

  <div class="modal" id="taskModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Add Task</h3>
        <button class="x" onclick="closeTaskModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="modal-grid">
          <input id="tSubject" class="input" placeholder="Task subject (required)" />
          <select id="tCat">
            <option>Purchasing</option>
            <option>Inventory</option>
            <option>Orders</option>
            <option>Logistics</option>
          </select>
          <select id="tPri">
            <option>High</option>
            <option selected>Medium</option>
            <option>Low</option>
          </select>

          <input id="tDue" class="input" type="date" />
          <input id="tTime" class="input" type="time" />
          <input id="tAssign" class="input" placeholder="Assignees (e.g. Alex, Sarah). Comma separated." />
        </div>
      </div>
      <div class="modal-footer">
        <span class="note">Task will appear on assignees' dashboard immediately.</span>
        <div style="display:flex; gap:10px;">
          <button class="btn secondary" onclick="closeTaskModal()">Cancel</button>
          <button class="btn" onclick="addTask()">Save Task</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

  <script src="erp.js"></script>
  <script>
    const AUTH_KEY = "stark_erp_auth_v1";
    const TASK_KEY = "stark_erp_tasks_v2";

    function requireAuth() {
      try {
        const auth = JSON.parse(localStorage.getItem(AUTH_KEY) || "null");
        if (!auth || !auth.user) window.location.href = "index.html";
        else {
          // Display User Name
          const userEl = document.getElementById("navUser");
          if (userEl) userEl.textContent = auth.user;
        }
      } catch { window.location.href = "index.html"; }
    }
    requireAuth();

    function logout() {
      localStorage.removeItem(AUTH_KEY);
      window.location.href = "index.html";
    }

    function openTaskModal() {
      document.getElementById("tSubject").value = "";
      document.getElementById("tAssign").value = "";
      document.getElementById("tDue").value = "";
      document.getElementById("tTime").value = "";
      document.getElementById("taskModal").classList.add("open");
    }
    function closeTaskModal() { document.getElementById("taskModal").classList.remove("open"); }

    function addTask() {
      const subject = (document.getElementById("tSubject").value || "").trim();
      const cat = document.getElementById("tCat").value;
      const pri = document.getElementById("tPri").value;
      const due = document.getElementById("tDue").value;
      const time = document.getElementById("tTime").value;
      const assignRaw = (document.getElementById("tAssign").value || "");
      const assignees = assignRaw.split(",").map(s => s.trim()).filter(Boolean);

      if (!subject) return toast("Missing field", "Task subject is required.");

      window.taskStore.add({
        subject,
        cat,
        priority: pri,
        dueDate: due || "",
        time: time || "",
        assignees,
        status: "Open"
      });

      closeTaskModal();
      toast("Task added", "Task shared with team.");
    }

    function toggleDone(id) {
      const t = window.taskStore.getAll().find(x => x.id === id);
      if (t) window.taskStore.update(id, { status: t.status === "Completed" ? "Open" : "Completed" });
    }

    function removeTask(id) {
      if (confirm("Delete this task?")) window.taskStore.delete(id);
    }

    function loadDemoTasks() {
      if (!confirm("Add shared demo tasks?")) return;
      const d0 = new Date().toISOString().split('T')[0];

      const demos = [
        { subject: "Approve PO #PO-1042 (Vendor: Delta Supplies)", cat: "Purchasing", priority: "High", dueDate: d0, time: "14:00", assignees: ["Admin", "Alex"], status: "Open" },
        { subject: "Validate Order #SO-8891 (payment pending)", cat: "Orders", priority: "High", dueDate: d0, time: "16:00", assignees: ["Admin", "Sarah"], status: "Open" },
        { subject: "Follow up on delayed shipment", cat: "Logistics", priority: "Medium", dueDate: "", time: "", assignees: ["Charlie"], status: "Open" }
      ];

      demos.forEach(d => window.taskStore.add(d));
      toast("Demo loaded", "Shared tasks added.");
    }

    // Subscribe to store updates for Real-Time rendering
    window.taskStore.subscribe(render);

    function dueBucket(due) {
      if (!due) return "upcoming";
      const d = new Date(due + "T00:00:00");
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if (d.getTime() === today.getTime()) return "today";
      if (d.getTime() < today.getTime()) return "overdue";
      return "upcoming";
    }

    function updateKPIs() {
      try {
        // 1. Pending Orders
        const orders = JSON.parse(localStorage.getItem("stark_erp_orders_v1") || "[]");
        const pendingOrders = orders.filter(o => o.status === "Validated" || o.status === "Processing").length;
        const kpiOrders = document.getElementById("kpiOrders");
        if (kpiOrders) kpiOrders.textContent = pendingOrders;

        // 2. Low Stock
        const items = JSON.parse(localStorage.getItem("stark_erp_items_v2") || "[]");
        const lowStock = items.filter(i => (parseInt(i.on) || 0) < (parseInt(i.rop) || 5)).length;
        const kpiStock = document.getElementById("kpiStock");
        if (kpiStock) kpiStock.textContent = lowStock;

        // 3. Active POs
        const pos = JSON.parse(localStorage.getItem("stark_erp_pos_v1") || "[]");
        const activePOs = pos.filter(p => p.status === "Open" || p.status === "Approved").length;
        const kpiPO = document.getElementById("kpiPO");
        if (kpiPO) kpiPO.textContent = activePOs;

        // 4. Shipments (Mock for now)
        const kpiShip = document.getElementById("kpiShip");
        if (kpiShip) kpiShip.textContent = "3";
      } catch (e) {
        console.error("Error updating KPIs", e);
      }
    }

    function render() {
      const search = (document.getElementById("search").value || "").toLowerCase();
      const cat = document.getElementById("cat").value;
      const pri = document.getElementById("priority").value;
      const due = document.getElementById("due").value;

      const list = window.taskStore.getAll();

      const filtered = list.filter(t => {
        if (cat && t.cat !== cat) return false;
        if (pri && t.priority !== pri) return false;
        if (due && dueBucket(t.dueDate) !== due) return false;

        if (search) {
          const blob = `${t.subject || t.title} ${t.cat} ${t.priority} ${(t.assignees || []).join(",")}`.toLowerCase();
          if (!blob.includes(search)) return false;
        }
        updateKPIs(); // Update other KPIs when tasks render
        return true;
      });

      // KPI Tasks
      const pending = list.filter(t => t.status !== "Completed").length;
      const dueToday = list.filter(t => t.status !== "Completed" && dueBucket(t.dueDate) === "today").length;
      const high = list.filter(t => t.status !== "Completed" && t.priority === "High").length;

      const kpiTasks = document.getElementById("kpiTasks");
      if (kpiTasks) kpiTasks.textContent = String(pending);

      const kpiSub = document.getElementById("kpiTasksSub");
      if (kpiSub) kpiSub.textContent = `${high} High Priority`;

      const tbody = document.getElementById("tbody");
      if (!tbody) return;
      tbody.innerHTML = "";

      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="note" style="text-align:center; padding:20px;">No tasks match your filters.</td></tr>`;
        return;
      }

      for (const t of filtered) {
        const priTag = t.priority === "High" ? "bad" : (t.priority === "Medium" ? "warn" : "good");
        const dueText = t.dueDate ? t.dueDate : "â€”";
        const statusTag = t.status === "Completed" ? `<span class="pilltag good">Completed</span>` : `<span class="pilltag warn">Open</span>`;
        const subj = t.subject || t.title || "No Subject";

        const tr = document.createElement("tr");
        tr.style.borderBottom = "1px solid #f8fafc";
        tr.innerHTML = `
          <td>
             <div style="font-weight:600; color:var(--text-main);">${escapeHtml(subj)}</div>
             <div class="note" style="font-size:10px;">${new Date(t.createdAt).toLocaleDateString()}</div>
          </td>
          <td><span class="badge" style="background:#f1f5f9; color:#475569;">${escapeHtml(t.cat || 'General')}</span></td>
          <td><span class="pilltag ${priTag}">${escapeHtml(t.priority)}</span></td>
          <td style="font-size:13px; font-variant-numeric:tabular-nums;">${escapeHtml(dueText)} ${t.time ? `<span style="color:var(--text-muted); font-size:11px;">${escapeHtml(t.time)}</span>` : ""}</td>
          <td>${escapeHtml((t.assignees || []).join(", ") || "â€”")}</td>
          <td>${statusTag}</td>
          <td style="text-align:right;">
            <button class="btn secondary" style="padding:4px 8px; height:28px; font-size:11px;" onclick="toggleDone('${t.id}')">${t.status === "Completed" ? "Reopen" : "Done"}</button>
            <button class="btn secondary" style="padding:4px 8px; height:28px; font-size:11px; color:var(--bad); border-color:var(--bad-bg);" onclick="removeTask('${t.id}')">
              <i class="fa-solid fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    render();
  </script>
</body>

</html>
