<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard | Stark Premium ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="erp.css">
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="logo"><img src="images/stark-logo.png" alt="Stark Premium" /></div>

      <button class="hamburger" type="button" aria-label="Open menu" onclick="openMobileNav()">
        <span></span><span></span><span></span>
      </button>

      <nav class="nav" aria-label="ERP Navigation">
        <a class="active" href="dashboard.html">Home</a>
        <a href="account.html">Account</a>
        <a href="crm.html">CRM</a>
        <a href="inventory.html">Inventory</a>
        <a href="orders.html">Orders</a>
        <a href="logistics.html">Logistics</a>
        <a href="trends.html">Trends</a>
      </nav>

      <div class="top-actions">
        <div class="pill"><span class="dot"></span>Online</div>
        <button class="btn secondary" onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <div class="mobile-nav" id="mobileNav" aria-hidden="true">
    <div class="mobile-card">
      <div class="mobile-head">
        <strong>Menu</strong>
        <button class="mobile-close" type="button" aria-label="Close menu" onclick="closeMobileNav()">×</button>
      </div>
      <div class="mobile-links">
        <a class="active" href="dashboard.html">Home</a>
        <a href="account.html">Account</a>
        <a href="crm.html">CRM</a>
        <a href="inventory.html">Inventory</a>
        <a href="orders.html">Orders</a>
        <a href="logistics.html">Logistics</a>
        <a href="trends.html">Trends</a>
      </div>
    </div>
  </div>

  <main class="wrap">
    <section class="hero">
      <div class="hrow">
        <div>
          <h1>Welcome to Stark Premium ERP</h1>
          <p>Premium operations overview: tasks, vendor POs, order validation, and execution cadence — optimized for speed and clarity.</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn secondary" onclick="loadDemoTasks()">Load Demo Tasks</button>
          <button class="btn" onclick="openTaskModal()">Add Task</button>
        </div>
      </div>
    </section>

    <section class="kpis">
      <div class="card kpi">
        <div class="kpiTop">
          <div class="label">My pending tasks</div>
          <div class="chip warn">Review</div>
        </div>
        <div class="value" id="kpiTasks">0</div>
        <div class="sub" id="kpiTasksSub">—</div>
      </div>

      <div class="card kpi">
        <div class="kpiTop">
          <div class="label">Open vendor POs</div>
          <div class="chip warn">In progress</div>
        </div>
        <div class="value" id="kpiOpenPO">18</div>
        <div class="sub">Awaiting confirmation / approvals</div>
      </div>

      <div class="card kpi">
        <div class="kpiTop">
          <div class="label">Validated orders</div>
          <div class="chip good">Healthy</div>
        </div>
        <div class="value" id="kpiValid">124</div>
        <div class="sub">Ready for picking & dispatch</div>
      </div>

      <div class="card kpi">
        <div class="kpiTop">
          <div class="label">Non-validated orders</div>
          <div class="chip bad">Attention</div>
        </div>
        <div class="value" id="kpiNonValid">9</div>
        <div class="sub">Missing payment / address / stock</div>
      </div>
    </section>

    <div class="grid2">
      <section class="panel">
        <h2>Task Manager</h2>
        <div class="goldline"></div>

        <div class="controls">
          <input class="input" id="search" placeholder="Search task / assignees..." oninput="render()" />
          <select id="cat" onchange="render()">
            <option value="">All categories</option>
            <option>Purchasing</option>
            <option>Inventory</option>
            <option>Orders</option>
            <option>Logistics</option>
          </select>
          <select id="priority" onchange="render()">
            <option value="">All priority</option>
            <option>High</option>
            <option>Medium</option>
            <option>Low</option>
          </select>
          <select id="due" onchange="render()">
            <option value="">All due dates</option>
            <option value="today">Due today</option>
            <option value="overdue">Overdue</option>
            <option value="upcoming">Upcoming</option>
          </select>
        </div>

        <div class="table-wrap" style="margin-top:12px;">
          <table>
            <thead>
              <tr>
                <th>Task</th>
                <th>Category</th>
                <th>Priority</th>
                <th>Due</th>
                <th>Assignees (A/B/C/D)</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="note" style="margin-top:12px;">
          Notes: This version stores tasks in <strong>localStorage</strong> (single device). Multi-user shared tasks requires Firebase/DB later.
        </div>
      </section>

      <aside class="panel">
        <h2>Quick Actions</h2>
        <div class="goldline"></div>

        <button class="btn secondary" style="width:100%; margin-bottom:10px;" onclick="window.location.href='inventory.html'">
          Review low stock items
        </button>
        <button class="btn secondary" style="width:100%; margin-bottom:10px;" onclick="window.location.href='orders.html'">
          Validate pending orders
        </button>
        <button class="btn secondary" style="width:100%; margin-bottom:10px;" onclick="window.location.href='logistics.html'">
          Track shipments
        </button>
        <button class="btn" style="width:100%;" onclick="openTaskModal()">
          Add Task
        </button>
      </aside>
    </div>

    <div class="footer">© 2026 Stark Premium. All rights reserved.</div>
  </main>

  <div class="modal" id="taskModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Add Task</h3>
        <button class="x" onclick="closeTaskModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-grid">
          <input id="tTitle" class="input" placeholder="Task title (required)" />
          <select id="tCat">
            <option>Purchasing</option>
            <option>Inventory</option>
            <option>Orders</option>
            <option>Logistics</option>
          </select>
          <select id="tPri">
            <option>High</option>
            <option selected>Medium</option>
            <option>Low</option>
          </select>

          <input id="tDue" class="input" type="date" />
          <input id="tTime" class="input" type="time" />
          <input id="tAssign" class="input" placeholder="Assignees (A,B,C,D). Example: A,B" />
        </div>
      </div>
      <div class="modal-footer">
        <span class="note">Reminders: stored locally. For real reminders to other users, use Firebase later.</span>
        <div style="display:flex; gap:10px;">
          <button class="btn secondary" onclick="closeTaskModal()">Cancel</button>
          <button class="btn" onclick="addTask()">Save Task</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

  <script src="erp.js"></script>
  <script>
    const AUTH_KEY = "stark_erp_auth_v1";
    const TASK_KEY = "stark_erp_tasks_v2";

    function requireAuth(){
      try{
        const auth = JSON.parse(localStorage.getItem(AUTH_KEY) || "null");
        if (!auth || !auth.user) window.location.href = "index.html";
      }catch{ window.location.href = "index.html"; }
    }
    requireAuth();

    function logout(){
      localStorage.removeItem(AUTH_KEY);
      window.location.href = "index.html";
    }

    function loadTasks(){
      try{ return JSON.parse(localStorage.getItem(TASK_KEY) || "[]"); }catch{ return []; }
    }
    function saveTasks(list){ localStorage.setItem(TASK_KEY, JSON.stringify(list)); }

    function uid(){
      return "T-" + Math.random().toString(16).slice(2,8).toUpperCase() + "-" + Date.now().toString(16).slice(-4).toUpperCase();
    }

    function openTaskModal(){
      document.getElementById("tTitle").value = "";
      document.getElementById("tAssign").value = "A";
      document.getElementById("tDue").value = "";
      document.getElementById("tTime").value = "";
      document.getElementById("taskModal").classList.add("open");
    }
    function closeTaskModal(){ document.getElementById("taskModal").classList.remove("open"); }

    function addTask(){
      const title = (document.getElementById("tTitle").value || "").trim();
      const cat = document.getElementById("tCat").value;
      const pri = document.getElementById("tPri").value;
      const due = document.getElementById("tDue").value; // yyyy-mm-dd
      const time = document.getElementById("tTime").value; // hh:mm
      const assignRaw = (document.getElementById("tAssign").value || "").toUpperCase();
      const assignees = assignRaw.split(",").map(s=>s.trim()).filter(Boolean);

      if (!title) return toast("Missing field", "Task title is required.");

      const list = loadTasks();
      list.unshift({
        id: uid(),
        title, cat, pri,
        due: due || "",
        time: time || "",
        assignees,
        status: "Open",
        createdAt: Date.now()
      });
      saveTasks(list);
      closeTaskModal();
      toast("Task added", "Task saved to your dashboard.");
      render();
    }

    function toggleDone(id){
      const list = loadTasks();
      const t = list.find(x=>x.id===id);
      if (!t) return;
      t.status = (t.status === "Completed") ? "Open" : "Completed";
      saveTasks(list);
      render();
    }

    function removeTask(id){
      const list = loadTasks().filter(x=>x.id!==id);
      saveTasks(list);
      render();
    }

    function loadDemoTasks(){
      const list = loadTasks();
      if (list.length && !confirm("This will add demo tasks. Continue?")) return;

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,"0");
      const dd = String(today.getDate()).padStart(2,"0");
      const d0 = `${yyyy}-${mm}-${dd}`;

      const demo = [
        { title:"Approve PO #PO-1042 (Vendor: Delta Supplies)", cat:"Purchasing", pri:"High", due:d0, time:"14:00", assignees:["A","B"], status:"Open" },
        { title:"Validate Order #SO-8891 (payment pending)", cat:"Orders", pri:"High", due:d0, time:"16:00", assignees:["A","C"], status:"Open" },
        { title:"Follow up on delayed shipment (Carrier: Xpress)", cat:"Logistics", pri:"Medium", due:"", time:"", assignees:["B","D"], status:"Open" },
        { title:"Cycle count: Warehouse A (Zone 3)", cat:"Inventory", pri:"Low", due:"", time:"", assignees:["A"], status:"Open" }
      ];

      const merged = demo.map(x=>({ id: uid(), createdAt: Date.now(), ...x })).concat(list);
      saveTasks(merged);
      toast("Demo loaded", "Demo tasks added.");
      render();
    }

    function dueBucket(due){
      if (!due) return "upcoming";
      const d = new Date(due + "T00:00:00");
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if (d.getTime() === today.getTime()) return "today";
      if (d.getTime() < today.getTime()) return "overdue";
      return "upcoming";
    }

    function render(){
      const search = (document.getElementById("search").value || "").toLowerCase();
      const cat = document.getElementById("cat").value;
      const pri = document.getElementById("priority").value;
      const due = document.getElementById("due").value;

      const list = loadTasks();

      const filtered = list.filter(t=>{
        if (cat && t.cat !== cat) return false;
        if (pri && t.pri !== pri) return false;
        if (due && dueBucket(t.due) !== due) return false;

        if (search){
          const blob = `${t.title} ${t.cat} ${t.pri} ${(t.assignees||[]).join(",")}`.toLowerCase();
          if (!blob.includes(search)) return false;
        }
        return true;
      });

      // KPI
      const pending = list.filter(t=>t.status!=="Completed").length;
      const dueToday = list.filter(t=>t.status!=="Completed" && dueBucket(t.due)==="today").length;
      const high = list.filter(t=>t.status!=="Completed" && t.pri==="High").length;

      document.getElementById("kpiTasks").textContent = String(pending);
      document.getElementById("kpiTasksSub").textContent =
        `${high} high priority · ${dueToday} due today`;

      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      if (!filtered.length){
        tbody.innerHTML = `<tr><td colspan="7" class="note">No tasks match your filters.</td></tr>`;
        return;
      }

      for (const t of filtered){
        const priTag = t.pri==="High" ? "bad" : (t.pri==="Medium" ? "warn" : "good");
        const dueText = t.due ? t.due : "—";
        const statusTag = t.status==="Completed" ? `<span class="pilltag good">Completed</span>` : `<span class="pilltag warn">Open</span>`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><strong>${escapeHtml(t.title)}</strong><div class="note">Created: ${new Date(t.createdAt).toLocaleString()}</div></td>
          <td>${escapeHtml(t.cat)}</td>
          <td><span class="pilltag ${priTag}">${escapeHtml(t.pri)}</span></td>
          <td>${escapeHtml(dueText)} ${t.time ? `<span class="pilltag" style="margin-left:6px;">${escapeHtml(t.time)}</span>` : ""}</td>
          <td>${escapeHtml((t.assignees||[]).join(", ") || "—")}</td>
          <td>${statusTag}</td>
          <td>
            <button class="btn secondary" onclick="toggleDone('${t.id}')">${t.status==="Completed" ? "Reopen" : "Complete"}</button>
            <button class="btn secondary" onclick="removeTask('${t.id}')" style="margin-left:8px;">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    render();
  </script>
</body>
</html>
