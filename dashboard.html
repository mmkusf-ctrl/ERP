<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard | Stark Premium ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="erp.css">
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="logo"><img src="images/stark-logo.png" alt="Stark Premium" /></div>

      <button class="hamburger" type="button" aria-label="Open menu" onclick="openMobileNav()">
        <span></span><span></span><span></span>
      </button>

      <nav class="nav" aria-label="ERP Navigation">
        <a href="dashboard.html" class="active">Home</a>
        <a href="account.html">Account</a>
        <a href="crm.html">CRM</a>
        <a href="inventory.html">Inventory</a>
        <a href="orders.html">Orders</a>
        <a href="logistics.html">Logistics</a>
        <a href="trends.html">Trends</a>
      </nav>

      <div class="top-actions">
        <div class="pill"><span class="dot"></span>Online</div>
        <button class="btn secondary" onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <div class="mobile-nav" id="mobileNav" aria-hidden="true">
    <div class="mobile-card">
      <div class="mobile-head">
        <strong>Menu</strong>
        <button class="mobile-close" type="button" aria-label="Close menu" onclick="closeMobileNav()">×</button>
      </div>
      <div class="mobile-links">
        <a class="active" href="dashboard.html">Home</a>
        <a href="account.html">Account</a>
        <a href="crm.html">CRM</a>
        <a href="inventory.html">Inventory</a>
        <a href="orders.html">Orders</a>
        <a href="logistics.html">Logistics</a>
        <a href="trends.html">Trends</a>
      </div>
    </div>
  </div>

  <main class="wrap">
    <div class="hero">
      <h1 class="h-title">Welcome to Stark Premium ERP</h1>
      <p class="h-sub">Premium operational overview. Tasks are stored locally for now (Firebase later). Use assignments (A/B/C/D) to share tasks conceptually.</p>
      <div class="toast-wrap" id="toastWrap"></div>
    </div>

    <section class="kpis">
      <div class="card">
        <div class="card-top"><div class="label">My Pending Tasks</div><div class="chip warn">Local</div></div>
        <div class="value" id="kTasks">0</div>
        <div class="sub">Tasks assigned to selected user</div>
      </div>

      <div class="card">
        <div class="card-top"><div class="label">Open Vendor POs</div><div class="chip warn">In progress</div></div>
        <div class="value" id="kPO">18</div>
        <div class="sub">7 awaiting confirmation, 3 delayed</div>
      </div>

      <div class="card">
        <div class="card-top"><div class="label">Validated Orders</div><div class="chip good">Healthy</div></div>
        <div class="value" id="kVal">124</div>
        <div class="sub">Ready for picking & dispatch</div>
      </div>

      <div class="card">
        <div class="card-top"><div class="label">Non-validated Orders</div><div class="chip bad">Attention</div></div>
        <div class="value" id="kNon">9</div>
        <div class="sub">Missing payment / address / stock</div>
      </div>
    </section>

    <div class="grid2">
      <section class="section">
        <h2>Task Manager</h2>
        <div class="goldline"></div>

        <div class="controls">
          <input id="tTitle" class="input" placeholder="Task (e.g., Review Vendor PO-1042)" />
          <input id="tDue" class="input" type="datetime-local" />
          <select id="tCat">
            <option>Purchasing</option>
            <option>Inventory</option>
            <option>Orders</option>
            <option>Logistics</option>
          </select>
          <select id="tPri">
            <option>High</option>
            <option selected>Medium</option>
            <option>Low</option>
          </select>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 220px; gap:10px; margin-top:10px;">
          <input id="tAssign" class="input" placeholder="Assign to (A,B,C,D). Example: A,B" />
          <button class="btn" onclick="addTask()">Add Task</button>
        </div>

        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px;">
          <label style="display:flex;align-items:center;gap:8px;color:#667085;font-size:12px;">
            <input type="checkbox" id="dueTodayOnly" onchange="renderTasks()">
            Due today only
          </label>

          <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
            <select id="userSel" class="input" style="width:160px; padding:10px 10px;" onchange="renderTasks()">
              <option>User A</option>
              <option>User B</option>
              <option>User C</option>
              <option>User D</option>
            </select>
            <button class="btn secondary" onclick="clearDone()">Clear completed</button>
          </div>
        </div>

        <div style="margin-top:14px;" class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Task</th>
                <th>Category</th>
                <th>Priority</th>
                <th>Assigned</th>
                <th>Due</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="taskBody"></tbody>
          </table>
        </div>
      </section>

      <aside class="section">
        <h2>Quick Actions</h2>
        <div class="goldline"></div>

        <button class="btn secondary" style="width:100%;margin-bottom:10px;" onclick="window.location.href='orders.html'">Review non-validated orders</button>
        <button class="btn secondary" style="width:100%;margin-bottom:10px;" onclick="window.location.href='inventory.html'">Check low stock items</button>
        <button class="btn secondary" style="width:100%;margin-bottom:10px;" onclick="window.location.href='logistics.html'">Track pending shipments</button>
        <button class="btn secondary" style="width:100%;" onclick="window.location.href='inventory.html#po'">Manage vendors & approvals</button>

        <div style="margin-top:14px;color:#667085;font-size:12px;line-height:1.5;">
          Reminders are local (browser). For multi-user shared tasks you will use Firebase later.
        </div>
      </aside>
    </div>
  </main>

  <script src="erp.js"></script>
  <script>
    requireAuth();
    setActiveNav("dashboard.html");

    const TASK_KEY = "stark_erp_tasks_v2";

    function loadTasks(){
      try { return JSON.parse(localStorage.getItem(TASK_KEY) || "[]"); }
      catch { return []; }
    }
    function saveTasks(t){ localStorage.setItem(TASK_KEY, JSON.stringify(t)); }

    function uid(){ return "T-" + Math.random().toString(16).slice(2,8).toUpperCase(); }

    function addTask(){
      const title = (document.getElementById("tTitle").value||"").trim();
      const due = (document.getElementById("tDue").value||"").trim();
      const cat = document.getElementById("tCat").value;
      const pri = document.getElementById("tPri").value;
      const assign = (document.getElementById("tAssign").value||"").trim();

      if(!title) return toast("Missing task", "Please enter a task title.");

      const list = loadTasks();
      list.unshift({
        id: uid(),
        title, cat, pri,
        assigned: assign || "A",
        due: due || "",
        done: false,
        createdAt: Date.now()
      });
      saveTasks(list);

      document.getElementById("tTitle").value="";
      document.getElementById("tAssign").value="";
      toast("Task added", "Task saved to your browser.");
      renderTasks();
    }

    function toggleDone(id){
      const list = loadTasks();
      const t = list.find(x => x.id === id);
      if(!t) return;
      t.done = !t.done;
      saveTasks(list);
      renderTasks();
    }

    function clearDone(){
      const list = loadTasks().filter(x => !x.done);
      saveTasks(list);
      toast("Cleared", "Completed tasks removed.");
      renderTasks();
    }

    function isDueToday(isoLocal){
      if(!isoLocal) return false;
      const d = new Date(isoLocal);
      if (isNaN(d.getTime())) return false;
      const now = new Date();
      return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth() && d.getDate()===now.getDate();
    }

    function renderTasks(){
      const tbody = document.getElementById("taskBody");
      tbody.innerHTML = "";

      const user = document.getElementById("userSel").value.replace("User ","").trim(); // A/B/C/D
      const dueTodayOnly = document.getElementById("dueTodayOnly").checked;

      const list = loadTasks().filter(t => {
        const assigned = (t.assigned||"").toUpperCase();
        const matchUser = assigned.split(",").map(s=>s.trim()).filter(Boolean).includes(user);
        if(!matchUser) return false;
        if(dueTodayOnly) return isDueToday(t.due);
        return true;
      });

      document.getElementById("kTasks").textContent = String(list.filter(x=>!x.done).length);

      if(list.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" style="color:#667085;">No tasks found for User ${user}.</td></tr>`;
        return;
      }

      for(const t of list){
        const priTag = t.pri==="High" ? "bad" : (t.pri==="Medium" ? "warn" : "good");
        const status = t.done ? `<span class="pilltag good">Completed</span>` : `<span class="pilltag warn">Open</span>`;
        const dueText = t.due ? new Date(t.due).toLocaleString() : "—";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><strong>${escapeHtml(t.title)}</strong></td>
          <td>${escapeHtml(t.cat)}</td>
          <td><span class="pilltag ${priTag}">${escapeHtml(t.pri)}</span></td>
          <td>${escapeHtml(t.assigned)}</td>
          <td>${escapeHtml(dueText)}</td>
          <td>
            ${status}
            <button class="btn secondary" style="height:32px;margin-left:10px;" onclick="toggleDone('${t.id}')">
              ${t.done ? "Reopen" : "Done"}
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    renderTasks();
  </script>
</body>
</html>
