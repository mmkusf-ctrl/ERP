<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Vendor | Stark Premium ERP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Top Navigation -->
    <header class="topbar">
        <div class="topbar-inner">
            <a href="dashboard.html" class="logo">
                <img src="images/stark-logo.png" alt="Stark Premium">
                <span class="logo-text">Stark ERP</span>
            </a>

            <nav class="nav">
                <a class="nav-link" href="dashboard.html">Home</a>
                <a class="nav-link" href="master.html">Master</a>
                <a class="nav-link" href="crm.html">CRM</a>
                <a class="nav-link active" href="vendor.html">Vendor</a>
                <a class="nav-link" href="purchasing.html">Purchasing</a>
                <a class="nav-link" href="inventory.html">Inventory</a>
                <a class="nav-link" href="accounting.html">Accounting</a>
                <a class="nav-link" href="orders.html">Orders</a>
                <a class="nav-link" href="logistics.html">Logistics</a>
                <a class="nav-link" href="reports.html">Reports</a>
                <a class="nav-link" href="events.html">Events</a>
            </nav>

            <div style="display:flex; align-items:center; gap:12px;">
                <div class="badge badge-green" style="display:none; @media(min-width:700px){display:inline-flex;}">
                    Online
                </div>
                <button class="hamburger" onclick="openMobileNav()">
                    <span></span><span></span><span></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Drawer -->
    <div class="mobile-nav" id="mobileNav">
        <div class="mobile-drawer">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <strong style="font-size:16px;">Navigation</strong>
                <button onclick="closeMobileNav()"
                    style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <a class="mobile-link" href="dashboard.html">Home</a>
            <a class="mobile-link" href="master.html">Master</a>
            <a class="mobile-link" href="crm.html">CRM</a>
            <a class="mobile-link active" href="vendor.html">Vendor</a>
            <a class="mobile-link" href="purchasing.html">Purchasing</a>
            <a class="mobile-link" href="inventory.html">Inventory</a>
            <a class="mobile-link" href="accounting.html">Accounting</a>
            <a class="mobile-link" href="orders.html">Orders</a>
            <a class="mobile-link" href="logistics.html">Logistics</a>
            <a class="mobile-link" href="reports.html">Reports</a>
            <a class="mobile-link" href="events.html">Events</a>
            <a class="mobile-link" href="trends.html">Trends</a>
        </div>
    </div>

    <main class="container" style="padding-top:40px;">

        <!-- Header -->
        <div class="page-header">
            <h1 class="page-title">Vendor Management</h1>
            <p class="page-desc">Track supplier performance, diverse procurement sources, and contract status.</p>
            <div class="gold-line"></div>
        </div>

        <!-- Stats -->
        <!-- Stats -->
        <section style="display:flex; gap:24px; margin-bottom:32px;">
            <article class="card-kpi clickable-kpi active" onclick="setFilter('all')" id="kpiAll" style="flex:1">
                <div class="card-header">
                    <div class="card-title">Total Vendors</div>
                    <div class="badge badge-green">Network</div>
                </div>
                <div class="stat-value" id="kVendors">0</div>
                <div class="stat-trend neutral">Global Supply</div>
            </article>

            <article class="card-kpi clickable-kpi" onclick="setFilter('top')" id="kpiTop" style="flex:1">
                <div class="card-header">
                    <div class="card-title">Top Rated</div>
                    <div class="badge badge-green">Elite</div>
                </div>
                <div class="stat-value" id="kTop">0</div>
                <div class="stat-trend up">Performance > 90%</div>
            </article>

            <article class="card-kpi clickable-kpi" onclick="setFilter('risk')" id="kpiRisk" style="flex:1">
                <div class="card-header">
                    <div class="card-title">At Risk</div>
                    <div class="badge badge-red">Attention</div>
                </div>
                <div class="stat-value" id="kRisk">0</div>
                <div class="stat-trend down">Rating < 70%</div>
            </article>


        </section>

        <!-- Main Content -->
        <div class="grid grid-2" style="align-items:start;">
            <!-- Directory -->
            <section class="card" style="grid-column: span 2; @media(min-width: 1000px){ grid-column: auto; }">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <h2 style="font-size:18px; margin:0;" id="dirTitle">Vendor Directory</h2>
                        <span class="badge" id="listBadge"
                            style="display:none; background:var(--primary); color:white;">Filtered</span>
                    </div>
                    <button class="btn btn-primary" onclick="window.location.href='vendor_add.html'"
                        style="height:32px; font-size:13px; padding:0 16px;">
                        + Add Vendor
                    </button>
                </div>

                <input id="search" class="input" placeholder="Search vendors..." oninput="render()"
                    style="margin-bottom:16px;" />

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Vendor</th>
                                <th>Category</th>
                                <th>Rating</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="vBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Details -->
            <aside
                style="display:grid; gap:24px; align-content:start; display:none; @media(min-width: 1000px){ display:grid; }">
                <div class="card">
                    <h2 style="font-size:16px; margin:0 0 16px;">Vendor Profile</h2>

                    <div id="detailPlaceholder"
                        style="padding:40px 0; text-align:center; color:var(--text-muted); font-size:13px;">
                        Select a vendor to view details.
                    </div>

                    <div id="detailContent" style="display:none;">
                        <div
                            style="background:var(--bg-body); padding:20px; border-radius:var(--radius-md); border:1px solid var(--border); margin-bottom:16px;">
                            <strong style="display:block; font-size:18px; margin-bottom:4px;" id="dName">Name</strong>
                            <div style="font-size:13px; color:var(--text-muted); margin-bottom:12px;" id="dCat">Category
                            </div>

                            <div style="display:grid; gap:8px; font-size:13px;">
                                <div style="display:flex; gap:8px;">
                                    <span style="color:var(--text-muted); width:20px;">üìç</span> <span
                                        id="dLoc">Location</span>
                                </div>
                                <div style="display:flex; gap:8px;">
                                    <span style="color:var(--text-muted); width:20px;">üë§</span> <span
                                        id="dContact">Contact</span>
                                </div>
                                <div style="display:flex; gap:8px;">
                                    <span style="color:var(--text-muted); width:20px;">üìß</span> <span
                                        id="dEmail">Email</span>
                                </div>
                            </div>
                        </div>

                        <div
                            style="background:#f8fafc; padding:16px; border-radius:var(--radius-md); border:1px solid var(--border); margin-bottom:12px;">
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <span style="font-size:13px; font-weight:600;">Performance Score</span>
                                <span class="badge" id="dScoreBadge">0%</span>
                            </div>
                            <div style="height:6px; background:#e2e8f0; border-radius:3px; overflow:hidden;">
                                <div id="dScoreBar"
                                    style="height:100%; width:0%; background:var(--primary); transition:width 0.5s;">
                                </div>
                            </div>
                        </div>

                        <div
                            style="background:#f8fafc; padding:16px; border-radius:var(--radius-md); border:1px solid var(--border);">
                            <strong style="display:block; font-size:13px; margin-bottom:6px;">Payment Terms</strong>
                            <div id="dTerms" style="font-size:13px; color:var(--text-muted);">Net 30</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><span class="card-title">Setup</span></div>
                    <button class="btn btn-secondary" style="width:100%;" onclick="seedVendors()">Generate Demo
                        Vendors</button>
                </div>
            </aside>
        </div>

        <div style="margin-top:40px; text-align:center; color:var(--text-muted); font-size:13px;">
            &copy; 2026 Stark Premium ERP.
        </div>
    </main>

    <!-- Add Vendor Modal --></div>
    </div>

    <div id="toastWrap" style="position:fixed; bottom:20px; right:20px; z-index:9999; display:grid; gap:10px;"></div>

    <script src="erp.js"></script>
    <script>
        const AUTH_KEY = "stark_erp_auth_v1";
        (function () { try { const a = JSON.parse(localStorage.getItem(AUTH_KEY) || "null"); if (!a || !a.user) window.location.href = "index.html"; } catch { window.location.href = "index.html"; } })();

        const KEY_VEND = "stark_erp_vendors_v1";
        let CURRENT_FILTER = "all"; // all, top, risk

        function load(key, fb) { try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fb)); } catch { return fb; } }
        function save(key, d) { localStorage.setItem(key, JSON.stringify(d)); }
        function money(n) { return Number(n || 0).toLocaleString(undefined, { style: "currency", currency: "USD" }); }

        function openVendorModal() { document.getElementById("vendorModal").classList.add("open"); }
        function closeVendorModal() { document.getElementById("vendorModal").classList.remove("open"); }

        function addVendor() {
            const name = document.getElementById("vName").value.trim();
            if (!name) return toast("Error", "Name required.");

            const v = {
                id: "V-" + Date.now(),
                name,
                cat: document.getElementById("vCat").value || "General",
                loc: document.getElementById("vLoc").value || "Unknown",
                contact: document.getElementById("vContact").value,
                email: document.getElementById("vEmail").value,
                terms: document.getElementById("vTerms").value,
                rating: 100, // Start perfect
                spend: 0,
                status: "Active"
            };

            const list = load(KEY_VEND, []);
            list.push(v);
            save(KEY_VEND, list);
            closeVendorModal();
            toast("Success", "Vendor onboarded.");
            render();
        }

        function setFilter(f) {
            CURRENT_FILTER = f;
            document.querySelectorAll(".clickable-kpi").forEach(x => x.classList.remove("active"));
            if (f === 'all') document.getElementById("kpiAll").classList.add("active");
            if (f === 'top') document.getElementById("kpiTop").classList.add("active");
            if (f === 'risk') document.getElementById("kpiRisk").classList.add("active");
            render();
        }

        function render() {
            // Recalc Metrics
            const pos = JSON.parse(localStorage.getItem("stark_erp_pos_v1") || "[]");
            let list = load(KEY_VEND, []);
            let changed = false;

            list.forEach(v => {
                const vPos = pos.filter(p => (p.vendor || "").toLowerCase() === (v.name || "").toLowerCase());
                const openPos = vPos.filter(p => p.status !== 'Completed' && p.status !== 'Cancelled');

                // Spend Calc
                const spend = vPos.reduce((acc, p) => acc + (p.total || 0), 0); // Need to sum lines? POs usually don't have total stored on root in my seed?
                // master.html seed didn't put total on PO. 
                // Let's ignore spend recalc for now or do rough count.

                let newRating = 100;

                if (openPos.length > 0) {
                    const today = new Date().toISOString().split('T')[0];
                    const late = openPos.some(p => p.eta < today);

                    if (late) {
                        newRating = 60; // At Risk (Passed End Date)
                    } else {
                        newRating = 98; // Top Rated (Delivered by End Date logic / On Track)
                    }
                }

                if (v.rating !== newRating) {
                    v.rating = newRating;
                    changed = true;
                }
            });

            if (changed) save(KEY_VEND, list);
            const search = document.getElementById("search").value.toLowerCase();

            // Calcs
            const top = list.filter(v => v.rating >= 90).length;
            const risk = list.filter(v => v.rating < 70).length;
            const spend = list.reduce((a, b) => a + (b.spend || 0), 0);

            document.getElementById("kVendors").textContent = list.length;
            document.getElementById("kTop").textContent = top;
            document.getElementById("kRisk").textContent = risk;
            document.getElementById("kSpend").textContent = money(spend);

            // Filter
            const shown = list.filter(v => {
                if (search && !v.name.toLowerCase().includes(search)) return false;
                if (CURRENT_FILTER === 'top' && v.rating < 90) return false;
                if (CURRENT_FILTER === 'risk' && v.rating >= 70) return false;
                return true;
            });

            const tbody = document.getElementById("vBody");
            tbody.innerHTML = "";

            // Update visual title
            const mapTitle = { 'all': "Vendor Directory", 'top': "Top Performing Vendors", 'risk': "At-Risk Vendors" };
            document.getElementById("dirTitle").textContent = mapTitle[CURRENT_FILTER];

            if (!shown.length) return tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:20px; color:var(--text-muted);">No vendors found.</td></tr>`;

            shown.forEach(v => {
                let badge = "badge-green";
                if (v.rating < 90) badge = "badge-yellow";
                if (v.rating < 70) badge = "badge-red";

                const tr = document.createElement("tr");
                tr.style.cursor = "pointer";
                tr.onclick = () => showDetail(v);
                tr.innerHTML = `
                <td>
                    <div style="font-weight:600; color:var(--text-main);">${v.name}</div>
                    <div style="font-size:12px; color:var(--text-muted);">${v.contact || ""}</div>
                </td>
                <td>${v.cat}</td>
                <td>
                    <div style="display:flex; align-items:center; gap:6px;">
                        <div style="width:30px; height:4px; background:#e2e8f0; border-radius:2px;"><div style="width:${v.rating}%; background:${v.rating >= 90 ? 'var(--success)' : (v.rating < 70 ? 'var(--danger)' : 'var(--warning)')}; height:100%; border-radius:2px;"></div></div>
                        <span style="font-size:11px; font-weight:600;">${v.rating}%</span>
                    </div>
                </td>
                <td><span class="badge ${v.rating < 70 ? 'badge-red' : 'badge-green'}">${v.rating < 70 ? 'Review' : 'Active'}</span></td>
            `;
                tbody.appendChild(tr);
            });
        }

        function showDetail(v) {
            document.getElementById("detailPlaceholder").style.display = "none";
            document.getElementById("detailContent").style.display = "block";

            document.getElementById("dName").textContent = v.name;
            document.getElementById("dCat").textContent = v.cat;
            document.getElementById("dLoc").textContent = v.loc;
            document.getElementById("dContact").textContent = v.contact || "‚Äî";
            document.getElementById("dEmail").textContent = v.email || "‚Äî";
            document.getElementById("dTerms").textContent = v.terms || "Standard";

            document.getElementById("dScoreBadge").textContent = v.rating + "%";
            document.getElementById("dScoreBar").style.width = v.rating + "%";

            let color = "var(--success)";
            if (v.rating < 90) color = "var(--warning)";
            if (v.rating < 70) color = "var(--danger)";
            document.getElementById("dScoreBar").style.background = color;
            document.getElementById("dScoreBadge").style.background = color.replace(")", ", 0.12)").replace("rgb", "rgba");
            document.getElementById("dScoreBadge").style.color = color;
        }

        function seedVendors() {
            const demo = [
                { id: "V-KS", name: "Kendra Scott Wholesale", cat: "Jewelry", loc: "Austin, TX", contact: "Kendra S", email: "orders@kendrascott.com", terms: "Net 30", rating: 100, spend: 12000, status: "Active" },
                { id: "V-GU", name: "Gucci Supply", cat: "Accessories", loc: "Florence, IT", contact: "Marco B", email: "supply@gucci.com", terms: "Net 60", rating: 100, spend: 45000, status: "Active" },
                { id: "V-GH", name: "Global Home", cat: "Home Goods", loc: "High Point, NC", contact: "Sarah L", email: "sales@globalhome.com", terms: "Net 45", rating: 100, spend: 8200, status: "Active" },
                { id: "V-PR", name: "Prada Group", cat: "Accessories", loc: "Milan, IT", contact: "Alessia R", email: "b2b@prada.com", terms: "Net 30", rating: 100, spend: 21000, status: "Active" },
                { id: "V-CU", name: "Cuisinart", cat: "Home Goods", loc: "Stamford, CT", contact: "Bill H", email: "orders@cuisinart.com", terms: "Net 30", rating: 100, spend: 5600, status: "Active" },
                { id: "V-BU", name: "Burberry Ltd", cat: "Apparel", loc: "London, UK", contact: "James T", email: "wholesale@burberry.com", terms: "Net 60", rating: 100, spend: 0, status: "Active" },
                { id: "V-YS", name: "Yves Saint Laurent", cat: "Accessories", loc: "Paris, FR", contact: "Pierre D", email: "orders@ysl.com", terms: "Net 45", rating: 100, spend: 0, status: "Active" },
                { id: "V-NF", name: "Nest Fragrances", cat: "Home Goods", loc: "New York, NY", contact: "Laura M", email: "sales@nest.com", terms: "Net 30", rating: 100, spend: 0, status: "Active" },
                { id: "V-LN", name: "Lux & Nyx", cat: "Accessories", loc: "St Louis, MO", contact: "Lisa H", email: "hello@luxnyx.com", terms: "Immediate", rating: 100, spend: 0, status: "Active" }
            ];
            save(KEY_VEND, demo);
            toast("Data Loaded", "Demo Vendors generated.");
            render();
        }

        // Init
        if (load(KEY_VEND, []).length === 0) seedVendors();
        render();
    </script>
</body>

</html>
